<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0,viewport-fit=cover" />
  <title>Practice Command Center</title>

  <!-- iPad / PWA feel -->
  <meta name="theme-color" content="#071427" />
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    /* ====== APP SHELL: NO PAGE SCROLL ====== */
    html, body { height: 100%; }
    body{
      margin:0;
      overflow: hidden;                 /* ‚úÖ NO SCROLLING THE PAGE */
      overscroll-behavior: none;
      -webkit-font-smoothing: antialiased;
      background:
        radial-gradient(1200px 700px at 20% 0%, rgba(59,130,246,.20), transparent 55%),
        radial-gradient(1100px 650px at 95% 5%, rgba(245,197,66,.16), transparent 60%),
        radial-gradient(900px 600px at 70% 95%, rgba(96,165,250,.12), transparent 60%),
        linear-gradient(180deg,#071427 0%, #050b16 100%);
      color: rgb(241,245,249);
    }
    :root{
      --card: rgba(10, 24, 48, .74);
      --stroke: rgba(160,190,255,.18);
      --muted: rgba(226,232,240,.82);
      --muted2: rgba(226,232,240,.64);
      --gold:#f5c542;

      --btn: rgba(2,10,26,.55);
      --btnHover: rgba(2,10,26,.75);
      --btnStroke: rgba(160,190,255,.22);

      --ok: rgba(34,197,94,.14);
      --okStroke: rgba(34,197,94,.30);

      --warn: rgba(245,158,11,.14);
      --warnStroke: rgba(245,158,11,.30);

      --bad: rgba(239,68,68,.14);
      --badStroke: rgba(239,68,68,.30);
    }

    /* ====== APP LAYOUT ====== */
    .appShell{
      height: 100dvh; /* iPad safe */
      display: flex;
      flex-direction: column;
      padding-top: env(safe-area-inset-top);
      padding-bottom: env(safe-area-inset-bottom);
    }
    .appTopBar{
      flex: 0 0 auto;
      padding: 14px 16px 10px 16px;
    }
    .appContent{
      flex: 1 1 auto;
      overflow: hidden; /* content panes manage their own scroll */
      padding: 0 16px;
      display: flex;
      justify-content: center;
    }
    .contentFrame{
      width: 100%;
      max-width: 1100px;
      height: 100%;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }
    .pane{
      flex: 1 1 auto;
      overflow: auto;                      /* ‚úÖ SCROLL INSIDE THE APP ONLY */
      padding: 12px 0 12px 0;
      -webkit-overflow-scrolling: touch;
      scrollbar-gutter: stable both-edges;
    }
    .appTabBar{
      flex: 0 0 auto;
      padding: 10px 16px calc(10px + env(safe-area-inset-bottom)) 16px;
      background: rgba(2,6,23,.86);
      border-top: 1px solid rgba(160,190,255,.18);
      backdrop-filter: blur(14px);
    }

    /* ====== COMPONENTS ====== */
    .card{
      background: var(--card);
      border: 1px solid var(--stroke);
      box-shadow: 0 14px 34px rgba(0,0,0,.42);
      backdrop-filter: blur(12px);
      border-radius: 22px;
    }
    .chip{
      border: 1px solid rgba(160,190,255,.22);
      background: rgba(3,10,24,.48);
      border-radius: 18px;
    }
    .muted{ color: var(--muted); }
    .muted2{ color: var(--muted2); }
    .accent-gold{ color: var(--gold); }
    .divider{ border-color: rgba(160,190,255,.18); }

    .btn{
      border: 1px solid var(--btnStroke);
      background: var(--btn);
      transition: transform .06s ease, background .12s ease, box-shadow .12s ease;
      touch-action: manipulation;
      border-radius: 18px;
      padding: 14px 16px;
      font-size: 16px;
      font-weight: 900;
      letter-spacing: .2px;
      min-height: 56px;
    }
    .btn:hover{ background: var(--btnHover); box-shadow: 0 0 0 2px rgba(96,165,250,.18); }
    .btn:active{ transform: scale(.98); }

    .bigTileBtn{
      border: 1px solid rgba(96,165,250,.22);
      background: rgba(2,10,26,.50);
      border-radius: 22px;
      padding: 18px;
      min-height: 102px;
      text-align: left;
      transition: transform .06s ease, box-shadow .12s ease, background .12s ease;
      touch-action: manipulation;
      font-weight: 900;
    }
    .bigTileBtn:hover{ background: rgba(2,10,26,.70); box-shadow: 0 0 0 2px rgba(245,197,66,.14); }
    .bigTileBtn:active{ transform: scale(.985); }

    .badge{
      border:1px solid rgba(245,197,66,.32);
      background: rgba(245,197,66,.12);
      color: var(--gold);
      border-radius: 9999px;
      padding: 6px 10px;
      font-size: 12px;
      font-weight: 900;
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }
    .okbadge{
      border:1px solid var(--okStroke);
      background: var(--ok);
      color: rgba(134,239,172,.95);
      border-radius: 9999px;
      padding: 6px 10px;
      font-size: 12px;
      font-weight: 900;
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }
    .danger{
      border:1px solid var(--badStroke);
      background: var(--bad);
      color: rgb(252,165,165);
      border-radius: 9999px;
      padding: 6px 10px;
      font-size: 12px;
      font-weight: 900;
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }

    .inp{
      background: rgba(0,0,0,.22);
      border:1px solid rgba(160,190,255,.22);
      outline:none;
      border-radius: 16px;
      padding: 14px 14px;
      font-size: 16px;
      min-height: 54px;
      width: 100%;
    }
    .inp:focus{
      box-shadow:0 0 0 2px rgba(245,197,66,.18);
      border-color: rgba(245,197,66,.40);
    }

    /* ====== COLLAPSIBLE SECTIONS (reduce vertical space) ====== */
    details.fold{
      border: 1px solid rgba(160,190,255,.18);
      background: rgba(3,10,24,.32);
      border-radius: 18px;
      overflow: hidden;
    }
    details.fold > summary{
      list-style: none;
      cursor: pointer;
      padding: 14px 16px;
      font-weight: 950;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
      user-select: none;
    }
    details.fold > summary::-webkit-details-marker { display:none; }
    .caret{ transition: transform .12s ease; }
    details.fold[open] .caret{ transform: rotate(90deg); }
    .foldBody{ padding: 12px 16px 16px 16px; border-top: 1px solid rgba(160,190,255,.14); }

    /* ====== TAB BUTTONS BIG ====== */
    .tabbtn{
      width: 100%;
      border-radius: 22px;
      padding: 14px 12px;
      display:flex;
      flex-direction: column;
      align-items: center;
      gap: 6px;
      font-weight: 950;
      font-size: 13px;
      border: 1px solid rgba(160,190,255,.18);
      background: rgba(10,24,48,.55);
      min-height: 74px;
      touch-action: manipulation;
    }
    .tabbtn .ico{ font-size: 22px; line-height: 22px; }
    .tabbtn.active{
      border-color: rgba(245,197,66,.45);
      box-shadow: 0 0 0 2px rgba(245,197,66,.14);
      background: rgba(10,24,48,.78);
      color: var(--gold);
    }

    /* ====== MODALS: prevent background scroll ====== */
    .modalBackdrop{
      position: fixed; inset: 0;
      background: rgba(0,0,0,.70);
      display:flex; align-items:center; justify-content:center;
      padding: 16px;
      z-index: 50;
    }
    .modalCard{
      width: 100%;
      max-width: 920px;
      max-height: calc(100dvh - 120px);
      overflow: hidden;
      border-radius: 26px;
    }
    .modalScroll{
      overflow: auto;
      -webkit-overflow-scrolling: touch;
      max-height: calc(100dvh - 220px);
    }
  </style>
</head>

<body>
  <div class="appShell">
    <!-- TOP BAR (fixed) -->
    <div class="appTopBar">
      <div class="max-w-[1100px] mx-auto flex items-start justify-between gap-4">
        <div class="flex items-center gap-3">
          <div class="text-3xl">üèÄ</div>
          <div>
            <div class="text-2xl sm:text-3xl font-black tracking-tight">
              Practice <span class="accent-gold">Command Center</span>
            </div>
            <div class="muted2 text-sm">Built like an iPad app ‚Ä¢ no page scrolling</div>
          </div>
        </div>
        <div class="text-right">
          <div class="muted2 text-xs">Mode</div>
          <div class="badge"><span class="w-2.5 h-2.5 rounded-full bg-emerald-400 inline-block"></span>Offline</div>
        </div>
      </div>
    </div>

    <!-- CONTENT (internal scroll only) -->
    <div class="appContent">
      <div class="contentFrame">
        <!-- HOME -->
        <section id="tab-home" class="pane space-y-4">
          <!-- Quick Tiles Row -->
          <div class="grid grid-cols-2 lg:grid-cols-5 gap-3">
            <div class="chip p-4">
              <div class="text-xs uppercase tracking-wider muted2">Present</div>
              <div class="text-3xl font-black mt-2" id="tilePresent">0</div>
              <div class="text-sm muted2 mt-1" id="tileBand">Band: ‚Äî</div>
            </div>
            <div class="chip p-4">
              <div class="text-xs uppercase tracking-wider muted2">Biggest Need</div>
              <div class="text-xl font-black mt-2" id="tileNeed">‚Äî</div>
              <div class="text-sm muted2 mt-1">This week</div>
            </div>
            <div class="chip p-4">
              <div class="text-xs uppercase tracking-wider muted2">Improved</div>
              <div class="text-xl font-black mt-2" id="tileImproved">‚Äî</div>
              <div class="text-sm muted2 mt-1">Last 7 days</div>
            </div>
            <div class="chip p-4">
              <div class="text-xs uppercase tracking-wider muted2">Practices</div>
              <div class="text-3xl font-black mt-2" id="tilePractices">0</div>
              <div class="text-sm muted2 mt-1">This week</div>
            </div>
            <div class="chip p-4">
              <div class="text-xs uppercase tracking-wider muted2">Failures</div>
              <div class="text-3xl font-black mt-2" id="tileFails">0</div>
              <div class="text-sm muted2 mt-1">This week</div>
            </div>
          </div>

          <!-- Big action buttons -->
          <div class="grid grid-cols-2 lg:grid-cols-4 gap-3">
            <button class="bigTileBtn" onclick="showTab('practice')">
              <div class="text-2xl">üß†</div>
              <div class="text-lg font-black mt-2">Build Practice</div>
              <div class="text-sm muted2 mt-1">Generate by attendance</div>
            </button>
            <button class="bigTileBtn" onclick="showTab('roster')">
              <div class="text-2xl">üë•</div>
              <div class="text-lg font-black mt-2">Roster</div>
              <div class="text-sm muted2 mt-1">Height/weight + present</div>
            </button>
            <button class="bigTileBtn" onclick="showTab('progress')">
              <div class="text-2xl">üìà</div>
              <div class="text-lg font-black mt-2">Progress</div>
              <div class="text-sm muted2 mt-1">Needs + grades</div>
            </button>
            <button class="bigTileBtn" onclick="openAskCoachModal()">
              <div class="text-2xl">üéØ</div>
              <div class="text-lg font-black mt-2">Ask Coach</div>
              <div class="text-sm muted2 mt-1">Fast cues</div>
            </button>
          </div>

          <!-- Collapsible panels to avoid vertical bloat -->
          <details class="fold" open>
            <summary>
              <span>Today Snapshot</span>
              <span class="caret">‚Ä∫</span>
            </summary>
            <div class="foldBody">
              <div class="card p-5">
                <div class="flex items-start justify-between gap-3">
                  <div>
                    <div class="text-xs uppercase tracking-wider muted2">Today‚Äôs Focus</div>
                    <div class="text-2xl font-black mt-2"><span id="todayFocus" class="accent-gold">‚Äî</span></div>
                    <div class="muted mt-2 text-base">
                      Duration: <span class="font-bold" id="todayDuration">90</span> min ‚Ä¢
                      Drills: <span class="font-bold" id="todayDrillCount">0</span>
                    </div>
                  </div>
                  <div class="flex gap-2">
                    <button class="btn" onclick="showTab('practice')">Open</button>
                    <button class="btn" onclick="showTab('roster')">Set Present</button>
                  </div>
                </div>
              </div>
            </div>
          </details>

          <details class="fold">
            <summary>
              <span>Weekly Priority</span>
              <span class="caret">‚Ä∫</span>
            </summary>
            <div class="foldBody">
              <div class="card p-5">
                <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4">
                  <div>
                    <div class="text-xs uppercase tracking-wider muted2">Weekly Priority</div>
                    <div class="text-2xl font-black mt-1" id="weeklyPriority">Rebounding & Help Defense</div>
                    <div class="muted mt-2 text-base">
                      Record: <span class="font-bold" id="weeklyRecord">0‚Äì0</span> ‚Ä¢
                      Last issue: <span class="font-bold" id="weeklyIssue">Second-chance points</span>
                    </div>
                  </div>
                  <div class="flex gap-2">
                    <button class="btn" onclick="openWeeklySettings()">Edit</button>
                    <button class="btn" onclick="resetWeek()">Reset</button>
                  </div>
                </div>
              </div>
            </div>
          </details>

          <details class="fold">
            <summary>
              <span>Notes</span>
              <span class="caret">‚Ä∫</span>
            </summary>
            <div class="foldBody">
              <div class="card p-5">
                <textarea id="homeNotes" class="inp" rows="4"
                  placeholder="Example: Sprint between drills. No talking during teaching. Feet in paint help side."></textarea>
                <button class="btn mt-3 w-full" onclick="saveHomeNotes()">Save Notes</button>
              </div>
            </div>
          </details>

          <details class="fold">
            <summary>
              <span>Last Practice Recap</span>
              <span class="caret">‚Ä∫</span>
            </summary>
            <div class="foldBody">
              <div class="card p-5">
                <div class="flex items-start justify-between gap-3">
                  <div>
                    <div class="text-xs uppercase tracking-wider muted2">Last Practice Recap</div>
                    <div class="text-2xl font-black mt-2" id="recapTitle">No practice logged yet</div>
                    <div class="text-base muted2 mt-2" id="recapMeta">Build a practice, grade drills, log failures.</div>
                  </div>
                  <div class="flex gap-2">
                    <button class="btn" onclick="showTab('practice')">Open</button>
                    <button class="btn" onclick="clearRecap()">Clear</button>
                  </div>
                </div>

                <div class="border-t divider my-4"></div>

                <div class="grid grid-cols-1 md:grid-cols-4 gap-3">
                  <div class="chip p-4">
                    <div class="text-xs uppercase tracking-wider muted2">Most Failed</div>
                    <div class="text-lg font-black mt-2" id="recapWorstArea">‚Äî</div>
                  </div>
                  <div class="chip p-4">
                    <div class="text-xs uppercase tracking-wider muted2">Top Drill</div>
                    <div class="text-lg font-black mt-2" id="recapTopDrill">‚Äî</div>
                  </div>
                  <div class="chip p-4">
                    <div class="text-xs uppercase tracking-wider muted2">Worst Drill</div>
                    <div class="text-lg font-black mt-2" id="recapWorstDrill">‚Äî</div>
                  </div>
                  <div class="chip p-4">
                    <div class="text-xs uppercase tracking-wider muted2">Flagged</div>
                    <div class="text-lg font-black mt-2" id="recapFlagged">0</div>
                  </div>
                </div>
              </div>
            </div>
          </details>
        </section>

        <!-- ROSTER -->
        <section id="tab-roster" class="pane hidden space-y-4">
          <div class="card p-5">
            <div class="flex items-start justify-between gap-3">
              <div>
                <div class="text-xs uppercase tracking-wider muted2">Roster</div>
                <div class="text-2xl font-black mt-2">Players</div>
                <div class="text-base muted2 mt-2">Height/weight + one-tap Present.</div>
              </div>
              <div class="flex gap-2">
                <button class="btn" onclick="openAddPlayer()">+ Add</button>
                <button class="btn" onclick="clearRoster()">Clear</button>
              </div>
            </div>
            <div class="border-t divider my-4"></div>
            <div id="rosterList" class="space-y-3"></div>
          </div>
        </section>

        <!-- PRACTICE -->
        <section id="tab-practice" class="pane hidden space-y-4">
          <div class="card p-5">
            <div class="flex items-start justify-between gap-3">
              <div>
                <div class="text-xs uppercase tracking-wider muted2">Practice Builder</div>
                <div class="text-2xl font-black mt-2">Build Today‚Äôs Plan</div>
                <div class="text-base muted2 mt-2">
                  Rules: <span class="font-black">NO 5v5 drills unless 10+ present</span>.
                </div>
              </div>
              <div class="flex gap-2">
                <button class="btn" onclick="buildPractice()">Build</button>
                <button class="btn" onclick="regeneratePractice()">Regenerate</button>
              </div>
            </div>

            <div class="border-t divider my-4"></div>

            <div class="grid grid-cols-1 lg:grid-cols-4 gap-3">
              <div class="chip p-4 lg:col-span-2">
                <div class="text-xs uppercase tracking-wider muted2">Present (Tap to toggle)</div>
                <div id="presentPills" class="mt-3 flex flex-wrap gap-2"></div>
                <div class="text-base muted2 mt-3">
                  Band today: <span class="font-black" id="bandLabel">‚Äî</span>
                </div>
              </div>

              <div class="chip p-4">
                <div class="text-xs uppercase tracking-wider muted2">Duration</div>
                <input id="practiceDuration" type="number" min="30" max="150" class="inp mt-2" value="90"/>
              </div>

              <div class="chip p-4">
                <div class="text-xs uppercase tracking-wider muted2">Focus</div>
                <input id="practiceFocus" class="inp mt-2" placeholder="Ex: Help Defense + Rebounding" />
              </div>
            </div>

            <div class="mt-3 grid grid-cols-1 lg:grid-cols-2 gap-3">
              <div class="chip p-4">
                <div class="text-xs uppercase tracking-wider muted2">Emphasis</div>
                <div class="mt-2 flex flex-wrap gap-2 text-base">
                  <label class="chip px-4 py-3 rounded-full"><input type="checkbox" class="mr-2" id="em_def" checked>Defense</label>
                  <label class="chip px-4 py-3 rounded-full"><input type="checkbox" class="mr-2" id="em_reb" checked>Rebounding</label>
                  <label class="chip px-4 py-3 rounded-full"><input type="checkbox" class="mr-2" id="em_off">Offense</label>
                  <label class="chip px-4 py-3 rounded-full"><input type="checkbox" class="mr-2" id="em_press">Press</label>
                  <label class="chip px-4 py-3 rounded-full"><input type="checkbox" class="mr-2" id="em_cond" checked>Conditioning</label>
                  <label class="chip px-4 py-3 rounded-full"><input type="checkbox" class="mr-2" id="em_shoot">Shooting</label>
                </div>
              </div>

              <div class="chip p-4">
                <div class="text-xs uppercase tracking-wider muted2">Notes</div>
                <input id="practiceNotes" class="inp mt-2" placeholder="Ex: No fly-bys. Help-side feet in paint." />
              </div>
            </div>
          </div>

          <div class="card p-5">
            <div class="flex items-start justify-between gap-3">
              <div>
                <div class="text-xs uppercase tracking-wider muted2">Today‚Äôs Plan</div>
                <div class="text-base muted2 mt-2" id="planMeta">Build a practice to see it here.</div>
              </div>
              <button class="btn" onclick="logPracticeComplete()">Log Practice</button>
            </div>
            <div class="border-t divider my-4"></div>
            <div id="practicePlan" class="space-y-3"></div>
          </div>
        </section>

        <!-- PROGRESS -->
        <section id="tab-progress" class="pane hidden space-y-4">
          <div class="card p-5">
            <div class="flex items-start justify-between gap-3">
              <div>
                <div class="text-xs uppercase tracking-wider muted2">Progress</div>
                <div class="text-2xl font-black mt-2">Needs + Grades</div>
                <div class="text-base muted2 mt-2">Grade each player per drill (1‚Äì5).</div>
              </div>
              <div class="flex gap-2">
                <button class="btn" onclick="exportData()">Export</button>
                <button class="btn" onclick="clearProgress()">Clear</button>
              </div>
            </div>
            <div class="border-t divider my-4"></div>
            <div id="progressBoard" class="space-y-3"></div>
          </div>
        </section>
      </div>
    </div>

    <!-- TAB BAR (fixed) -->
    <div class="appTabBar">
      <div class="max-w-[1100px] mx-auto">
        <div class="grid grid-cols-4 gap-3">
          <button id="tabBtn-home" class="tabbtn active" onclick="showTab('home')">
            <div class="ico">üè†</div><div>Home</div>
          </button>
          <button id="tabBtn-roster" class="tabbtn" onclick="showTab('roster')">
            <div class="ico">üë•</div><div>Roster</div>
          </button>
          <button id="tabBtn-practice" class="tabbtn" onclick="showTab('practice')">
            <div class="ico">üß†</div><div>Practice</div>
          </button>
          <button id="tabBtn-progress" class="tabbtn" onclick="showTab('progress')">
            <div class="ico">üìà</div><div>Progress</div>
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Drill Detail Modal -->
  <div id="drillModal" class="hidden modalBackdrop">
    <div class="card modalCard p-5">
      <div class="flex items-start justify-between gap-3">
        <div>
          <div class="text-xs uppercase tracking-wider muted2">Drill</div>
          <div id="dmTitle" class="text-2xl font-black mt-2">‚Äî</div>
          <div id="dmTags" class="text-base muted2 mt-2">‚Äî</div>
        </div>
        <button class="btn" onclick="closeDrillModal()">Close</button>
      </div>
      <div class="border-t divider my-4"></div>
      <div class="modalScroll pr-1">
        <div class="text-base font-black">Explanation</div>
        <div id="dmExplain" class="mt-2 text-base muted leading-relaxed"></div>

        <div class="mt-4 text-base font-black">Standards</div>
        <ul id="dmStandards" class="mt-2 text-base muted list-disc pl-5 space-y-1"></ul>

        <div class="mt-4 text-base font-black">Coach Short</div>
        <div id="dmCoachShort" class="mt-2 text-base muted whitespace-pre-line"></div>

        <div class="mt-4 text-base font-black">Expand</div>
        <div id="dmCoachLong" class="mt-2 text-base muted whitespace-pre-line"></div>
      </div>
    </div>
  </div>

  <!-- Failure Log Modal -->
  <div id="failModal" class="hidden modalBackdrop">
    <div class="card modalCard p-5">
      <div class="flex items-start justify-between gap-3">
        <div>
          <div class="text-xs uppercase tracking-wider muted2">Log Failures</div>
          <div id="fmTitle" class="text-2xl font-black mt-2">‚Äî</div>
          <div class="text-base muted2 mt-2">Tap players who missed standards.</div>
        </div>
        <button class="btn" onclick="closeFailModal()">Close</button>
      </div>
      <div class="border-t divider my-4"></div>
      <div class="modalScroll pr-1">
        <div id="fmPlayers" class="flex flex-wrap gap-2"></div>
        <div class="mt-4 flex gap-2">
          <button class="btn" onclick="saveFailureLog()">Save</button>
          <button class="btn" onclick="clearFailureSelection()">Clear</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Grade Drill Modal -->
  <div id="gradeModal" class="hidden modalBackdrop">
    <div class="card modalCard p-5">
      <div class="flex items-start justify-between gap-3">
        <div>
          <div class="text-xs uppercase tracking-wider muted2">Grade Drill (1‚Äì5)</div>
          <div id="gmTitle" class="text-2xl font-black mt-2">‚Äî</div>
          <div class="text-base muted2 mt-2">Tap a number. Saved instantly.</div>
        </div>
        <button class="btn" onclick="closeGradeModal()">Close</button>
      </div>
      <div class="border-t divider my-4"></div>
      <div id="gmBody" class="modalScroll pr-1 space-y-3"></div>
    </div>
  </div>

  <!-- Ask Coach Modal -->
  <div id="askCoachModal" class="hidden modalBackdrop">
    <div class="card modalCard p-5">
      <div class="flex items-start justify-between gap-3">
        <div>
          <div class="text-xs uppercase tracking-wider muted2">Ask Coach</div>
          <div class="text-2xl font-black mt-2">Quick explanation</div>
          <div class="text-base muted2 mt-2">Offline coach brain. Fast and blunt.</div>
        </div>
        <button class="btn" onclick="closeAskCoachModal()">Close</button>
      </div>

      <div class="border-t divider my-4"></div>

      <div class="modalScroll pr-1">
        <input id="coachQuestion" class="inp" placeholder="Ask: 'How do I explain help-side defense to a freshman?'" />
        <button class="btn mt-3 w-full" onclick="answerCoachOffline()">Get Answer</button>
        <div id="coachAnswer" class="mt-3 chip p-4 text-base leading-relaxed hidden whitespace-pre-line"></div>
      </div>
    </div>
  </div>

  <!-- Add/Edit Player Modal -->
  <div id="playerModal" class="hidden modalBackdrop">
    <div class="card modalCard p-5" style="max-width:720px">
      <div class="flex items-start justify-between gap-3">
        <div>
          <div class="text-xs uppercase tracking-wider muted2" id="pmMode">Add Player</div>
          <div class="text-2xl font-black mt-2" id="pmTitle">Player</div>
          <div class="text-base muted2 mt-2">Height/weight used for development roles.</div>
        </div>
        <button class="btn" onclick="closePlayerModal()">Close</button>
      </div>

      <div class="border-t divider my-4"></div>

      <div class="modalScroll pr-1">
        <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
          <div>
            <div class="text-xs uppercase tracking-wider muted2">Name</div>
            <input id="pmName" class="inp mt-2" placeholder="Quin Coykendal" />
          </div>
          <div>
            <div class="text-xs uppercase tracking-wider muted2">Number</div>
            <input id="pmNumber" class="inp mt-2" placeholder="23" />
          </div>
          <div>
            <div class="text-xs uppercase tracking-wider muted2">Position</div>
            <select id="pmPos" class="inp mt-2">
              <option value="G">G (Guard)</option>
              <option value="W">W (Wing)</option>
              <option value="F">F (Forward)</option>
              <option value="C">C (Post)</option>
            </select>
          </div>
          <div>
            <div class="text-xs uppercase tracking-wider muted2">Notes</div>
            <input id="pmNotes" class="inp mt-2" placeholder="Strong rebounder / needs ball pressure" />
          </div>
          <div>
            <div class="text-xs uppercase tracking-wider muted2">Height (in)</div>
            <input id="pmHeight" class="inp mt-2" placeholder="74" />
          </div>
          <div>
            <div class="text-xs uppercase tracking-wider muted2">Weight (lb)</div>
            <input id="pmWeight" class="inp mt-2" placeholder="165" />
          </div>
        </div>

        <div class="mt-4 flex gap-2">
          <button class="btn" onclick="savePlayer()">Save</button>
          <button id="pmDeleteBtn" class="btn danger hidden" onclick="deletePlayerFromModal()">Delete</button>
        </div>
      </div>
    </div>
  </div>

<script>
/* ====== DATA + LOGIC (same functionality, re-wired for app shell) ====== */

const KEY_WEEK = "pcc_week";
const KEY_HOME_NOTES = "pcc_home_notes";
const KEY_ROSTER = "pcc_roster";
const KEY_PRESENT = "pcc_present";
const KEY_TODAY = "pcc_today";
const KEY_DRILL_PREF = "pcc_drill_pref";
const KEY_WEEKLY_USED = "pcc_weekly_used";
const KEY_FAILURES = "pcc_failures";
const KEY_LAST_RECAP = "pcc_last_recap";
const KEY_GRADES = "pcc_grades";
const KEY_REGEN_SEED = "pcc_regen_seed";
const KEY_EMPHASIS = "pcc_emphasis";

function uid(){ return (crypto?.randomUUID?.() || `${Date.now()}-${Math.random().toString(16).slice(2)}`); }
function loadJSON(key, fallback){ try { return JSON.parse(localStorage.getItem(key)) ?? fallback; } catch { return fallback; } }
function saveJSON(key, val){ localStorage.setItem(key, JSON.stringify(val)); }
function escapeHtml(s){
  return String(s ?? "")
    .replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;")
    .replaceAll('"',"&quot;").replaceAll("'","&#039;");
}
function clampInt(n,min,max){ return Math.max(min, Math.min(max, n)); }
function normalizeCat(c){
  const x = (c||"").toLowerCase();
  if (x.includes("def")) return "Defense";
  if (x.includes("reb")) return "Rebounding";
  if (x.includes("press")) return "Press";
  if (x.includes("cond")) return "Conditioning";
  if (x.includes("shoot")) return "Shooting";
  if (x.includes("off")) return "Offense";
  if (x.includes("skill")) return "Skill";
  if (x.includes("team")) return "Team";
  return (c||"Other");
}
function topEntries(obj, n){ return Object.entries(obj).sort((a,b)=>b[1]-a[1]).slice(0,n); }

function getWeekId(d=new Date()){
  const date = new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate()));
  const dayNum = date.getUTCDay() || 7;
  date.setUTCDate(date.getUTCDate() + 4 - dayNum);
  const yearStart = new Date(Date.UTC(date.getUTCFullYear(),0,1));
  const weekNo = Math.ceil((((date - yearStart) / 86400000) + 1)/7);
  return `${date.getUTCFullYear()}-W${String(weekNo).padStart(2,"0")}`;
}
function ensureWeek(){
  const w = loadJSON(KEY_WEEK, null);
  if (w) return w;
  const init = { priority:"Rebounding & Help Defense", record:"0‚Äì0", issue:"Second-chance points", practices:0, fails:0 };
  saveJSON(KEY_WEEK, init);
  return init;
}

function getRoster(){ return loadJSON(KEY_ROSTER, []); }
function saveRoster(list){ saveJSON(KEY_ROSTER, list); }
function getPresentIds(){ return loadJSON(KEY_PRESENT, []); }
function savePresentIds(list){ saveJSON(KEY_PRESENT, list); }

function saveEmphasis(){
  const state = { def: em_def.checked, reb: em_reb.checked, off: em_off.checked, press: em_press.checked, cond: em_cond.checked, shoot: em_shoot.checked };
  saveJSON(KEY_EMPHASIS, state);
}
function loadEmphasis(){
  const s = loadJSON(KEY_EMPHASIS, null);
  if (!s) return;
  em_def.checked=!!s.def; em_reb.checked=!!s.reb; em_off.checked=!!s.off;
  em_press.checked=!!s.press; em_cond.checked=!!s.cond; em_shoot.checked=!!s.shoot;
}

function bumpRegenSeed(){
  const n = (parseInt(localStorage.getItem(KEY_REGEN_SEED)||"0",10) || 0) + 1;
  localStorage.setItem(KEY_REGEN_SEED, String(n));
  return n;
}
function getRegenSeed(){ return parseInt(localStorage.getItem(KEY_REGEN_SEED)||"0",10) || 0; }

function getBand(n){ if (n<=2) return "1‚Äì2"; if (n<=4) return "3‚Äì4"; if (n<=6) return "5‚Äì6"; if (n<=9) return "7‚Äì9"; return "10+"; }
function bandMinMax(band){ if (band==="1‚Äì2") return [1,2]; if (band==="3‚Äì4") return [3,4]; if (band==="5‚Äì6") return [5,6]; if (band==="7‚Äì9") return [7,9]; return [10,99]; }

function getPrefMap(){ return loadJSON(KEY_DRILL_PREF, {}); }
function setPref(id, val){ const m=getPrefMap(); m[id]=val; saveJSON(KEY_DRILL_PREF, m); }
function getWeeklyUsed(){
  const weekId = getWeekId();
  const all = loadJSON(KEY_WEEKLY_USED, {});
  if (!all[weekId]) all[weekId] = [];
  saveJSON(KEY_WEEKLY_USED, all);
  return { weekId, used: new Set(all[weekId]), all };
}
function markWeeklyUsed(ids){
  const { weekId, all } = getWeeklyUsed();
  const arr = Array.isArray(all[weekId]) ? all[weekId] : [];
  const set = new Set(arr);
  ids.forEach(id=>set.add(id));
  all[weekId] = Array.from(set);
  saveJSON(KEY_WEEKLY_USED, all);
}

function getFailures(){ return loadJSON(KEY_FAILURES, []); }
function saveFailures(list){ saveJSON(KEY_FAILURES, list); }
function getGrades(){ return loadJSON(KEY_GRADES, []); }
function saveGrades(list){ saveJSON(KEY_GRADES, list); }
function upsertGrade(practiceId, drillId, playerId, grade, note=""){
  const list = getGrades();
  const idx = list.findIndex(g => g.practiceId===practiceId && g.drillId===drillId && g.playerId===playerId);
  const entry = { id: idx>=0 ? list[idx].id : uid(), ts: Date.now(), weekId: getWeekId(), practiceId, drillId, playerId, grade: clampInt(Number(grade),1,5), note:(note||"").trim() };
  if (idx>=0) list[idx] = { ...list[idx], ...entry }; else list.push(entry);
  saveGrades(list);
}
function getDrillAvg(practiceId, drillId){
  const list = getGrades().filter(g => g.practiceId===practiceId && g.drillId===drillId);
  if (!list.length) return null;
  const avg = list.reduce((s,g)=>s+Number(g.grade||0),0) / list.length;
  return Math.round(avg*10)/10;
}

/* ====== DRILLS ====== */
function mkDrill(id,title,category,tags,minPlayers,maxPlayers,explain,standards,coachShort,coachLong){
  return { id,title,category,tags,minPlayers,maxPlayers,explain,standards,coachShort,coachLong };
}
const DRILLS = [
  mkDrill("d02","Partner Closeout ‚Üí Contain (1v1)","Defense",["Closeouts","On-ball"],2,2,"Defender sprints closeout, chops, contains drive without reaching.",
    ["Sprint 2/3, chop 1/3","No fly-by","Contain 3 slides","No reach fouls"],
    "WHY: Closeout wins possessions.\nDO: Sprint, chop, contain.\nCONSEQUENCE: Fly-by = layup.",
    "Cues: arrive under control, hands high, angle to sideline."
  ),
  mkDrill("d12","Rebound & Outlet War (3‚Äì4)","Rebounding",["Box Out","Outlet"],3,4,"Shot goes up, hit first, pursue, secure with 2 hands, outlet fast.",
    ["Contact first","Two hands","Chin it","Outlet within 2 seconds"],
    "WHY: End possessions.\nDO: Hit first.\nCONSEQUENCE: No box = 2nd chance.",
    "Score box-outs. Stop and correct ball-watching."
  ),
  mkDrill("d21","4v4 Shell (Ghost Player)","Defense",["Shell","Help"],5,6,"Shell principles with a ‚Äòghost‚Äô if short.",
    ["Feet in paint help side","Closeout under control","Bump cutters","Finish with rebound"],
    "WHY: Habits.\nDO: Help, recover, talk.\nCONSEQUENCE: Quiet teams get scored on.",
    "Demand talk: BALL/HELP/DENY."
  ),
  mkDrill("d27","4v4 + 1 Advantage (Rotate Extra)","Team",["Spacing","Reads"],7,9,"4v4 with 1 rotating advantage player. No 5v5 needed.",
    ["No standing","Talk matchups","Box out every shot"],
    "WHY: Game reads without 10.\nDO: Move + talk.\nCONSEQUENCE: Stand = dead rep.",
    "Rotate advantage player every possession."
  ),
  mkDrill("d30","5v5 Shell (Full)","Defense",["Shell","Team"],10,14,"Full shell: deny one away, help feet in paint, recover on skip, rebound.",
    ["Talk every pass","Deny one away","Feet in paint help","Box out hard"],
    "WHY: This is your defense.\nDO: Deny, help, recover.\nCONSEQUENCE: No talk = buckets.",
    "Add constraints: no middle drives, under all screens."
  ),
  mkDrill("d04","NFHS Burst Conditioning (1‚Äì2)","Conditioning",["Game Pace","NFHS"],1,2,"20s sprint / 40s walk. 10‚Äì14 rounds.",
    ["Full speed","Walk recovery","No hands on knees","Finish strong"],
    "WHY: You play how you‚Äôre conditioned.\nDO: Full bursts.\nCONSEQUENCE: Gas = bad decisions.",
    "Add ball or stop + pivot at end of burst."
  ),
  mkDrill("d05","Form Shooting Ladder","Shooting",["Mechanics","Consistency"],1,2,"Close-range ladder: 5 spots, 5 in a row to advance, miss resets.",
    ["Hold follow-through","No drifting","Track makes out loud"],
    "WHY: Mechanics hold under pressure.\nDO: Perfect reps.\nCONSEQUENCE: Lazy form = bricks.",
    "Progress to one-dribble pull-ups."
  ),
  mkDrill("d10","2v2 Closeout & Help (No Middle)","Defense",["Help","Recover"],3,4,"Closeout + help rules, no middle drives.",
    ["Help feet in paint","No middle","Talk every rep","Box out"],
    "WHY: Team defense.\nDO: Help early.\nCONSEQUENCE: Late help = layup.",
    "Teach: help the helper."
  ),
  mkDrill("d20","3v3 Continuous (Stop = Point)","Team",["Compete","Conditioning"],5,6,"3v3: stop+rebound = point, score = point. Winner stays.",
    ["Box out","Talk","No jogging","Make layups"],
    "WHY: Compete like game.\nDO: Earn stops.\nCONSEQUENCE: Soft = lose.",
    "Add rule: paint touch before 3."
  )
];

/* ====== TABS ====== */
function showTab(tab){
  ["home","roster","practice","progress"].forEach(t=>{
    document.getElementById(`tab-${t}`).classList.toggle("hidden", t!==tab);
    const btn = document.getElementById(`tabBtn-${t}`);
    if (btn) btn.classList.toggle("active", t===tab);
  });
  if (tab==="roster") renderRoster();
  if (tab==="practice") renderPracticeControls();
  if (tab==="progress") renderProgress();
  if (tab==="home") renderHome();
}

/* ====== HOME ====== */
function openWeeklySettings(){
  const w = ensureWeek();
  const priority = prompt("Weekly Priority (1‚Äì2 focuses):", w.priority || "Rebounding & Help Defense");
  if (priority===null) return;
  const record = prompt("Record (ex: 2‚Äì1):", w.record || "0‚Äì0");
  if (record===null) return;
  const issue = prompt("Last Issue (ex: second-chance points):", w.issue || "Second-chance points");
  if (issue===null) return;
  saveJSON(KEY_WEEK, { ...w, priority, record, issue });
  renderHome();
}
function resetWeek(){
  if (!confirm("Reset week counters (practices/fails) to 0?")) return;
  const w = ensureWeek();
  saveJSON(KEY_WEEK, { ...w, practices:0, fails:0 });
  const weekId = getWeekId();
  const all = loadJSON(KEY_WEEKLY_USED, {});
  all[weekId] = [];
  saveJSON(KEY_WEEKLY_USED, all);
  renderHome();
}
function saveHomeNotes(){ localStorage.setItem(KEY_HOME_NOTES, homeNotes.value || ""); alert("Saved."); }

function computeBiggestNeedThisWeek(){
  const weekId = getWeekId();
  const thisWeek = getFailures().filter(f => f.weekId===weekId);
  if (!thisWeek.length) return "‚Äî";
  const score = {};
  for (const f of thisWeek){
    const drill = DRILLS.find(d=>d.id===f.drillId);
    const cat = normalizeCat(drill?.category || f.category || "Other");
    score[cat] = (score[cat]||0) + (f.players?.length || 0) + 1;
  }
  const top = Object.entries(score).sort((a,b)=>b[1]-a[1])[0];
  return top ? top[0] : "‚Äî";
}
function computeMostImproved(){
  const roster = getRoster();
  if (!roster.length) return "‚Äî";
  const allFails = getFailures();
  const curWeek = getWeekId();
  const prevWeek = getWeekId(new Date(Date.now() - 7*86400000));
  const cur = {}, prev = {};
  for (const f of allFails){
    const bucket = (f.weekId===curWeek) ? cur : (f.weekId===prevWeek) ? prev : null;
    if (!bucket) continue;
    for (const pid of (f.players||[])) bucket[pid] = (bucket[pid]||0)+1;
  }
  let best = { name:"‚Äî", delta:-Infinity };
  for (const p of roster){
    const d = (prev[p.id]||0) - (cur[p.id]||0);
    if (d > best.delta) best = { name: p.name, delta: d };
  }
  return best.name || "‚Äî";
}
function inferTodayFocus(){
  const today = loadJSON(KEY_TODAY, null);
  if (today && today.focus) return today.focus;
  const need = computeBiggestNeedThisWeek();
  if (need==="Defense") return "Help Defense + Closeouts";
  if (need==="Rebounding") return "Box Outs + Rebounding";
  if (need==="Press") return "Press Rotations + Contain";
  if (need==="Conditioning") return "Game Pace Conditioning";
  if (need==="Offense") return "Motion Timing + Finishing";
  return "Help Defense + Rebounding";
}
function renderRecap(){
  const r = loadJSON(KEY_LAST_RECAP, null);
  if (!r){
    recapTitle.textContent="No practice logged yet";
    recapMeta.textContent="Build a practice, grade drills, log failures.";
    recapWorstArea.textContent="‚Äî"; recapTopDrill.textContent="‚Äî"; recapWorstDrill.textContent="‚Äî"; recapFlagged.textContent="0";
    return;
  }
  recapTitle.textContent=r.title||"Last Practice";
  recapMeta.textContent=r.meta||"";
  recapWorstArea.textContent=r.worstArea||"‚Äî";
  recapTopDrill.textContent=r.topDrill||"‚Äî";
  recapWorstDrill.textContent=r.worstDrill||"‚Äî";
  recapFlagged.textContent=String(r.flaggedCount ?? 0);
}
function clearRecap(){ if (!confirm("Clear recap?")) return; localStorage.removeItem(KEY_LAST_RECAP); renderHome(); }

function renderHome(){
  const w = ensureWeek();
  weeklyPriority.textContent = w.priority;
  weeklyRecord.textContent = w.record;
  weeklyIssue.textContent = w.issue;

  homeNotes.value = localStorage.getItem(KEY_HOME_NOTES) || "";

  const presentCount = getPresentIds().length;
  tilePresent.textContent = String(presentCount);
  tileBand.textContent = `Band: ${getBand(presentCount)}`;

  tileNeed.textContent = computeBiggestNeedThisWeek();
  tileImproved.textContent = computeMostImproved();

  tilePractices.textContent = String(w.practices || 0);
  tileFails.textContent = String(w.fails || 0);

  const todayObj = loadJSON(KEY_TODAY, null);
  const focus = inferTodayFocus();
  todayFocus.textContent = focus;
  todayDuration.textContent = String(todayObj?.duration ?? 90);
  todayDrillCount.textContent = String((todayObj?.drills||[]).length);

  renderRecap();
}

/* ====== ROSTER ====== */
function togglePresent(pid){
  const set = new Set(getPresentIds());
  set.has(pid) ? set.delete(pid) : set.add(pid);
  savePresentIds(Array.from(set));
  renderRoster(); renderPracticeControls(); renderHome();
}
function renderRoster(){
  const roster = getRoster();
  const present = new Set(getPresentIds());
  rosterList.innerHTML = "";

  if (!roster.length){
    rosterList.innerHTML = `<div class="chip p-4"><div class="text-base muted2">No players yet. Add them with ‚Äú+ Add‚Äù.</div></div>`;
    return;
  }

  roster.forEach(p=>{
    const isHere = present.has(p.id);
    const row = document.createElement("div");
    row.className = "chip p-4 flex items-start justify-between gap-3";
    row.innerHTML = `
      <div class="min-w-0">
        <div class="font-black text-xl">
          ${escapeHtml(p.name)} <span class="muted2 text-sm">#${escapeHtml(p.number||"--")}</span>
        </div>
        <div class="muted2 text-base mt-1">
          Pos: <span class="font-black">${escapeHtml(p.pos||"‚Äî")}</span>
          ‚Ä¢ H/W: <span class="font-black">${escapeHtml(p.height||"‚Äî")}</span> / <span class="font-black">${escapeHtml(p.weight||"‚Äî")}</span>
        </div>
        <div class="muted2 text-base mt-1">${escapeHtml(p.notes||"")}</div>
      </div>
      <div class="flex flex-col gap-2 items-end">
        <button class="btn" data-act="present">${isHere ? "Present ‚úÖ" : "Mark Present"}</button>
        <button class="btn" data-act="edit">Edit</button>
      </div>
    `;
    row.querySelector('[data-act="present"]').onclick = ()=>togglePresent(p.id);
    row.querySelector('[data-act="edit"]').onclick = ()=>openEditPlayer(p.id);
    rosterList.appendChild(row);
  });
}
function clearRoster(){
  if (!confirm("Clear roster AND present list?")) return;
  localStorage.removeItem(KEY_ROSTER);
  localStorage.removeItem(KEY_PRESENT);
  renderRoster(); renderPracticeControls(); renderHome();
}

let playerModalId = null;
function openAddPlayer(){
  playerModalId=null;
  pmMode.textContent="Add Player"; pmTitle.textContent="Player";
  pmName.value=""; pmNumber.value=""; pmPos.value="G"; pmNotes.value=""; pmHeight.value=""; pmWeight.value="";
  pmDeleteBtn.classList.add("hidden");
  playerModal.classList.remove("hidden");
}
function openEditPlayer(pid){
  const p = getRoster().find(x=>x.id===pid);
  if (!p) return;
  playerModalId=pid;
  pmMode.textContent="Edit Player"; pmTitle.textContent=p.name;
  pmName.value=p.name||""; pmNumber.value=p.number||""; pmPos.value=p.pos||"G"; pmNotes.value=p.notes||"";
  pmHeight.value=p.height??""; pmWeight.value=p.weight??"";
  pmDeleteBtn.classList.remove("hidden");
  playerModal.classList.remove("hidden");
}
function closePlayerModal(){ playerModal.classList.add("hidden"); }
function savePlayer(){
  const name=(pmName.value||"").trim();
  if (!name){ alert("Name required."); return; }
  const number=(pmNumber.value||"").trim();
  const pos=pmPos.value;
  const notes=(pmNotes.value||"").trim();
  const height=(pmHeight.value||"").trim();
  const weight=(pmWeight.value||"").trim();

  const roster=getRoster();
  if (playerModalId){
    const idx=roster.findIndex(p=>p.id===playerModalId);
    if (idx>=0) roster[idx]={...roster[idx], name, number, pos, notes, height, weight};
  } else {
    roster.push({ id: uid(), name, number, pos, notes, height, weight });
  }
  saveRoster(roster);
  closePlayerModal();
  renderRoster(); renderPracticeControls(); renderHome();
}
function deletePlayerFromModal(){
  if (!playerModalId) return;
  if (!confirm("Delete this player?")) return;
  saveRoster(getRoster().filter(p=>p.id!==playerModalId));
  const present=new Set(getPresentIds()); present.delete(playerModalId); savePresentIds(Array.from(present));
  playerModalId=null;
  closePlayerModal();
  renderRoster(); renderPracticeControls(); renderHome();
}

/* ====== PRACTICE ====== */
function getEmphasis(){
  const cats=[];
  if (em_def.checked) cats.push("Defense");
  if (em_reb.checked) cats.push("Rebounding");
  if (em_off.checked) cats.push("Offense");
  if (em_press.checked) cats.push("Press");
  if (em_cond.checked) cats.push("Conditioning");
  if (em_shoot.checked) cats.push("Shooting");
  return cats;
}
function renderPracticeControls(){
  const today = loadJSON(KEY_TODAY, { duration:90, focus:"", drills:[], notes:"", presentIds: getPresentIds(), id: uid(), date:new Date().toISOString() });
  practiceDuration.value = today.duration ?? 90;
  practiceFocus.value = today.focus ?? "";
  practiceNotes.value = today.notes ?? "";

  const roster = getRoster();
  const present = new Set(getPresentIds());
  presentPills.innerHTML = "";

  if (!roster.length){
    presentPills.innerHTML = `<div class="text-base muted2">Add players in Roster first.</div>`;
  } else {
    roster.forEach(p=>{
      const isHere = present.has(p.id);
      const b = document.createElement("button");
      b.className = isHere ? "okbadge" : "badge";
      b.style.padding = "10px 14px";
      b.style.fontSize = "14px";
      b.style.fontWeight = "900";
      b.textContent = isHere ? `${p.name} ‚úÖ` : p.name;
      b.onclick = ()=>togglePresent(p.id);
      presentPills.appendChild(b);
    });
  }

  const n = present.size;
  bandLabel.textContent = getBand(n);

  renderPracticePlan(today.drills || []);
  updatePlanMeta();
}
function updatePlanMeta(){
  const today = loadJSON(KEY_TODAY, { duration:90, drills:[], focus:"" });
  const presentCount = getPresentIds().length;
  const band = getBand(presentCount);
  const focus = today.focus?.trim() ? today.focus.trim() : inferTodayFocus();
  planMeta.textContent = `Present: ${presentCount} (Band ${band}) ‚Ä¢ Duration: ${today.duration ?? 90} ‚Ä¢ Focus: ${focus}`;
}
function toTimedPlan(drills, duration){
  const blocks=[];
  const n=drills.length;
  const warm = duration<=60 ? 8 : 10;
  const cond = duration<=60 ? 6 : 10;
  const ft = 6;
  const remaining = Math.max(duration - warm - cond - ft, 20);
  const coreSlots = Math.max(n - 2, 2);
  const coreEach  = Math.floor(remaining / coreSlots);
  const extra     = remaining - (coreEach * coreSlots);
  let coreIndex=0;

  for (let i=0;i<n;i++){
    let mins;
    if (i===0) mins=warm;
    else if (i===n-2) mins=cond;
    else if (i===n-1) mins=ft;
    else { mins = coreEach + (coreIndex < extra ? 1 : 0); coreIndex++; }
    const d=drills[i];
    blocks.push({ id:d.id,title:d.title,category:normalizeCat(d.category),tags:d.tags,mins,
      explain:d.explain,standards:d.standards,coachShort:d.coachShort,coachLong:d.coachLong,
      minPlayers:d.minPlayers,maxPlayers:d.maxPlayers
    });
  }
  const total = blocks.reduce((s,b)=>s+b.mins,0);
  const diff = duration - total;
  if (diff && blocks.length) blocks[blocks.length-1].mins += diff;
  return blocks;
}
function buildPractice(){
  const duration = clampInt(parseInt(practiceDuration.value || "90",10), 30, 150);
  const focusInput = (practiceFocus.value || "").trim();
  const notes = (practiceNotes.value || "").trim();

  const presentCount = getPresentIds().length;
  const band = getBand(presentCount);
  const [minP,maxP] = bandMinMax(band);

  const emphasis = getEmphasis();
  const focus = focusInput || inferTodayFocus();

  const pref = getPrefMap();
  const { used } = getWeeklyUsed();
  const regenSeed = getRegenSeed();

  // ‚úÖ HARD RULE: 5v5 (10+) drills never appear if present < 10 (by maxPlayers/minPlayers filter)
  const pool = DRILLS
    .filter(d => d.minPlayers <= maxP && d.maxPlayers >= minP)
    .filter(d => {
      if (!emphasis.length) return true;
      const cat = normalizeCat(d.category);
      return emphasis.includes(cat) || (emphasis.includes("Defense") && cat==="Team") || (emphasis.includes("Offense") && cat==="Skill");
    });

  // If no drills match (rare), fall back to band-only filtering
  const safePool = pool.length ? pool : DRILLS.filter(d => d.minPlayers <= maxP && d.maxPlayers >= minP);

  const desiredCount = duration <= 60 ? 5 : duration <= 90 ? 6 : 7;

  const scored = safePool.map(d=>{
    const like = pref[d.id] ?? 0;
    const usedPenalty = used.has(d.id) ? -2 : 0;
    const base = 1 + (like*0.8) + usedPenalty;
    const jitter = ((((Math.random() + regenSeed*0.137) % 1) * 0.6) - 0.3);
    return { d, score: base + jitter };
  }).sort((a,b)=>b.score-a.score);

  const selected=[], picked=new Set();
  for (const item of scored){
    if (selected.length >= desiredCount) break;
    if (picked.has(item.d.id)) continue;
    if (used.has(item.d.id) && selected.length < Math.floor(desiredCount*0.6)) continue;
    selected.push(item.d); picked.add(item.d.id);
  }
  if (selected.length < desiredCount){
    for (const item of scored){
      if (selected.length >= desiredCount) break;
      if (picked.has(item.d.id)) continue;
      selected.push(item.d); picked.add(item.d.id);
    }
  }

  const plan = toTimedPlan(selected, duration);

  const todayObj = {
    id: uid(),
    date: new Date().toISOString(),
    duration,
    focus,
    notes,
    presentIds: getPresentIds(),
    drills: plan.map(x=>({ ...x }))
  };
  saveJSON(KEY_TODAY, todayObj);
  markWeeklyUsed(plan.map(p=>p.id));

  renderPracticeControls();
  renderHome();
}
function regeneratePractice(){ bumpRegenSeed(); buildPractice(); }

function renderPracticePlan(plan){
  practicePlan.innerHTML = "";
  if (!plan || !plan.length){
    practicePlan.innerHTML = `<div class="chip p-4"><div class="text-base muted2">No plan yet. Hit ‚ÄúBuild‚Äù.</div></div>`;
    return;
  }

  const pref = getPrefMap();
  const today = loadJSON(KEY_TODAY, null);

  plan.forEach((d, idx)=>{
    const like = pref[d.id] ?? 0;
    const likeTxt = like===1 ? "Liked" : like===-1 ? "Disliked" : "Neutral";
    const likeBadge = like===1 ? "okbadge" : like===-1 ? "danger" : "badge";
    const bandTxt = `${d.minPlayers}‚Äì${d.maxPlayers} players`;
    const avg = today ? getDrillAvg(today.id, d.id) : null;

    const row = document.createElement("div");
    row.className = "chip p-4";
    row.innerHTML = `
      <div class="flex flex-col lg:flex-row lg:items-start lg:justify-between gap-4">
        <div class="min-w-0">
          <div class="flex flex-wrap items-center gap-2">
            <div class="font-black text-xl">${idx+1}. ${escapeHtml(d.title)}</div>
            <span class="badge">${escapeHtml(d.category)}</span>
            <span class="${likeBadge}">${likeTxt}</span>
            ${avg ? `<span class="okbadge">Avg ${avg}/5</span>` : ``}
            <span class="badge">${bandTxt}</span>
            <span class="badge">${d.mins} min</span>
          </div>
          <div class="text-base muted2 mt-2">${escapeHtml(d.explain)}</div>
        </div>

        <div class="grid grid-cols-2 sm:grid-cols-5 gap-2 min-w-[320px]">
          <button class="btn" data-act="explain">Explain</button>
          <button class="btn" data-act="grade">Grade</button>
          <button class="btn" data-act="fail">Failures</button>
          <button class="btn" data-act="like">üëç</button>
          <button class="btn" data-act="dislike">üëé</button>
        </div>
      </div>
    `;

    row.querySelector('[data-act="explain"]').onclick = ()=>openDrillModal(d.id);
    row.querySelector('[data-act="grade"]').onclick = ()=>openGradeModal(d.id);
    row.querySelector('[data-act="fail"]').onclick = ()=>openFailModal(d.id);
    row.querySelector('[data-act="like"]').onclick = ()=>{ setPref(d.id, (pref[d.id]===1) ? 0 : 1); renderPracticeControls(); renderHome(); renderProgress(); };
    row.querySelector('[data-act="dislike"]').onclick = ()=>{ setPref(d.id, (pref[d.id]===-1) ? 0 : -1); renderPracticeControls(); renderHome(); renderProgress(); };

    practicePlan.appendChild(row);
  });
}

/* ====== DRILL MODAL ====== */
function openDrillModal(drillId){
  const today = loadJSON(KEY_TODAY, null);
  const drill = (today?.drills||[]).find(d=>d.id===drillId) || DRILLS.find(d=>d.id===drillId);
  if (!drill) return;

  dmTitle.textContent = drill.title;
  dmTags.textContent = `${normalizeCat(drill.category)} ‚Ä¢ ${drill.minPlayers}‚Äì${drill.maxPlayers} players ‚Ä¢ ${(drill.tags||[]).join(", ")}`;
  dmExplain.textContent = drill.explain || "";
  dmCoachShort.textContent = drill.coachShort || "";
  dmCoachLong.textContent = drill.coachLong || "";

  dmStandards.innerHTML="";
  (drill.standards||[]).forEach(s=>{ const li=document.createElement("li"); li.textContent=s; dmStandards.appendChild(li); });

  drillModal.classList.remove("hidden");
}
function closeDrillModal(){ drillModal.classList.add("hidden"); }

/* ====== FAILURES MODAL ====== */
let failContext = { drillId:null, selected:new Set(), practiceId:null };
function openFailModal(drillId){
  const today = loadJSON(KEY_TODAY, null);
  if (!today || !(today.drills||[]).length){ alert("Build a practice first."); return; }
  const drill = today.drills.find(d=>d.id===drillId);
  if (!drill) return;

  failContext = { drillId, selected:new Set(), practiceId: today.id };
  fmTitle.textContent = drill.title;

  const roster = getRoster();
  const presentIds = new Set(today.presentIds || getPresentIds());
  const presentPlayers = roster.filter(p=>presentIds.has(p.id));

  fmPlayers.innerHTML="";
  if (!presentPlayers.length){
    fmPlayers.innerHTML = `<div class="text-base muted2">No present players set.</div>`;
  } else {
    presentPlayers.forEach(p=>{
      const btn=document.createElement("button");
      btn.className="badge";
      btn.style.padding="12px 16px";
      btn.style.fontSize="15px";
      btn.style.fontWeight="950";
      btn.textContent=p.name;
      btn.onclick=()=>{
        if (failContext.selected.has(p.id)){
          failContext.selected.delete(p.id);
          btn.className="badge";
        } else {
          failContext.selected.add(p.id);
          btn.className="danger";
        }
        btn.style.padding="12px 16px";
        btn.style.fontSize="15px";
        btn.style.fontWeight="950";
      };
      fmPlayers.appendChild(btn);
    });
  }

  failModal.classList.remove("hidden");
}
function closeFailModal(){ failModal.classList.add("hidden"); }
function clearFailureSelection(){ const d=failContext.drillId; closeFailModal(); openFailModal(d); }
function saveFailureLog(){
  if (!failContext.drillId) return;
  const today = loadJSON(KEY_TODAY, null);
  const roster = getRoster();
  const drill = DRILLS.find(d=>d.id===failContext.drillId);

  const entry = {
    id: uid(),
    ts: Date.now(),
    date: new Date().toISOString(),
    weekId: getWeekId(),
    practiceId: failContext.practiceId,
    drillId: failContext.drillId,
    drillTitle: drill?.title || "Drill",
    category: normalizeCat(drill?.category || "Other"),
    players: Array.from(failContext.selected),
    playerNames: Array.from(failContext.selected).map(pid => roster.find(p=>p.id===pid)?.name || pid)
  };

  const list = getFailures();
  list.push(entry);
  saveFailures(list);

  const w = ensureWeek();
  w.fails = (w.fails||0) + (entry.players.length || 0);
  saveJSON(KEY_WEEK, w);

  closeFailModal();
  renderHome();
  renderProgress();
}

/* ====== GRADES MODAL ====== */
function openGradeModal(drillId){
  const today = loadJSON(KEY_TODAY, null);
  if (!today || !(today.drills||[]).length){ alert("Build a practice first."); return; }
  const drill = today.drills.find(d=>d.id===drillId) || DRILLS.find(d=>d.id===drillId);
  gmTitle.textContent = drill?.title || "Drill";

  const roster = getRoster();
  const presentIds = new Set(today.presentIds || getPresentIds());
  const presentPlayers = roster.filter(p=>presentIds.has(p.id));

  gmBody.innerHTML="";

  const gradeList = getGrades().filter(g => g.practiceId===today.id && g.drillId===drillId);
  const gradeMap = new Map(gradeList.map(g => [g.playerId, g]));

  if (!presentPlayers.length){
    gmBody.innerHTML = `<div class="text-base muted2">No present players set.</div>`;
  } else {
    presentPlayers.forEach(p=>{
      const existing = gradeMap.get(p.id);
      const row=document.createElement("div");
      row.className="chip p-4 flex flex-col gap-3";
      row.innerHTML = `
        <div class="flex items-center justify-between gap-3">
          <div class="font-black text-lg">${escapeHtml(p.name)} <span class="muted2 text-sm">#${escapeHtml(p.number||"--")} ‚Ä¢ ${escapeHtml(p.pos||"‚Äî")}</span></div>
          <div class="text-sm muted2">Saved: <span class="font-black" id="gmSaved-${p.id}">${existing ? existing.grade : "‚Äî"}</span></div>
        </div>
        <div class="grid grid-cols-5 gap-2">
          ${[1,2,3,4,5].map(n=>`<button class="btn" data-g="${n}">${n}</button>`).join("")}
        </div>
        <input class="inp" id="gmNote-${p.id}" placeholder="Optional note‚Ä¶" value="${escapeHtml(existing?.note||"")}" />
      `;
      row.querySelectorAll("button[data-g]").forEach(btn=>{
        btn.onclick=()=>{
          const grade=parseInt(btn.getAttribute("data-g"),10);
          const note=(document.getElementById(`gmNote-${p.id}`).value||"").trim();
          upsertGrade(today.id, drillId, p.id, grade, note);
          document.getElementById(`gmSaved-${p.id}`).textContent = String(grade);
          renderPracticeControls(); renderProgress(); renderHome();
        };
      });
      gmBody.appendChild(row);
    });
  }

  gradeModal.classList.remove("hidden");
}
function closeGradeModal(){ gradeModal.classList.add("hidden"); }

/* ====== ASK COACH ====== */
function openAskCoachModal(){ askCoachModal.classList.remove("hidden"); coachAnswer.classList.add("hidden"); coachQuestion.focus(); }
function closeAskCoachModal(){ askCoachModal.classList.add("hidden"); }
function answerCoachOffline(){
  const q=(coachQuestion.value||"").trim().toLowerCase();
  let short="", expand="";
  const footer=()=>"\n\nTip: open a drill‚Äôs Explain for standards + cues.";
  if (q.includes("help")){
    short=`WHY: Stops layups.\nDO: Feet in paint early, chest up, recover on the pass.\nCONSEQUENCE: Late help = layup or foul.`;
    expand=`Teach:\n- Help side: both feet in paint.\n- Talk: ‚ÄúHELP!‚Äù ‚ÄúI GOT BALL!‚Äù ‚ÄúRECOVER!‚Äù\n- Recover on air-time.\n\nMistakes:\n- Ball watching\n- Helping late\n- No talk` + footer();
  } else if (q.includes("closeout")){
    short=`WHY: Takes away open shots.\nDO: Sprint 2/3, chop 1/3, hands high.\nCONSEQUENCE: Fly-by = drive.`;
    expand=`Cues:\n- Arrive under control.\n- Angle to sideline.\n- Feet beat hands.` + footer();
  } else {
    short=`WHY: Winning details.\nDO: Talk, box out, sprint between reps.\nCONSEQUENCE: Lazy habits = losses.`;
    expand=`Default DNA:\n- Feet in paint help side\n- No fly-bys\n- Box out every shot\n- Sprint between drills` + footer();
  }
  coachAnswer.textContent = `${short}\n\n${expand}`;
  coachAnswer.classList.remove("hidden");
}

/* ====== PROGRESS ====== */
function renderProgress(){
  const roster = getRoster();
  progressBoard.innerHTML = "";
  if (!roster.length){
    progressBoard.innerHTML = `<div class="chip p-4"><div class="text-base muted2">Add players in Roster first.</div></div>`;
    return;
  }

  const fails = getFailures();
  const grades = getGrades();
  const weekId = getWeekId();

  const byPlayerWeekFails = {};
  const byPlayerAllFails = {};
  const byPlayerWeekGrade = {};
  const byPlayerAllGrade = {};

  for (const f of fails){
    for (const pid of (f.players||[])){
      (byPlayerAllFails[pid] ||= {});
      byPlayerAllFails[pid][f.category] = (byPlayerAllFails[pid][f.category]||0)+1;

      if (f.weekId===weekId){
        (byPlayerWeekFails[pid] ||= {});
        byPlayerWeekFails[pid][f.category] = (byPlayerWeekFails[pid][f.category]||0)+1;
      }
    }
  }

  function addGrade(bucket, pid, g){
    bucket[pid] ||= { sum:0, n:0 };
    bucket[pid].sum += Number(g.grade||0);
    bucket[pid].n += 1;
  }
  for (const g of grades){
    addGrade(byPlayerAllGrade, g.playerId, g);
    if (g.weekId===weekId) addGrade(byPlayerWeekGrade, g.playerId, g);
  }
  function avg(b, pid){
    const x=b[pid]; if (!x||!x.n) return null;
    return Math.round((x.sum/x.n)*10)/10;
  }

  roster.forEach(p=>{
    const w = byPlayerWeekFails[p.id] || {};
    const a = byPlayerAllFails[p.id] || {};
    const topWeek = topEntries(w,3);
    const topAll = topEntries(a,3);
    const wAvg = avg(byPlayerWeekGrade, p.id);
    const aAvg = avg(byPlayerAllGrade, p.id);

    const row=document.createElement("div");
    row.className="chip p-4";
    row.innerHTML=`
      <div class="flex flex-col lg:flex-row lg:items-start lg:justify-between gap-4">
        <div class="min-w-0">
          <div class="font-black text-xl">
            ${escapeHtml(p.name)}
            <span class="muted2 text-sm">#${escapeHtml(p.number||"--")} ‚Ä¢ ${escapeHtml(p.pos||"‚Äî")} ‚Ä¢ H/W ${escapeHtml(p.height||"‚Äî")}/${escapeHtml(p.weight||"‚Äî")}</span>
          </div>

          <div class="mt-3 grid grid-cols-1 md:grid-cols-3 gap-3">
            <div class="chip p-3">
              <div class="text-xs uppercase tracking-wider muted2">This Week Needs</div>
              <div class="text-base mt-2 ${topWeek.length ? "muted" : "muted2"}">
                ${topWeek.length ? topWeek.map(([k,v])=>`${k} (${v})`).join(" ‚Ä¢ ") : "No failures logged this week."}
              </div>
            </div>
            <div class="chip p-3">
              <div class="text-xs uppercase tracking-wider muted2">All-Time Needs</div>
              <div class="text-base mt-2 ${topAll.length ? "muted" : "muted2"}">
                ${topAll.length ? topAll.map(([k,v])=>`${k} (${v})`).join(" ‚Ä¢ ") : "No failures logged yet."}
              </div>
            </div>
            <div class="chip p-3">
              <div class="text-xs uppercase tracking-wider muted2">Grade Avg</div>
              <div class="text-base mt-2 muted">
                Week: <span class="font-black">${wAvg ?? "‚Äî"}</span>/5 ‚Ä¢ All: <span class="font-black">${aAvg ?? "‚Äî"}</span>/5
              </div>
            </div>
          </div>
        </div>

        <div class="flex flex-col gap-2 min-w-[220px]">
          <button class="btn" onclick="openAskCoachModal(); coachQuestion.value='Quick cue for ${escapeHtml(p.name)} to improve ${escapeHtml(topWeek[0]?.[0] || "defense")}?';">Ask Coach</button>
        </div>
      </div>
    `;
    progressBoard.appendChild(row);
  });
}

function clearProgress(){
  if (!confirm("Clear all failure logs + grades + recap? (Roster stays)")) return;
  localStorage.removeItem(KEY_FAILURES);
  localStorage.removeItem(KEY_GRADES);
  localStorage.removeItem(KEY_LAST_RECAP);
  const w = ensureWeek();
  w.fails = 0;
  saveJSON(KEY_WEEK, w);
  renderHome(); renderProgress();
}
function exportData(){
  const data = {
    week: ensureWeek(),
    roster: getRoster(),
    present: getPresentIds(),
    today: loadJSON(KEY_TODAY, null),
    prefs: getPrefMap(),
    failures: getFailures(),
    grades: getGrades(),
    recap: loadJSON(KEY_LAST_RECAP, null),
    regenSeed: getRegenSeed(),
    emphasis: loadJSON(KEY_EMPHASIS, null)
  };
  const blob = new Blob([JSON.stringify(data,null,2)], {type:"application/json"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url; a.download = `practice-command-center-export-${Date.now()}.json`;
  a.click(); URL.revokeObjectURL(url);
}

/* ====== LOG PRACTICE ====== */
function computeWorstAreaFromLogs(logs){
  if (!logs || !logs.length) return "‚Äî";
  const score = {};
  for (const l of logs){
    const drill = DRILLS.find(d=>d.id===l.drillId);
    const cat = normalizeCat(drill?.category || l.category || "Other");
    score[cat] = (score[cat]||0) + (l.players?.length||0) + 1;
  }
  const top = Object.entries(score).sort((a,b)=>b[1]-a[1])[0];
  return top ? top[0] : "‚Äî";
}
function computeTopWorstDrillFromPrefs(planDrills){
  const pref = getPrefMap();
  let top=null, worst=null;
  for (const d of planDrills){
    const v = pref[d.id] ?? 0;
    if (v===1 && !top) top=d.title;
    if (v===-1 && !worst) worst=d.title;
  }
  return { topDrill: top, worstDrill: worst };
}
function logPracticeComplete(){
  const today = loadJSON(KEY_TODAY, null);
  if (!today || !(today.drills||[]).length){ alert("Build a practice first."); return; }

  const w = ensureWeek();
  w.practices = (w.practices||0) + 1;
  saveJSON(KEY_WEEK, w);

  const practiceId = today.id;
  const related = getFailures().filter(f=>f.practiceId===practiceId);
  const worstArea = computeWorstAreaFromLogs(related);
  const { topDrill, worstDrill } = computeTopWorstDrillFromPrefs(today.drills);
  const flagged = new Set();
  related.forEach(r => (r.players||[]).forEach(pid=>flagged.add(pid)));

  saveJSON(KEY_LAST_RECAP, {
    title: `Practice Logged ‚Ä¢ ${new Date(today.date).toLocaleDateString()}`,
    meta: `Present: ${today.presentIds?.length||0} ‚Ä¢ Duration: ${today.duration} ‚Ä¢ Focus: ${today.focus || "‚Äî"} ‚Ä¢ Notes: ${today.notes || "‚Äî"}`,
    worstArea: worstArea || "‚Äî",
    topDrill: topDrill || "‚Äî",
    worstDrill: worstDrill || "‚Äî",
    flaggedCount: flagged.size
  });

  alert("Practice logged.");
  renderHome();
}

/* ====== MODALS: click-out + ESC ====== */
function wireModalClose(modalId, closeFn){
  const m = document.getElementById(modalId);
  m.addEventListener("click", (e)=>{ if (e.target === m) closeFn(); });
}
document.addEventListener("keydown", (e)=>{
  if (e.key !== "Escape") return;
  if (!drillModal.classList.contains("hidden")) closeDrillModal();
  if (!failModal.classList.contains("hidden")) closeFailModal();
  if (!gradeModal.classList.contains("hidden")) closeGradeModal();
  if (!askCoachModal.classList.contains("hidden")) closeAskCoachModal();
  if (!playerModal.classList.contains("hidden")) closePlayerModal();
});

/* ====== BOOT ====== */
(function init(){
  ensureWeek();
  const today = loadJSON(KEY_TODAY, null);
  if (!today) saveJSON(KEY_TODAY, { id: uid(), duration: 90, focus:"", notes:"", drills:[], presentIds: getPresentIds(), date:new Date().toISOString() });

  loadEmphasis();
  ["em_def","em_reb","em_off","em_press","em_cond","em_shoot"].forEach(id=>{
    document.getElementById(id).addEventListener("change", saveEmphasis);
  });

  wireModalClose("drillModal", closeDrillModal);
  wireModalClose("failModal", closeFailModal);
  wireModalClose("gradeModal", closeGradeModal);
  wireModalClose("askCoachModal", closeAskCoachModal);
  wireModalClose("playerModal", closePlayerModal);

  renderRoster();
  renderPracticeControls();
  renderProgress();
  renderHome();
  showTab("home");
})();
</script>
</body>
</html>
