<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1.0,viewport-fit=cover"/>
  <title>Practice Builder Pro (V1)</title>
  <style>
    :root{
      --bg:#05070c;
      --panel:#071021;
      --panel2:#050b18;
      --text:#eaf1ff;
      --muted:rgba(234,241,255,.68);
      --line:rgba(234,241,255,.10);

      --accent:#3b82f6;  /* main pop */
      --blue:#60a5fa;
      --good:#22c55e;
      --warn:#f59e0b;
      --bad:#ef4444;

      --chip:rgba(255,255,255,.06);
      --shadow:0 16px 42px rgba(0,0,0,.58);
      --r:18px;
    }

    *{box-sizing:border-box}
    body{
      margin:0;
      background:
        radial-gradient(900px 450px at 12% 0%, rgba(59,130,246,.18), transparent 62%),
        radial-gradient(900px 450px at 92% 8%, rgba(96,165,250,.12), transparent 58%),
        radial-gradient(900px 650px at 60% 95%, rgba(37,99,235,.10), transparent 60%),
        linear-gradient(180deg,#05070c 0%, #040611 100%);
      color:var(--text);
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
      -webkit-font-smoothing:antialiased;
      overflow:hidden;
    }

    .app{
      height:100dvh;
      display:flex;
      flex-direction:column;
      padding: max(10px, env(safe-area-inset-top)) 12px max(10px, env(safe-area-inset-bottom)) 12px;
      gap:10px;
      max-width: 980px;
      margin:0 auto;
    }

    .header{
      flex:0 0 auto;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      padding:12px 14px;
      border:1px solid var(--line);
      border-radius:var(--r);
      background:rgba(7,16,33,.76);
      backdrop-filter: blur(10px);
      box-shadow: var(--shadow);
    }
    .title{display:flex;flex-direction:column;gap:2px}
    .title h1{margin:0;font-size:15px;letter-spacing:.2px}
    .title .sub{font-size:12px;color:var(--muted)}

    .brandRight{
      display:flex; align-items:center; gap:10px;
    }

    .logoLockup{
      display:flex; align-items:center; gap:8px;
      padding:7px 10px;
      border-radius:14px;
      border:1px solid rgba(96,165,250,.28);
      background: linear-gradient(180deg, rgba(96,165,250,.10), rgba(59,130,246,.07));
      box-shadow: 0 0 0 2px rgba(59,130,246,.10) inset;
      user-select:none;
      white-space:nowrap;
    }
    .logoMark{
      width:22px; height:22px; border-radius:8px;
      background:
        radial-gradient(12px 10px at 30% 30%, rgba(255,255,255,.22), transparent 60%),
        linear-gradient(135deg, rgba(96,165,250,.9), rgba(59,130,246,.55));
      border:1px solid rgba(255,255,255,.18);
      box-shadow: 0 10px 18px rgba(0,0,0,.35);
    }
    .logoText{
      display:flex; flex-direction:column; line-height:1.05;
      font-weight:1000; letter-spacing:.8px;
      text-transform:uppercase;
      font-size:10px;
      color:rgba(234,241,255,.92);
    }
    .logoText span:last-child{
      font-size:9px;
      letter-spacing:1.2px;
      color:rgba(234,241,255,.72);
      font-weight:900;
    }

    .pill{
      font-size:12px;
      padding:8px 10px;
      border-radius:999px;
      border:1px solid var(--line);
      background:rgba(255,255,255,.05);
      color:var(--muted);
      display:inline-flex;align-items:center;gap:8px;
      white-space:nowrap;
    }
    .dot{width:8px;height:8px;border-radius:99px;background:var(--good)}

    .content{
      flex:1 1 auto;
      overflow:auto;
      padding-bottom:10px;
    }
    .content::-webkit-scrollbar{width:0;height:0}

    .nav{
      flex:0 0 auto;
      display:grid;
      grid-template-columns:repeat(6,1fr);
      gap:8px;
      padding:10px;
      border:1px solid var(--line);
      border-radius:var(--r);
      background:rgba(7,16,33,.76);
      backdrop-filter: blur(10px);
      box-shadow: var(--shadow);
    }
    .nav button{
      border:1px solid var(--line);
      background:rgba(255,255,255,.04);
      color:var(--muted);
      padding:10px 8px;
      border-radius:14px;
      font-weight:950;
      font-size:12px;
      cursor:pointer;
    }
    .nav button.active{
      color:var(--text);
      border-color:rgba(59,130,246,.45);
      box-shadow: 0 0 0 2px rgba(59,130,246,.14) inset;
      background:rgba(59,130,246,.10);
    }

    .section{display:none; gap:10px}
    .section.active{display:flex; flex-direction:column}

    .card{
      border:1px solid var(--line);
      background:rgba(7,16,33,.76);
      border-radius:var(--r);
      padding:14px;
      box-shadow: var(--shadow);
    }
    .row{display:flex; gap:10px; align-items:center; justify-content:space-between}
    .row.wrap{flex-wrap:wrap}
    .h2{margin:0; font-size:14px; letter-spacing:.2px; font-weight:1000}
    .muted{color:var(--muted); font-size:12px}
    .tiny{font-size:11px;color:var(--muted);line-height:1.35}
    .divider{height:1px;background:var(--line); margin:10px 0}

    .grid2{display:grid; grid-template-columns:1fr 1fr; gap:10px}
    .grid3{display:grid; grid-template-columns:1fr 1fr 1fr; gap:10px}
    @media (max-width:560px){ .grid2,.grid3{grid-template-columns:1fr} }

    .btn{
      border:1px solid var(--line);
      background:rgba(255,255,255,.06);
      color:var(--text);
      padding:10px 12px;
      border-radius:14px;
      font-weight:1000;
      font-size:12px;
      cursor:pointer;
    }
    .btn.primary{ background:rgba(59,130,246,.14); border-color:rgba(59,130,246,.45); }
    .btn.good{ background:rgba(34,197,94,.12); border-color:rgba(34,197,94,.40); }
    .btn.warn{ background:rgba(245,158,11,.12); border-color:rgba(245,158,11,.40); }
    .btn.bad{ background:rgba(239,68,68,.12); border-color:rgba(239,68,68,.45); }

    .chipRow{display:flex;gap:8px;flex-wrap:wrap}
    .chip{
      border:1px solid var(--line);
      background:var(--chip);
      padding:8px 10px;
      border-radius:999px;
      font-size:12px;
      color:var(--muted);
      cursor:pointer;
      user-select:none;
      font-weight:950;
    }
    .chip.on{
      color:var(--text);
      background:rgba(59,130,246,.12);
      border-color:rgba(59,130,246,.45);
      box-shadow:0 0 0 2px rgba(59,130,246,.10) inset;
    }
    .chip.present.on{ background:rgba(34,197,94,.10); border-color:rgba(34,197,94,.40); box-shadow:0 0 0 2px rgba(34,197,94,.08) inset;}
    .chip.bad.on{ background:rgba(239,68,68,.10); border-color:rgba(239,68,68,.40); }

    .tag{
      font-size:11px;
      padding:6px 8px;
      border-radius:999px;
      border:1px solid var(--line);
      background:rgba(255,255,255,.04);
      color:var(--muted);
      white-space:nowrap;
      font-weight:950;
    }
    .tag.blue{border-color:rgba(59,130,246,.45); background:rgba(59,130,246,.10); color:rgba(234,241,255,.92)}
    .tag.good{border-color:rgba(34,197,94,.45); background:rgba(34,197,94,.10); color:rgba(234,241,255,.92)}
    .tag.warn{border-color:rgba(245,158,11,.45); background:rgba(245,158,11,.10); color:rgba(234,241,255,.92)}
    .tag.bad{border-color:rgba(239,68,68,.45); background:rgba(239,68,68,.10); color:rgba(234,241,255,.92)}

    .input, select, textarea{
      width:100%;
      border-radius:14px;
      border:1px solid var(--line);
      background:rgba(0,0,0,.25);
      color:var(--text);
      padding:12px;
      font-size:14px;
      outline:none;
      font-weight:850;
    }
    textarea{resize:none}
    .input::placeholder{color:rgba(234,241,255,.35)}

    .list{display:flex;flex-direction:column;gap:8px}
    .item{
      border:1px solid var(--line);
      background:rgba(255,255,255,.03);
      border-radius:16px;
      padding:12px;
      display:flex;
      gap:10px;
      justify-content:space-between;
      align-items:flex-start;
    }
    .left{min-width:0}
    .name{font-weight:1000}
    .meta{font-size:12px;color:var(--muted);margin-top:4px;line-height:1.3}
    .right{display:flex;gap:8px;flex-wrap:wrap;justify-content:flex-end}

    /* Run Practice */
    .runCard{
      border:1px solid rgba(59,130,246,.28);
      background: linear-gradient(180deg, rgba(7,16,33,.92), rgba(5,11,24,.92));
      border-radius:22px;
      padding:14px;
      box-shadow:0 30px 70px rgba(0,0,0,.60);
    }
    .bigTitle{
      font-size:18px;
      font-weight:1000;
      margin:0;
      letter-spacing:.2px;
    }
    .timer{
      font-variant-numeric: tabular-nums;
      font-weight:1000;
      padding:8px 10px;
      border-radius:14px;
      border:1px solid rgba(59,130,246,.35);
      background:rgba(59,130,246,.10);
      color:rgba(234,241,255,.95);
    }
    .stdList{
      margin:10px 0 0 0;
      padding:0 0 0 18px;
      color:rgba(234,241,255,.90);
      font-size:13px;
      line-height:1.35;
    }

    /* Modal */
    .modalWrap{
      position:fixed; inset:0;
      background:rgba(0,0,0,.68);
      display:none;
      align-items:flex-end;
      justify-content:center;
      padding:12px;
      padding-bottom:max(12px, env(safe-area-inset-bottom));
      z-index:50;
    }
    .modalWrap.show{display:flex}
    .modal{
      width:100%;
      max-width:900px;
      border-radius:22px;
      border:1px solid var(--line);
      background:rgba(7,16,33,.96);
      box-shadow:0 30px 90px rgba(0,0,0,.65);
      padding:14px;
    }
    .modalHeader{display:flex;align-items:flex-start;justify-content:space-between;gap:10px}
    .modalTitle{font-weight:1000}
    .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;}
    canvas{max-width:100%; background:rgba(255,255,255,.02); border:1px solid var(--line); border-radius:14px;}
  </style>
</head>

<body>
<div class="app">
  <div class="header">
    <div class="title">
      <h1>CoachBoard</h1>
      <div class="sub">Build practice fast. Talk less. Rep more.</div>
    </div>

    <div class="brandRight">
      <div class="pill"><span class="dot"></span> Offline / Free</div>
      <div class="logoLockup" title="Practice Builder Pro">
        <div class="logoMark" aria-hidden="true"></div>
        <div class="logoText">
          <span>PRACTICE</span>
          <span>BUILDER PRO</span>
        </div>
      </div>
    </div>
  </div>

  <div class="content">
    <!-- HOME -->
    <section id="sec-home" class="section active">
      <div class="card">
        <div class="row wrap">
          <div>
            <div class="h2">Today</div>
            <div class="muted" id="homeLine">—</div>
          </div>
          <div class="chipRow">
            <span class="tag blue" id="tagBand">Band: —</span>
            <span class="tag good" id="tagNeed">Need: Auto</span>
            <button class="btn primary" onclick="go('build')">BUILD</button>
            <button class="btn good" onclick="go('run')">RUN</button>
          </div>
        </div>
        <div class="divider"></div>

        <div class="grid3">
          <div class="card" style="background:rgba(255,255,255,.03); box-shadow:none">
            <div class="muted">Present</div>
            <div style="font-weight:1000;font-size:22px" id="homePresent">0</div>
          </div>
          <div class="card" style="background:rgba(255,255,255,.03); box-shadow:none">
            <div class="muted">Logs (7d)</div>
            <div style="font-weight:1000;font-size:16px" id="homeLogs">0</div>
          </div>
          <div class="card" style="background:rgba(255,255,255,.03); box-shadow:none">
            <div class="muted">Last Plan</div>
            <div style="font-weight:1000;font-size:16px" id="homeLastPlan">—</div>
          </div>
        </div>
      </div>

      <div class="card">
        <div class="row wrap">
          <div>
            <div class="h2">Program DNA</div>
            <div class="muted">Hard standards. No excuses.</div>
          </div>
          <div class="chipRow">
            <span class="tag blue">No middle</span>
            <span class="tag blue">Feet in paint</span>
            <span class="tag blue">Under screens</span>
            <span class="tag blue">Bump cutters</span>
            <span class="tag blue">Deny 1 away</span>
            <span class="tag blue">Box hard</span>
          </div>
        </div>
        <div class="divider"></div>
        <div class="muted">
          Man-to-man first. Force away from middle. Help side: both feet in paint then recover on air time.
          Help the helper. Bump cutters. Go under screens. Don’t chase.
          One pass away deny. 3/4 deny in the post. No ball-side doubles. Box hard. Secure rebounds.
          Reward charges. Communicate switches when needed.
        </div>
      </div>

      <div class="card">
        <div class="row wrap">
          <div>
            <div class="h2">Quick Actions</div>
            <div class="muted">Roster → Present → Build → Run → Log → Progress</div>
          </div>
          <div class="chipRow">
            <button class="btn" onclick="go('roster')">Roster</button>
            <button class="btn primary" onclick="go('build')">Build</button>
            <button class="btn good" onclick="go('run')">Run</button>
            <button class="btn" onclick="go('log')">Log</button>
            <button class="btn" onclick="go('progress')">Progress</button>
            <button class="btn" onclick="go('reports')">Reports</button>
          </div>
        </div>
      </div>
    </section>

    <!-- ROSTER -->
    <section id="sec-roster" class="section">
      <div class="card">
        <div class="row wrap">
          <div>
            <div class="h2">Roster</div>
            <div class="muted">Tap “Here” to mark who’s present today.</div>
          </div>
          <div class="chipRow">
            <button class="btn primary" onclick="openPlayerModal()">+ Add Player</button>
            <button class="btn bad" onclick="resetData()">Reset Data</button>
          </div>
        </div>
      </div>
      <div id="rosterList" class="list"></div>
    </section>

    <!-- BUILD -->
    <section id="sec-build" class="section">
      <div class="card">
        <div class="row wrap">
          <div>
            <div class="h2">Build Practice</div>
            <div class="muted">Attendance-aware. No repeat spam. Adapts to weaknesses.</div>
          </div>
          <div class="chipRow">
            <button class="btn primary" onclick="buildPractice(false)">BUILD</button>
            <button class="btn" onclick="buildPractice(true)">REGENERATE</button>
            <button class="btn good" onclick="go('run')">RUN</button>
          </div>
        </div>

        <div class="divider"></div>

        <div class="grid2">
          <div>
            <div class="muted">Minutes</div>
            <input id="inpMinutes" class="input" type="number" min="30" max="150" value="90"/>
          </div>
          <div>
            <div class="muted">Focus (optional)</div>
            <input id="inpFocus" class="input" placeholder="Leave blank = Auto (based on logs)"/>
          </div>
        </div>

        <div style="margin-top:10px">
          <div class="muted">Emphasis (lock what you want today)</div>
          <div class="chipRow" style="margin-top:8px" id="emphasisChips"></div>
          <div class="tiny" style="margin-top:8px">
            If you lock nothing, it auto-prioritizes what your guys are missing (last 7 days).
          </div>
        </div>

        <div class="divider"></div>
        <div class="muted">Present Today</div>
        <div class="chipRow" id="presentChips" style="margin-top:8px"></div>
        <div class="tiny" style="margin-top:8px">
          Band logic: 1–2 / 3–4 / 5–6 (future: 7+). No big drills when numbers are small.
        </div>

        <div class="divider"></div>
        <div class="row wrap">
          <div>
            <div class="muted">Last Build</div>
            <div class="tiny mono" id="buildMeta">—</div>
          </div>
          <button class="btn" onclick="go('plan')">View Plan</button>
        </div>
      </div>
    </section>

    <!-- PLAN -->
    <section id="sec-plan" class="section">
      <div class="card">
        <div class="row wrap">
          <div>
            <div class="h2">Today’s Plan</div>
            <div class="muted" id="planHeader">—</div>
          </div>
          <div class="chipRow">
            <button class="btn good" onclick="go('run')">RUN</button>
            <button class="btn" onclick="go('log')">LOG</button>
            <button class="btn primary" onclick="go('build')">ADJUST</button>
          </div>
        </div>
      </div>
      <div id="planList" class="list"></div>
    </section>

    <!-- RUN PRACTICE -->
    <section id="sec-run" class="section">
      <div class="runCard">
        <div class="row wrap">
          <div>
            <div class="h2">Run Practice</div>
            <div class="muted" id="runMeta">Load a plan to run it.</div>
          </div>
          <div class="chipRow">
            <div class="timer" id="runTimer">00:00</div>
            <button class="btn" onclick="runPrev()">Prev</button>
            <button class="btn" onclick="runNext()">Next</button>
          </div>
        </div>

        <div class="divider"></div>

        <div class="row wrap">
          <div>
            <div class="tag blue" id="runStep">Drill 0/0</div>
          </div>
          <div class="chipRow">
            <button class="btn primary" onclick="toggleTimer()"><span id="timerBtnText">Start</span></button>
            <button class="btn" onclick="openExplain()">Explain</button>
            <button class="btn bad" onclick="openQuickLog()">Log Misses</button>
          </div>
        </div>

        <div style="margin-top:10px">
          <h3 class="bigTitle" id="runTitle">—</h3>
          <div class="muted" id="runSub">—</div>
        </div>

        <div class="divider"></div>

        <div class="row wrap">
          <div class="chipRow" id="runTags"></div>
          <div class="chipRow">
            <span class="tag warn" id="runMinutesTag">0 min</span>
            <span class="tag good" id="runBandTag">Band —</span>
          </div>
        </div>

        <ul class="stdList" id="runStandards"></ul>

        <div class="divider"></div>
        <div class="tiny">
          Coach rule: teach fast → rep hard. If it’s sloppy, restart rep. If it’s soft, raise standard.
        </div>
      </div>

      <div class="card">
        <div class="row wrap">
          <div>
            <div class="h2">Micro Prompts (Coach Assistant)</div>
            <div class="muted">Auto reminders based on misses today.</div>
          </div>
          <button class="btn" onclick="refreshPrompts()">Refresh</button>
        </div>
        <div class="divider"></div>
        <div id="promptList" class="list"></div>
      </div>
    </section>

    <!-- LOG -->
    <section id="sec-log" class="section">
      <div class="card">
        <div class="row wrap">
          <div>
            <div class="h2">Log (Standards Missed)</div>
            <div class="muted">Pick drill → tap who failed → save. Optional: which standard.</div>
          </div>
          <div class="chipRow">
            <button class="btn" onclick="go('run')">Run</button>
            <button class="btn" onclick="openAskCoach()">Ask Coach</button>
          </div>
        </div>

        <div class="divider"></div>

        <div class="muted">Select Drill</div>
        <div class="chipRow" id="logDrillChips" style="margin-top:8px"></div>

        <div class="divider"></div>

        <div class="muted">Players Present</div>
        <div class="chipRow" id="logPlayerChips" style="margin-top:8px"></div>

        <div class="divider"></div>

        <div class="grid2">
          <div>
            <div class="muted">Standard (optional)</div>
            <select id="selStandard"></select>
            <div class="tiny" style="margin-top:6px">Leave “General miss” for max speed.</div>
          </div>
          <div style="display:flex; gap:8px; align-items:flex-end; justify-content:flex-end">
            <button class="btn" onclick="clearLogSelection()">Clear</button>
            <button class="btn primary" onclick="saveLog()">Save Log</button>
          </div>
        </div>
      </div>

      <div class="card">
        <div class="row wrap">
          <div>
            <div class="h2">Recent Logs</div>
            <div class="muted">Last 10. This fuels the next build.</div>
          </div>
          <button class="btn" onclick="renderRecentLogs()">Refresh</button>
        </div>
        <div id="recentLogs" class="list" style="margin-top:10px"></div>
      </div>
    </section>

    <!-- PROGRESS -->
    <section id="sec-progress" class="section">
      <div class="card">
        <div class="row wrap">
          <div>
            <div class="h2">Progress</div>
            <div class="muted">Needs work = most missed standards (7d + all-time).</div>
          </div>
          <div class="chipRow">
            <button class="btn" onclick="exportJSON()">Export JSON</button>
          </div>
        </div>
      </div>

      <div class="card">
        <div class="row wrap">
          <div>
            <div class="h2">Team Needs (7d)</div>
            <div class="muted" id="teamNeedsLine">—</div>
          </div>
          <div class="chipRow">
            <span class="tag blue" id="teamNeedTag">—</span>
          </div>
        </div>
      </div>

      <div id="playerProgress" class="list"></div>
    </section>

    <!-- REPORTS -->
    <section id="sec-reports" class="section">
      <div class="card">
        <div class="row wrap">
          <div>
            <div class="h2">Reports (Monthly PDF)</div>
            <div class="muted">Weekly view: 4 points per month. Category charts (not drill charts).</div>
          </div>
          <div class="chipRow">
            <button class="btn primary" onclick="renderMonthlyPreview()">Preview</button>
            <button class="btn" onclick="printMonthlyPDF()">Export PDF</button>
          </div>
        </div>

        <div class="divider"></div>

        <div class="grid2">
          <div>
            <div class="muted">Month</div>
            <input id="repMonth" class="input" type="month"/>
          </div>
          <div>
            <div class="muted">Players</div>
            <select id="repWho"></select>
            <div class="tiny" style="margin-top:6px">Team = all players on each chart.</div>
          </div>
        </div>

        <div class="divider"></div>
        <div class="tiny">
          Export uses your browser/iPad “Print → Save as PDF”. Still offline and free.
        </div>
      </div>

      <div class="card" id="reportPreviewCard">
        <div class="row wrap">
          <div>
            <div class="h2">Preview</div>
            <div class="muted" id="repMeta">Pick month → Preview.</div>
          </div>
        </div>
        <div class="divider"></div>
        <div id="repPreview" class="list"></div>
      </div>
    </section>

  </div>

  <div class="nav">
    <button id="nav-home" class="active" onclick="go('home')">Home</button>
    <button id="nav-roster" onclick="go('roster')">Roster</button>
    <button id="nav-build" onclick="go('build')">Build</button>
    <button id="nav-plan" onclick="go('plan')">Plan</button>
    <button id="nav-run" onclick="go('run')">Run</button>
    <button id="nav-progress" onclick="go('progress')">Progress</button>
  </div>
</div>

<!-- MODAL -->
<div id="modalWrap" class="modalWrap">
  <div class="modal">
    <div class="modalHeader">
      <div>
        <div class="modalTitle" id="mTitle">—</div>
        <div class="tiny" id="mSub">—</div>
      </div>
      <button class="btn" onclick="closeModal()">Close</button>
    </div>
    <div class="divider"></div>
    <div id="mBody"></div>
  </div>
</div>

<script>
/* =========================================================
   STORAGE
========================================================= */
const K = {
  roster: "pbp_roster_v1",
  present: "pbp_present_v1",
  plan: "pbp_plan_v1",
  logs: "pbp_logs_v1",
  history: "pbp_history_v1",
  settings: "pbp_settings_v1"
};
const load = (k, fb) => { try { return JSON.parse(localStorage.getItem(k)) ?? fb; } catch { return fb; } };
const save = (k, v) => localStorage.setItem(k, JSON.stringify(v));

/* =========================================================
   TEAM DNA (coach explain defaults)
========================================================= */
const TEAM_DNA = {
  defense: [
    "Man-to-man first. Force away from middle.",
    "Help side: both feet in paint. Recover on air time.",
    "Help the helper. Bump cutters.",
    "Go under screens. Don’t chase.",
    "One pass away deny. 3/4 deny in the post.",
    "No ball-side doubles. Box hard. Secure rebounds.",
    "Reward charges. Communicate switches when needed."
  ],
  offense: [
    "4–1 motion: pass, V-cut to empty, feed post from wing if available.",
    "14 motion: wing entry, first cutter backdoor, wing ball screen, big flashes top."
  ],
  presses: [
    "2–2–1 press and 1–2–2 press. Full court man when needed.",
    "1–3–1 zone if you must. (Also 1–3–1 offense if needed.)"
  ]
};

/* =========================================================
   CATEGORIES / EMPHASIS
========================================================= */
const CATS = ["Defense","Rebounding","Offense","Press","Conditioning","Shooting","Team","Skill"];
const EMPHASIS = ["Defense","Rebounding","Offense","Press","Conditioning","Shooting"];
const CAT_COLOR = {
  Defense:"#60a5fa",
  Rebounding:"#3b82f6",
  Offense:"#93c5fd",
  Press:"#2563eb",
  Conditioning:"#1d4ed8",
  Shooting:"#7dd3fc"
};

/* =========================================================
   ATTENDANCE BANDS
========================================================= */
function bandFor(n){
  if (n <= 2) return "1–2";
  if (n <= 4) return "3–4";
  if (n <= 6) return "5–6";
  return "7+";
}
function bandMinMax(b){
  if (b==="1–2") return [1,2];
  if (b==="3–4") return [3,4];
  if (b==="5–6") return [5,6];
  return [7,99];
}

/* =========================================================
   UTIL
========================================================= */
const uid = () => (crypto?.randomUUID ? crypto.randomUUID() : (Date.now()+"-"+Math.random()).replace(".",""));
const clamp = (n,a,b) => Math.max(a, Math.min(b,n));
const now = () => Date.now();
function fmtDate(ts){
  const d = new Date(ts);
  return d.toLocaleDateString() + " " + d.toLocaleTimeString([], {hour:"2-digit", minute:"2-digit"});
}
function escapeHtml(s){
  return String(s ?? "")
    .replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;")
    .replaceAll('"',"&quot;").replaceAll("'","&#039;");
}

/* =========================================================
   ROSTER
========================================================= */
function getRoster(){ return load(K.roster, []); }
function setRoster(v){ save(K.roster, v); }
function getPresent(){ return load(K.present, []); }
function setPresent(v){ save(K.present, v); }

function togglePresent(pid){
  const set = new Set(getPresent());
  if (set.has(pid)) set.delete(pid); else set.add(pid);
  setPresent([...set]);
  renderAll();
}

/* =========================================================
   DRILL LIBRARY + VARIANTS (prevents repeats)
========================================================= */
function mkDrill(base){ return base; }
function addConstraint(d, text){
  return { ...d, steps: d.steps + " | CONSTRAINT: " + text, _constraint:text };
}
const VARIANTS = [
  { suffix:" (No Middle)", apply:(d)=>addConstraint(d, "No middle drives. Restart if broken.") },
  { suffix:" (2-Dribble Max)", apply:(d)=>addConstraint(d, "2 dribbles max before pass/shot.") },
  { suffix:" (Shot Clock 5s)", apply:(d)=>addConstraint(d, "5-second decision clock.") },
  { suffix:" (Score It)", apply:(d)=>addConstraint(d, "Track points. Loser runs. Keep it ruthless.") },
  { suffix:" (Talk Rule)", apply:(d)=>addConstraint(d, "Silent rep = automatic fail.") },
  { suffix:" (Perfect Reps Only)", apply:(d)=>addConstraint(d, "One sloppy rep resets the count.") },
];

const DRILLS = [
  // 1–2
  mkDrill({
    id:"bh_1",
    title:"Two-Ball Handle Circuit",
    cat:"Skill",
    band:"1–2",
    tags:["ballhandling","pressure"],
    steps:"Two balls: pound/alt/cross/between/behind. Finish each set with 10-yard burst + hard stop.",
    standards:["Eyes up 10s at a time","Low hips, strong stance","No dribble above waist","Finish burst full speed"],
    coachShort:"WHY: control under pressure.\nDO: low + violent dribbles.\nCONSEQUENCE: sloppy = turnovers.",
    coachExpand:"CUES: snap wrists, protect ball.\nFIX: eyes down → reset rep.\nAdd: shadow defender + timer."
  }),
  mkDrill({
    id:"def_1",
    title:"Closeout → Contain (1v1)",
    cat:"Defense",
    band:"1–2",
    tags:["closeout","no-middle","onball"],
    steps:"Defender starts help spot, sprints closeout, chops, high hands. Offense attacks. Contain w/out reaching.",
    standards:["Sprint 2/3 then chop","No fly-by","Force away from middle","No reach fouls"],
    coachShort:"WHY: stop open shots + straight drives.\nDO: sprint, chop, contain.\nCONSEQUENCE: fly-by = layup.",
    coachExpand:"CUES: hips low, chest in front.\nIf you open early → cooked.\nRestart fly-bys."
  }),
  mkDrill({
    id:"fin_1",
    title:"Finishing: Two-Foot Stops + Contact",
    cat:"Offense",
    band:"1–2",
    tags:["finishing","toughness"],
    steps:"Attack from wing/top, finish through contact, land balanced on two-foot stop. Alternate hands.",
    standards:["Two-foot landing every rep","Strong + weak hand","No fading away","Finish high off glass"],
    coachShort:"WHY: tough finishes win games.\nDO: two feet + strong eyes.\nCONSEQUENCE: soft = no bucket.",
    coachExpand:"Fix fading: stop on two, THEN go up.\nAdd: euro/reverse/inside-hand."
  }),
  mkDrill({
    id:"cond_1",
    title:"NFHS Burst Conditioning (Solo/Pair)",
    cat:"Conditioning",
    band:"1–2",
    tags:["nfhs","pace"],
    steps:"20s full burst + 40s walk x 10–14. Optional ball last 3 rounds.",
    standards:["Bursts are 100%","No hands on knees","Last 3 same pace as first","Talk through fatigue"],
    coachShort:"WHY: late-game wins.\nDO: full bursts.\nCONSEQUENCE: gas = bad decisions.",
    coachExpand:"Timer on. If someone coasts: repeat that round.\nAdd ball: sprint-dribble + stop/pivot."
  }),
  mkDrill({
    id:"shoot_12",
    title:"Form Ladder (Close Range)",
    cat:"Shooting",
    band:"1–2",
    tags:["mechanics","repeatability"],
    steps:"5 spots close. Make 5 in a row to advance. Miss resets a step.",
    standards:["Hold follow-through 2s","No drifting","Elbow under ball","Track makes out loud"],
    coachShort:"WHY: mechanics hold under pressure.\nDO: perfect reps.\nCONSEQUENCE: lazy form = bricks.",
    coachExpand:"Progress: one-dribble pullups.\nAdd fatigue: 10s sprint between spots."
  }),

  // 3–4
  mkDrill({
    id:"shell_34",
    title:"2v2 Closeout + Help (No Middle)",
    cat:"Defense",
    band:"3–4",
    tags:["help","closeout","talk"],
    steps:"Start help spots. Coach passes. Closeout. Drive attack. Help steps in paint then recover.",
    standards:["Feet in paint on help side","No middle drive","Talk BALL/HELP/DENY","Box out after shot"],
    coachShort:"WHY: team defense habits.\nDO: help early + recover hard.\nCONSEQUENCE: late help = layups.",
    coachExpand:"If you help, recover on AIR TIME.\nBump cutters. No silent reps."
  }),
  mkDrill({
    id:"reb_34",
    title:"Rebound + Outlet War (3–4)",
    cat:"Rebounding",
    band:"3–4",
    tags:["boxout","outlet","physical"],
    steps:"Shot up: find body, hit first, pursue. Outlet within 2 seconds. Repeat fast.",
    standards:["Contact first then ball","Two hands, chin it","Outlet in 2 seconds","No watching rebounds"],
    coachShort:"WHY: end possessions.\nDO: hit first.\nCONSEQUENCE: no box = second chances.",
    coachExpand:"Score it: +1 boxout +1 secure.\nIf no contact, stop and correct."
  }),
  mkDrill({
    id:"off_34",
    title:"4–1 Motion: V-Cut Timing",
    cat:"Offense",
    band:"3–4",
    tags:["4-1","vcuts","spacing"],
    steps:"Pass to wing, cutter V-cuts to empty, fill behind. Look post window on wing.",
    standards:["Hard V-cut (sell it)","Fill empty immediately","Eyes to post window","Catch ready to pass/drive"],
    coachShort:"WHY: motion only works if cuts are hard.\nDO: cut hard, fill fast.\nCONSEQUENCE: soft cuts = dead offense.",
    coachExpand:"Corners/top aren’t 'spots'—flow through empty.\nTeach: pass → cut → fill."
  }),
  mkDrill({
    id:"scr_34",
    title:"Screen Defense: UNDER + Re-Square",
    cat:"Defense",
    band:"3–4",
    tags:["screens","under","talk"],
    steps:"Offense sets ball screen. Defender calls it, goes under hard, re-squares chest in front.",
    standards:["Call screen early","Go under with urgency","No chasing over top","Re-square in front"],
    coachShort:"WHY: screens create easy shots.\nDO: early call + under hard.\nCONSEQUENCE: chasing = open looks.",
    coachExpand:"Shortcut path. Talk: 'SCREEN!' 'UNDER!'\nLate call = restart rep."
  }),
  mkDrill({
    id:"adv_34",
    title:"3v2 Advantage Reads (Rotate)",
    cat:"Offense",
    band:"3–4",
    tags:["decision","spacing"],
    steps:"3 attack vs 2. Quick reads: layup, kick, extra. Rotate defenders every rep.",
    standards:["First two passes on time","No dribble into traffic","Finish strong","Spacing: fill/replace"],
    coachShort:"WHY: punish advantage fast.\nDO: attack gaps.\nCONSEQUENCE: slow reads = turnovers.",
    coachExpand:"Drive-kick-swing. No standing.\nAfter pass: cut or fill."
  }),

  // 5–6
  mkDrill({
    id:"comp_56",
    title:"3v3 Continuous (Stop = Point)",
    cat:"Team",
    band:"5–6",
    tags:["compete","boxout","talk"],
    steps:"3v3. Defense scores with stop + rebound. Offense scores with bucket. Winner stays. High pace.",
    standards:["Box out every shot","Talk every possession","No jogging between games","Make layups"],
    coachShort:"WHY: competition exposes habits.\nDO: earn stops.\nCONSEQUENCE: soft = lose.",
    coachExpand:"Constraints: no middle drives; paint touch before 3.\nShort shot clock = pace."
  }),
  mkDrill({
    id:"press_221",
    title:"2–2–1 Press Rotations (5–6)",
    cat:"Press",
    band:"5–6",
    tags:["2-2-1","angles","discipline"],
    steps:"Walk → jog rotations: trap zones, middle safety, sprint recover. Then live 70–80%.",
    standards:["Sprint into trap spots","Hands high in trap","Middle safety disciplined","No gambling out of shape"],
    coachShort:"WHY: press is positioning.\nDO: arrive on time.\nCONSEQUENCE: middle = layup.",
    coachExpand:"Talk: 'TRAP!' 'MIDDLE!' 'I GOT BACK!'\nDiscipline > steals."
  }),
  mkDrill({
    id:"press_122",
    title:"1–2–2 Press Reads (5–6)",
    cat:"Press",
    band:"5–6",
    tags:["1-2-2","force-sideline"],
    steps:"Set 1–2–2. Work steering to sideline and closing gaps. Live max 4 passes.",
    standards:["Force sideline","No straight-line middle","Back line talks nonstop","Recover to matchups"],
    coachShort:"WHY: press sets your defense.\nDO: force where you want.\nCONSEQUENCE: middle breaks press.",
    coachExpand:"Keep reps short.\nIf gamble loses shape—stop immediately."
  }),
  mkDrill({
    id:"charge_56",
    title:"Charge Circle + Recover",
    cat:"Defense",
    band:"5–6",
    tags:["charges","help","recover"],
    steps:"Drive from wing. Help steps up early, shows charge, then immediate recover to shooter.",
    standards:["Arrive early","Chest up, protect face","Pop up fast","Recover under control"],
    coachShort:"WHY: charges change games.\nDO: step up early.\nCONSEQUENCE: late help = layup/foul.",
    coachExpand:"Timing: step up on first downhill step.\nRecover on air time."
  }),
  mkDrill({
    id:"cond_56",
    title:"NFHS Game-Clock Conditioning (5–6)",
    cat:"Conditioning",
    band:"5–6",
    tags:["nfhs","pace","toughness"],
    steps:"2-minute ‘game’: 20s burst / 20s jog / 20s burst / 20s walk. Repeat 4 rounds. Add ball last round.",
    standards:["Bursts are 100%","No hands on knees","Talk through fatigue","Last round best round"],
    coachShort:"WHY: win late.\nDO: full bursts.\nCONSEQUENCE: tired teams foul + turn it over.",
    coachExpand:"If anyone coasts: restart that round.\nHold the standard."
  }),
];

/* Expand base drills into a “drill pool” with variants */
function buildVariantPool(){
  const pool = [];
  for (const d of DRILLS){
    pool.push({ ...d, vid:d.id, vlabel:"Base" });
    for (const v of VARIANTS){
      // Don’t variant conditioning too much
      if (d.cat==="Conditioning" && (v.suffix.includes("Shot Clock") || v.suffix.includes("2-Dribble"))) continue;
      const vd = v.apply(d);
      pool.push({ ...vd, title: d.title + v.suffix, vid: d.id + "|" + v.suffix, vlabel:v.suffix.trim() });
    }
  }
  return pool;
}
const DRILL_POOL = buildVariantPool();

/* =========================================================
   HISTORY / ANTI-REPEAT
========================================================= */
function getHistory(){ return load(K.history, {}); } // vid -> lastUsedTs
function setHistory(h){ save(K.history, h); }
function markUsed(vid){
  const h = getHistory();
  h[vid] = now();
  setHistory(h);
}
function recentlyUsedSet(limit=8){
  const h = getHistory();
  const entries = Object.entries(h).sort((a,b)=>b[1]-a[1]).slice(0,limit);
  return new Set(entries.map(e=>e[0]));
}

/* =========================================================
   LOGS (standards missed)
========================================================= */
function getLogs(){ return load(K.logs, []); }
function setLogs(v){ save(K.logs, v); }

/* =========================================================
   PLAN
========================================================= */
function getPlan(){ return load(K.plan, null); }
function setPlan(v){ save(K.plan, v); }

/* =========================================================
   SETTINGS
========================================================= */
function getSettings(){ return load(K.settings, { emphasis:[], hardMode:true }); }
function setSettings(v){ save(K.settings, v); }

/* =========================================================
   SMART NEEDS (7d)
========================================================= */
function logsLastNDays(days=7){
  const cutoff = now() - days*24*60*60*1000;
  return getLogs().filter(l => l.ts >= cutoff);
}
function teamNeed7d(){
  const logs = logsLastNDays(7);
  if (!logs.length) return { cat:"Defense", count:0 };
  const counts = {};
  for (const l of logs){
    counts[l.cat] = (counts[l.cat]||0) + (l.players?.length||0);
  }
  // only show emphasis categories
  let best = { cat:"Defense", count:-1 };
  for (const c of EMPHASIS){
    const v = counts[c] || 0;
    if (v > best.count) best = { cat:c, count:v };
  }
  return best;
}

/* =========================================================
   BUILDER (minutes + attendance + needs + rotation)
========================================================= */
function normalizeCat(cat){
  if (!cat) return "Team";
  if (cat==="Skill") return "Offense"; // treat skills as offense emphasis
  return cat;
}

function pickPlanBlocks(minutes, presentCount, emphasisLocked, focusText){
  const band = bandFor(presentCount);
  const [minP,maxP] = bandMinMax(band);

  const need = teamNeed7d().cat;

  // Desired block count scales with minutes (keeps it readable)
  const blockCount = minutes <= 45 ? 5 : minutes <= 70 ? 6 : minutes <= 95 ? 7 : 8;

  // Required slots (hard standards):
  // - 1 warmup / skill
  // - 1 defense habit
  // - 1 rebounding (if you’re a “trad values” team, we keep it high)
  // - 1 conditioning
  // - 1 compete/team (if enough players; else competitive 1v1/2v2)
  const required = [];
  required.push({ want:["Skill","Shooting","Offense"], label:"Warm/Skill" });
  required.push({ want:["Defense"], label:"Defense" });
  required.push({ want:["Rebounding"], label:"Rebounding" });
  required.push({ want:["Conditioning"], label:"Conditioning" });
  required.push({ want:["Team","Press","Defense","Offense"], label:"Compete/Team" });

  // Allowed categories based on emphasis
  const allowedCats = emphasisLocked?.length ? emphasisLocked.slice() : EMPHASIS.slice();
  // Always allow Conditioning + Rebounding (standards)
  if (!allowedCats.includes("Conditioning")) allowedCats.push("Conditioning");
  if (!allowedCats.includes("Rebounding")) allowedCats.push("Rebounding");

  // Filter drill pool by band + emphasis
  const pool = DRILL_POOL
    .filter(d => d.band===band)
    .filter(d => {
      const cat = normalizeCat(d.cat);
      return allowedCats.includes(cat) || d.cat==="Team" || d.cat==="Skill";
    });

  const recent = recentlyUsedSet(10);

  // Score function: prioritize need, avoid recent, and rotate categories
  const catCounts = {};
  function scoreDrill(d){
    const cat = normalizeCat(d.cat);
    const recPenalty = recent.has(d.vid) ? -2.2 : 0;
    const needBonus = (cat===need) ? 1.6 : 0;
    const focusBonus = focusText ? (d.title.toLowerCase().includes(focusText.toLowerCase()) ? 0.8 : 0) : 0;
    const varietyPenalty = (catCounts[cat]||0) * -0.55; // discourage same-cat spam
    const jitter = (Math.random()*0.6)-0.3;
    return 1 + needBonus + focusBonus + recPenalty + varietyPenalty + jitter;
  }

  const chosen = [];
  const usedVid = new Set();

  function pickFromWants(wants){
    const candidates = pool
      .filter(d => wants.includes(d.cat) || wants.includes(normalizeCat(d.cat)))
      .filter(d => !usedVid.has(d.vid));

    if (!candidates.length) return null;

    let best = null, bestScore = -Infinity;
    for (const d of candidates){
      const s = scoreDrill(d);
      if (s > bestScore){ bestScore = s; best = d; }
    }
    if (!best) return null;
    const cat = normalizeCat(best.cat);
    catCounts[cat] = (catCounts[cat]||0)+1;
    usedVid.add(best.vid);
    chosen.push(best);
    return best;
  }

  // Pick required blocks first
  for (const r of required){
    if (chosen.length >= blockCount) break;
    pickFromWants(r.want);
  }

  // Fill remaining blocks: rotate across allowedCats and include Press sometimes
  while (chosen.length < blockCount){
    const wantCat = allowedCats[(chosen.length + Math.floor(Math.random()*allowedCats.length)) % allowedCats.length];
    const candidates = pool
      .filter(d => normalizeCat(d.cat)===wantCat || (wantCat==="Offense" && d.cat==="Skill"))
      .filter(d => !usedVid.has(d.vid));

    if (!candidates.length){
      // fallback: any not used
      const any = pool.filter(d => !usedVid.has(d.vid));
      if (!any.length) break;
      const d = any[Math.floor(Math.random()*any.length)];
      usedVid.add(d.vid);
      chosen.push(d);
      catCounts[normalizeCat(d.cat)] = (catCounts[normalizeCat(d.cat)]||0)+1;
      continue;
    }

    let best = null, bestScore = -Infinity;
    for (const d of candidates){
      const s = scoreDrill(d);
      if (s > bestScore){ bestScore = s; best = d; }
    }
    if (!best) break;
    usedVid.add(best.vid);
    chosen.push(best);
    catCounts[normalizeCat(best.cat)] = (catCounts[normalizeCat(best.cat)]||0)+1;
  }

  // Assign minutes across blocks: warm+core+cond+wrap
  // Keep it simple + consistent
  const warm = minutes <= 60 ? 8 : 10;
  const cool = 6;
  const condIdx = chosen.findIndex(d => normalizeCat(d.cat)==="Conditioning");
  const cond = minutes <= 60 ? 8 : 10;

  const coreMinutes = minutes - warm - cool - cond;
  const coreBlocks = chosen.length - 3; // warm, cond, cool
  const each = Math.max(6, Math.floor(coreMinutes / Math.max(1, coreBlocks)));
  let leftover = coreMinutes - each*Math.max(1, coreBlocks);

  const blocks = [];
  for (let i=0;i<chosen.length;i++){
    let mins = each;
    if (i===0) mins = warm;
    if (i===chosen.length-1) mins = cool;
    if (i===condIdx) mins = cond;
    if (i!==0 && i!==condIdx && i!==chosen.length-1){
      if (leftover > 0){ mins += 1; leftover -= 1; }
    }
    blocks.push({
      idx:i,
      vid: chosen[i].vid,
      baseId: chosen[i].id,
      title: chosen[i].title,
      cat: normalizeCat(chosen[i].cat),
      band,
      tags: chosen[i].tags || [],
      mins,
      steps: chosen[i].steps,
      standards: chosen[i].standards,
      coachShort: chosen[i].coachShort,
      coachExpand: chosen[i].coachExpand
    });
  }

  // Normalize total minutes
  const sum = blocks.reduce((a,b)=>a+b.mins,0);
  const diff = minutes - sum;
  if (blocks.length) blocks[blocks.length-1].mins += diff;

  return { band, need, blocks };
}

/* =========================================================
   UI STATE (log selection + run state)
========================================================= */
let ui = {
  tab:"home",
  logSelectedVid:null,
  logSelectedPlayers:new Set(),
  runIndex:0,
  runTimer: { running:false, endTs:0, remainSec:0, interval:null }
};

/* =========================================================
   NAV
========================================================= */
function go(tab){
  ui.tab = tab;
  const tabs = ["home","roster","build","plan","run","log","progress","reports"];
  for (const t of tabs){
    const s = document.getElementById("sec-"+t);
    if (s) s.classList.toggle("active", t===tab);
  }
  // nav buttons (bottom only has 6)
  const navs = ["home","roster","build","plan","run","progress"];
  for (const n of navs){
    const b = document.getElementById("nav-"+n);
    if (b) b.classList.toggle("active", n===tab);
  }
  // special: reports lives under progress mentally (no bottom button)
  if (tab==="reports"){
    document.getElementById("nav-progress")?.classList.add("active");
    document.getElementById("nav-home")?.classList.remove("active");
    document.getElementById("nav-roster")?.classList.remove("active");
    document.getElementById("nav-build")?.classList.remove("active");
    document.getElementById("nav-plan")?.classList.remove("active");
    document.getElementById("nav-run")?.classList.remove("active");
  }
  if (tab==="plan") renderPlan();
  if (tab==="run") renderRun();
  if (tab==="log") renderLogUI();
  if (tab==="progress") renderProgress();
  if (tab==="reports") initReportsUI();
  renderHomeHeaderLine();
}

/* =========================================================
   HOME
========================================================= */
function renderHomeHeaderLine(){
  const roster = getRoster();
  const presentCount = getPresent().length;
  const band = bandFor(presentCount);
  const need = teamNeed7d();
  const logs7 = logsLastNDays(7);
  const plan = getPlan();

  document.getElementById("homePresent").textContent = String(presentCount);
  document.getElementById("tagBand").textContent = "Band: " + band;
  document.getElementById("tagNeed").textContent = "Need: " + (need.count>0 ? (need.cat+" ("+need.count+")") : "Auto");
  document.getElementById("homeLogs").textContent = String(logs7.length);
  document.getElementById("homeLastPlan").textContent = plan?.meta?.focus ? plan.meta.focus : (plan ? "Built" : "None");

  const line = [
    `Present ${presentCount} (${band})`,
    `Roster ${roster.length}`,
    `Need: ${need.cat}`,
    plan ? `Plan: ${new Date(plan.meta.date).toLocaleDateString()}` : "Plan: none"
  ].join(" • ");
  document.getElementById("homeLine").textContent = line;
}

/* =========================================================
   ROSTER UI
========================================================= */
function renderRoster(){
  const roster = getRoster();
  const present = new Set(getPresent());
  const wrap = document.getElementById("rosterList");
  wrap.innerHTML = "";

  if (!roster.length){
    wrap.innerHTML = `<div class="card"><div class="muted">No players yet. Add your guys.</div></div>`;
    return;
  }

  for (const p of roster){
    const isHere = present.has(p.id);
    const item = document.createElement("div");
    item.className = "item";
    item.innerHTML = `
      <div class="left">
        <div class="name">${escapeHtml(p.name)} <span class="muted mono" style="font-size:11px">#${escapeHtml(p.number||"--")} • ${escapeHtml(p.pos||"—")}</span></div>
        <div class="meta">${escapeHtml(p.notes||"")}</div>
      </div>
      <div class="right">
        <button class="btn ${isHere?'good':''}" data-act="here">${isHere ? "Here ✓" : "Mark Here"}</button>
        <button class="btn" data-act="edit">Edit</button>
        <button class="btn bad" data-act="del">Delete</button>
      </div>
    `;
    item.querySelector('[data-act="here"]').onclick = ()=>togglePresent(p.id);
    item.querySelector('[data-act="edit"]').onclick = ()=>openPlayerModal(p.id);
    item.querySelector('[data-act="del"]').onclick = ()=>deletePlayer(p.id);
    wrap.appendChild(item);
  }
}

function deletePlayer(pid){
  if (!confirm("Delete this player?")) return;
  const roster = getRoster().filter(p=>p.id!==pid);
  setRoster(roster);
  const present = new Set(getPresent());
  present.delete(pid);
  setPresent([...present]);
  renderAll();
}

/* Player modal */
function openPlayerModal(pid=null){
  const roster = getRoster();
  const p = pid ? roster.find(x=>x.id===pid) : null;

  openModal(
    pid ? "Edit Player" : "Add Player",
    "Keep it simple. You can add detail later.",
    `
    <div class="grid2">
      <div>
        <div class="muted">Name</div>
        <input id="pmName" class="input" value="${p ? escapeHtml(p.name) : ""}" placeholder="Quin Coykendal"/>
      </div>
      <div>
        <div class="muted">Number</div>
        <input id="pmNum" class="input" value="${p ? escapeHtml(p.number||"") : ""}" placeholder="23"/>
      </div>
    </div>
    <div class="grid2" style="margin-top:10px">
      <div>
        <div class="muted">Position</div>
        <select id="pmPos">
          ${["G","W","F","C"].map(pos => `<option value="${pos}" ${p?.pos===pos ? "selected":""}>${pos}</option>`).join("")}
        </select>
      </div>
      <div>
        <div class="muted">Notes</div>
        <input id="pmNotes" class="input" value="${p ? escapeHtml(p.notes||"") : ""}" placeholder="Needs help-side talk / strong rebounder"/>
      </div>
    </div>
    <div style="display:flex; gap:8px; justify-content:flex-end; margin-top:12px">
      <button class="btn" onclick="closeModal()">Cancel</button>
      <button class="btn primary" onclick="savePlayer('${pid||""}')">Save</button>
    </div>
    `
  );
}
function savePlayer(pidStr){
  const pid = pidStr || null;
  const name = (document.getElementById("pmName").value||"").trim();
  if (!name){ alert("Name required."); return; }
  const number = (document.getElementById("pmNum").value||"").trim();
  const pos = document.getElementById("pmPos").value;
  const notes = (document.getElementById("pmNotes").value||"").trim();

  const roster = getRoster();
  if (pid){
    const idx = roster.findIndex(p=>p.id===pid);
    if (idx>=0) roster[idx] = { ...roster[idx], name, number, pos, notes };
  } else {
    roster.push({ id:uid(), name, number, pos, notes });
  }
  setRoster(roster);
  closeModal();
  renderAll();
}

/* =========================================================
   BUILD UI
========================================================= */
function renderBuildUI(){
  // emphasis chips
  const settings = getSettings();
  const wrap = document.getElementById("emphasisChips");
  wrap.innerHTML = "";
  for (const e of EMPHASIS){
    const chip = document.createElement("div");
    chip.className = "chip " + (settings.emphasis.includes(e) ? "on" : "");
    chip.textContent = e;
    chip.onclick = ()=>{
      const s = getSettings();
      const set = new Set(s.emphasis);
      if (set.has(e)) set.delete(e); else set.add(e);
      s.emphasis = [...set];
      setSettings(s);
      renderBuildUI();
    };
    wrap.appendChild(chip);
  }

  // present chips
  const roster = getRoster();
  const presentSet = new Set(getPresent());
  const pwrap = document.getElementById("presentChips");
  pwrap.innerHTML = "";
  if (!roster.length){
    pwrap.innerHTML = `<div class="muted">Add players in Roster first.</div>`;
  } else {
    for (const p of roster){
      const on = presentSet.has(p.id);
      const chip = document.createElement("div");
      chip.className = "chip present " + (on ? "on":"");
      chip.textContent = on ? (p.name+" ✓") : p.name;
      chip.onclick = ()=>togglePresent(p.id);
      pwrap.appendChild(chip);
    }
  }

  const plan = getPlan();
  document.getElementById("buildMeta").textContent = plan ? (plan.meta.signature || "Built") : "—";
}

function buildPractice(regen){
  const roster = getRoster();
  const present = getPresent();
  if (!roster.length){
    alert("Add players first.");
    go("roster");
    return;
  }
  if (!present.length){
    alert("Mark who's here today (Roster or Present chips).");
    go("roster");
    return;
  }

  const minutes = clamp(parseInt(document.getElementById("inpMinutes").value || "90",10), 30, 150);
  const focus = (document.getElementById("inpFocus").value || "").trim();

  const settings = getSettings();
  const emphasis = settings.emphasis;

  // If not regen, still build; regen just forces stronger anti-repeat by marking recent set bigger
  const { band, need, blocks } = pickPlanBlocks(minutes, present.length, emphasis, focus);

  // Mark used to avoid same spam next regen
  for (const b of blocks){
    markUsed(b.vid);
  }

  const signature = [
    `Date=${new Date().toISOString()}`,
    `Min=${minutes}`,
    `Present=${present.length}`,
    `Band=${band}`,
    `Need=${need}`,
    `Emphasis=${emphasis.length?emphasis.join(","):"Auto"}`,
    `Focus=${focus||"Auto"}`,
    `Blocks=${blocks.map(x=>x.title).join(" | ")}`
  ].join(" • ");

  setPlan({
    meta:{
      id:uid(),
      date:Date.now(),
      minutes,
      presentIds: present.slice(),
      band,
      need,
      focus: focus || (need ? (need+" Focus") : "Auto"),
      emphasis: emphasis.slice(),
      signature
    },
    blocks
  });

  document.getElementById("inpMinutes").value = String(minutes);
  renderAll();
  go("plan");
}

/* =========================================================
   PLAN UI
========================================================= */
function renderPlan(){
  const plan = getPlan();
  const wrap = document.getElementById("planList");
  wrap.innerHTML = "";

  if (!plan || !plan.blocks?.length){
    document.getElementById("planHeader").textContent = "No plan built yet.";
    wrap.innerHTML = `<div class="card"><div class="muted">Go to Build → BUILD.</div></div>`;
    return;
  }

  const roster = getRoster();
  const present = new Set(plan.meta.presentIds || []);
  const presentNames = roster.filter(p=>present.has(p.id)).map(p=>p.name).join(", ");

  document.getElementById("planHeader").textContent =
    `Band ${plan.meta.band} • ${plan.meta.minutes} min • Need: ${plan.meta.need} • Present: ${presentNames || (plan.meta.presentIds?.length||0)}`;

  plan.blocks.forEach((b,i)=>{
    const item = document.createElement("div");
    item.className = "item";
    item.innerHTML = `
      <div class="left">
        <div class="name">${i+1}. ${escapeHtml(b.title)}</div>
        <div class="meta">
          <span class="tag blue">${escapeHtml(b.cat)}</span>
          <span class="tag warn">${b.mins} min</span>
          <span class="tag good">Band ${escapeHtml(b.band)}</span>
        </div>
        <div class="meta" style="margin-top:6px">${escapeHtml(b.steps)}</div>
      </div>
      <div class="right">
        <button class="btn" data-act="explain">Explain</button>
        <button class="btn bad" data-act="log">Log</button>
      </div>
    `;
    item.querySelector('[data-act="explain"]').onclick = ()=>openExplainForBlock(i);
    item.querySelector('[data-act="log"]').onclick = ()=>{
      ui.logSelectedVid = b.vid;
      go("log");
    };
    wrap.appendChild(item);
  });
}

/* =========================================================
   RUN PRACTICE UI + TIMER
========================================================= */
function getActiveBlock(){
  const plan = getPlan();
  if (!plan?.blocks?.length) return null;
  const idx = clamp(ui.runIndex, 0, plan.blocks.length-1);
  return { plan, block: plan.blocks[idx], idx };
}
function renderRun(){
  const plan = getPlan();
  if (!plan?.blocks?.length){
    document.getElementById("runMeta").textContent = "No plan built. Build one first.";
    document.getElementById("runTitle").textContent = "—";
    document.getElementById("runSub").textContent = "—";
    document.getElementById("runTags").innerHTML = "";
    document.getElementById("runStandards").innerHTML = "";
    document.getElementById("runStep").textContent = "Drill 0/0";
    document.getElementById("runMinutesTag").textContent = "0 min";
    document.getElementById("runBandTag").textContent = "Band —";
    setTimerDisplay(0);
    renderPrompts();
    return;
  }

  ui.runIndex = clamp(ui.runIndex, 0, plan.blocks.length-1);
  const b = plan.blocks[ui.runIndex];

  document.getElementById("runMeta").textContent = `Band ${plan.meta.band} • ${plan.meta.minutes} min • Need: ${plan.meta.need}`;
  document.getElementById("runStep").textContent = `Drill ${ui.runIndex+1}/${plan.blocks.length}`;
  document.getElementById("runTitle").textContent = b.title;
  document.getElementById("runSub").textContent = b.steps;
  document.getElementById("runMinutesTag").textContent = `${b.mins} min`;
  document.getElementById("runBandTag").textContent = `Band ${b.band}`;

  const tagsWrap = document.getElementById("runTags");
  tagsWrap.innerHTML = "";
  tagsWrap.appendChild(tagEl(b.cat, "blue"));
  (b.tags||[]).slice(0,3).forEach(t=>tagsWrap.appendChild(tagEl("#"+t, "")));

  const ul = document.getElementById("runStandards");
  ul.innerHTML = "";
  (b.standards||[]).forEach(s=>{
    const li = document.createElement("li");
    li.textContent = s;
    ul.appendChild(li);
  });

  // reset timer to block minutes (only if not running)
  if (!ui.runTimer.running){
    setTimerDisplay(b.mins*60);
    ui.runTimer.remainSec = b.mins*60;
  }

  renderPrompts();
}
function tagEl(text, cls){
  const sp = document.createElement("span");
  sp.className = "tag " + cls;
  sp.textContent = text;
  return sp;
}

function runNext(){
  const plan = getPlan();
  if (!plan?.blocks?.length) return;
  ui.runIndex = clamp(ui.runIndex+1, 0, plan.blocks.length-1);
  stopTimer();
  renderRun();
}
function runPrev(){
  const plan = getPlan();
  if (!plan?.blocks?.length) return;
  ui.runIndex = clamp(ui.runIndex-1, 0, plan.blocks.length-1);
  stopTimer();
  renderRun();
}

function setTimerDisplay(sec){
  const s = Math.max(0, Math.floor(sec));
  const mm = String(Math.floor(s/60)).padStart(2,"0");
  const ss = String(s%60).padStart(2,"0");
  document.getElementById("runTimer").textContent = `${mm}:${ss}`;
}

function toggleTimer(){
  if (ui.runTimer.running) stopTimer();
  else startTimer();
}
function startTimer(){
  const active = getActiveBlock();
  if (!active) return;

  // if remainSec is 0, reset to block minutes
  if (!ui.runTimer.remainSec || ui.runTimer.remainSec<=0){
    ui.runTimer.remainSec = active.block.mins*60;
  }
  ui.runTimer.running = true;
  document.getElementById("timerBtnText").textContent = "Pause";

  ui.runTimer.interval = setInterval(()=>{
    ui.runTimer.remainSec -= 1;
    setTimerDisplay(ui.runTimer.remainSec);
    if (ui.runTimer.remainSec <= 0){
      stopTimer();
      // auto advance (optional) — keep it on but safe
      // runNext();
    }
  }, 1000);
}
function stopTimer(){
  ui.runTimer.running = false;
  document.getElementById("timerBtnText").textContent = "Start";
  if (ui.runTimer.interval) clearInterval(ui.runTimer.interval);
  ui.runTimer.interval = null;
}
function openExplain(){
  const active = getActiveBlock();
  if (!active) return;
  openExplainForBlock(active.idx);
}
function openExplainForBlock(idx){
  const plan = getPlan();
  if (!plan?.blocks?.length) return;
  const b = plan.blocks[idx];

  const standards = (b.standards||[]).map(s=>`<li>${escapeHtml(s)}</li>`).join("");
  openModal(
    b.title,
    `${b.cat} • ${b.mins} min • Band ${b.band}`,
    `
      <div class="card" style="background:rgba(255,255,255,.03); box-shadow:none">
        <div class="muted">How to run it</div>
        <div style="margin-top:8px">${escapeHtml(b.steps)}</div>
      </div>

      <div class="card" style="background:rgba(255,255,255,.03); box-shadow:none; margin-top:10px">
        <div class="muted">Standards (non-negotiable)</div>
        <ul style="margin:8px 0 0 18px">${standards}</ul>
      </div>

      <div class="card" style="background:rgba(255,255,255,.03); box-shadow:none; margin-top:10px">
        <div class="muted">Coach Script (fast)</div>
        <div style="white-space:pre-line; margin-top:8px">${escapeHtml(b.coachShort||"")}</div>
        <div class="divider"></div>
        <div class="muted">Expand</div>
        <div style="white-space:pre-line; margin-top:8px">${escapeHtml(b.coachExpand||"")}</div>
      </div>
    `
  );
}

/* Quick log from Run screen */
function openQuickLog(){
  const active = getActiveBlock();
  if (!active) return;
  ui.logSelectedVid = active.block.vid;
  go("log");
}

/* =========================================================
   LOG UI
========================================================= */
function renderLogUI(){
  const plan = getPlan();
  const drillWrap = document.getElementById("logDrillChips");
  const playerWrap = document.getElementById("logPlayerChips");
  const sel = document.getElementById("selStandard");

  drillWrap.innerHTML = "";
  playerWrap.innerHTML = "";

  if (!plan?.blocks?.length){
    drillWrap.innerHTML = `<div class="muted">No plan. Build a plan first.</div>`;
    playerWrap.innerHTML = `<div class="muted">—</div>`;
    sel.innerHTML = `<option>General miss</option>`;
    return;
  }

  // drill chips
  for (const b of plan.blocks){
    const chip = document.createElement("div");
    chip.className = "chip " + (ui.logSelectedVid===b.vid ? "on" : "");
    chip.textContent = b.title;
    chip.onclick = ()=>{
      ui.logSelectedVid = b.vid;
      ui.logSelectedPlayers = new Set();
      renderLogUI();
    };
    drillWrap.appendChild(chip);
  }

  // players present
  const roster = getRoster();
  const presentSet = new Set(plan.meta.presentIds || getPresent());
  const presentPlayers = roster.filter(p=>presentSet.has(p.id));
  if (!presentPlayers.length){
    playerWrap.innerHTML = `<div class="muted">No present players set.</div>`;
  } else {
    presentPlayers.forEach(p=>{
      const on = ui.logSelectedPlayers.has(p.id);
      const chip = document.createElement("div");
      chip.className = "chip bad " + (on ? "on" : "");
      chip.textContent = p.name;
      chip.onclick = ()=>{
        if (ui.logSelectedPlayers.has(p.id)) ui.logSelectedPlayers.delete(p.id);
        else ui.logSelectedPlayers.add(p.id);
        renderLogUI();
      };
      playerWrap.appendChild(chip);
    });
  }

  // standards list based on selected drill
  const b = plan.blocks.find(x=>x.vid===ui.logSelectedVid) || plan.blocks[0];
  sel.innerHTML = "";
  sel.appendChild(new Option("General miss", "General miss"));
  (b.standards||[]).forEach(s => sel.appendChild(new Option(s, s)));

  renderRecentLogs();
}

function clearLogSelection(){
  ui.logSelectedPlayers = new Set();
  document.getElementById("selStandard").value = "General miss";
  renderLogUI();
}

function saveLog(){
  const plan = getPlan();
  if (!plan?.blocks?.length){ alert("Build a plan first."); return; }

  const vid = ui.logSelectedVid || plan.blocks[0].vid;
  const b = plan.blocks.find(x=>x.vid===vid) || plan.blocks[0];

  const players = [...ui.logSelectedPlayers];
  if (!players.length){
    alert("Select who missed the standard.");
    return;
  }

  const standard = document.getElementById("selStandard").value || "General miss";
  const roster = getRoster();
  const playerNames = players.map(pid => roster.find(p=>p.id===pid)?.name || pid);

  const entry = {
    id:uid(),
    ts:Date.now(),
    planId:plan.meta.id,
    vid:b.vid,
    drillTitle:b.title,
    cat:b.cat,
    standard,
    players,
    playerNames
  };

  const logs = getLogs();
  logs.push(entry);
  setLogs(logs);

  // clear selection fast
  ui.logSelectedPlayers = new Set();
  renderRecentLogs();
  renderHomeHeaderLine();
  refreshPrompts();
}

function renderRecentLogs(){
  const wrap = document.getElementById("recentLogs");
  const logs = getLogs().slice(-10).reverse();
  wrap.innerHTML = "";
  if (!logs.length){
    wrap.innerHTML = `<div class="card"><div class="muted">No logs yet.</div></div>`;
    return;
  }
  logs.forEach(l=>{
    const item = document.createElement("div");
    item.className = "item";
    item.innerHTML = `
      <div class="left">
        <div class="name">${escapeHtml(l.cat)} • ${escapeHtml(l.drillTitle)}</div>
        <div class="meta">${escapeHtml(l.standard)} • ${escapeHtml(fmtDate(l.ts))}</div>
        <div class="meta">Missed: <span class="mono">${escapeHtml((l.playerNames||[]).join(", "))}</span></div>
      </div>
      <div class="right">
        <button class="btn bad">Undo</button>
      </div>
    `;
    item.querySelector("button").onclick = ()=>{
      if (!confirm("Delete this log?")) return;
      const all = getLogs().filter(x=>x.id!==l.id);
      setLogs(all);
      renderRecentLogs();
      renderAll();
    };
    wrap.appendChild(item);
  });
}

/* =========================================================
   COACH ASSISTANT PROMPTS (based on today logs)
========================================================= */
function promptsFromToday(){
  const plan = getPlan();
  if (!plan) return [];
  const logs = getLogs().filter(l=>l.planId===plan.meta.id);
  if (!logs.length) return [];

  // count by standard + cat
  const count = {};
  for (const l of logs){
    const key = `${l.cat}||${l.standard}`;
    count[key] = (count[key]||0) + (l.players?.length||0);
  }
  const top = Object.entries(count).sort((a,b)=>b[1]-a[1]).slice(0,4);

  return top.map(([k,v])=>{
    const [cat, std] = k.split("||");
    return {
      title:`${cat}: ${std}`,
      text:`Logged ${v} misses today. Hit it immediately: teach fast → rep hard → restart sloppy reps.`
    };
  });
}
function renderPrompts(){
  const wrap = document.getElementById("promptList");
  wrap.innerHTML = "";
  const ps = promptsFromToday();
  if (!ps.length){
    wrap.innerHTML = `<div class="card" style="background:rgba(255,255,255,.03); box-shadow:none"><div class="muted">No prompts yet. Log misses to get live coaching reminders.</div></div>`;
    return;
  }
  ps.forEach(p=>{
    const item = document.createElement("div");
    item.className = "item";
    item.innerHTML = `
      <div class="left">
        <div class="name">${escapeHtml(p.title)}</div>
        <div class="meta">${escapeHtml(p.text)}</div>
      </div>
      <div class="right">
        <button class="btn">Explain</button>
      </div>
    `;
    item.querySelector("button").onclick = ()=>{
      openAskCoach(p.title);
    };
    wrap.appendChild(item);
  });
}
function refreshPrompts(){ renderPrompts(); }

/* =========================================================
   ASK COACH (offline templates)
========================================================= */
function openAskCoach(seed=""){
  const prompt = seed ? `Give me a fast coach explanation for: ${seed}` : "";
  openModal(
    "Ask Coach",
    "Offline coach brain. Fast + blunt. Expand at end.",
    `
      <div class="muted">Question</div>
      <input id="acQ" class="input" placeholder="Ex: Explain help-side defense to a freshman." value="${escapeHtml(prompt)}"/>
      <div style="display:flex; gap:8px; justify-content:flex-end; margin-top:10px">
        <button class="btn primary" onclick="answerCoach()">Answer</button>
      </div>
      <div class="divider"></div>
      <div class="muted">Answer</div>
      <div id="acA" class="card" style="background:rgba(255,255,255,.03); box-shadow:none; margin-top:8px; white-space:pre-line">—</div>
    `
  );
}
function answerCoach(){
  const q = (document.getElementById("acQ").value||"").toLowerCase();
  let short = "";
  let expand = "";
  const footer = "\n\nExpand: Teach it in 10 seconds, then REP it at game speed. Sloppy reps don’t count.";

  if (q.includes("help")){
    short =
`WHY: Stops layups.
DO: Feet in the paint early, chest up, then recover on air time.
CONSEQUENCE: Late help = layup or foul.`;
    expand =
`CUES:
- “FEET IN PAINT!” (help side)
- “I GOT BALL!” then “RECOVER!”
- Help the helper. Bump cutters.

FIX:
- If you’re watching the ball, you’re wrong.
- If you help late, you’re already beat.`;
  } else if (q.includes("closeout")){
    short =
`WHY: Takes away open shots.
DO: Sprint 2/3, chop last 1/3, hands high, no fly-by.
CONSEQUENCE: Fly-by = straight-line drive.`;
    expand =
`CUES:
- Arrive under control
- Force away from middle
- Feet beat hands (no reaching)

FIX:
- Fly-by? Restart rep.
- Stand tall? You’re late.`;
  } else if (q.includes("screen")){
    short =
`WHY: Screens create easy shots.
DO: Call it early, go UNDER with urgency, re-square.
CONSEQUENCE: Chasing = open looks.`;
    expand =
`CUES:
- “SCREEN!” early
- Shortcut path under
- Re-square chest in front

FIX:
- Late call → restart.
- Looping wide → tighten angle.`;
  } else if (q.includes("box") || q.includes("rebound")){
    short =
`WHY: Rebounds win games.
DO: Hit first, then pursue. Two hands. Chin it.
CONSEQUENCE: No box = second chance points.`;
    expand =
`CUES:
- “HIT!” then “GET!”
- Find body every shot
- Outlet fast (2 seconds)

FIX:
- Watching ball without contact = automatic fail.`;
  } else if (q.includes("press")){
    short =
`WHY: Press creates chaos on your terms.
DO: Force sideline, trap on time, safety protects middle.
CONSEQUENCE: Middle breaks your press = layups.`;
    expand =
`CUES:
- Sprint into trap spots
- Hands high
- Back line talks nonstop

FIX:
- Gambling out of shape? Stop it. Discipline > steals.`;
  } else {
    short =
`WHY: Winning details.
DO: Talk, box out, sprint between reps.
CONSEQUENCE: Lazy habits = losses.`;
    expand =
`PROGRAM DNA:
- No middle.
- Feet in paint help side.
- Under screens.
- Deny one pass away.
- Box hard.
- Conditioning is standards.`;
  }

  document.getElementById("acA").textContent = short + "\n\n" + expand + footer;
}

/* =========================================================
   PROGRESS (7d + all-time)
========================================================= */
function renderProgress(){
  const roster = getRoster();
  const wrap = document.getElementById("playerProgress");
  wrap.innerHTML = "";

  const logs7 = logsLastNDays(7);
  const all = getLogs();
  const need = teamNeed7d();

  document.getElementById("teamNeedsLine").textContent =
    `Most missed category: ${need.cat} (${need.count}) • Based on standards logs last 7 days.`;
  document.getElementById("teamNeedTag").textContent = need.cat;

  if (!roster.length){
    wrap.innerHTML = `<div class="card"><div class="muted">Add players first.</div></div>`;
    return;
  }

  function countsByPlayer(logs){
    const map = {}; // pid -> cat -> count
    for (const l of logs){
      for (const pid of (l.players||[])){
        map[pid] = map[pid] || {};
        map[pid][l.cat] = (map[pid][l.cat]||0) + 1;
      }
    }
    return map;
  }

  const w7 = countsByPlayer(logs7);
  const allC = countsByPlayer(all);

  roster.forEach(p=>{
    const a7 = w7[p.id] || {};
    const aa = allC[p.id] || {};

    const top7 = Object.entries(a7).sort((x,y)=>y[1]-x[1]).slice(0,3);
    const topA = Object.entries(aa).sort((x,y)=>y[1]-x[1]).slice(0,3);

    const item = document.createElement("div");
    item.className = "item";
    item.innerHTML = `
      <div class="left">
        <div class="name">${escapeHtml(p.name)} <span class="muted mono" style="font-size:11px">#${escapeHtml(p.number||"--")} • ${escapeHtml(p.pos||"—")}</span></div>
        <div class="meta">${escapeHtml(p.notes||"")}</div>
        <div class="meta" style="margin-top:8px">
          <span class="tag blue">7d</span>
          ${top7.length ? top7.map(([c,n])=>`<span class="tag">${escapeHtml(c)} (${n})</span>`).join(" ") : `<span class="tag">No misses logged</span>`}
        </div>
        <div class="meta" style="margin-top:6px">
          <span class="tag blue">All</span>
          ${topA.length ? topA.map(([c,n])=>`<span class="tag">${escapeHtml(c)} (${n})</span>`).join(" ") : `<span class="tag">No logs</span>`}
        </div>
      </div>
      <div class="right">
        <button class="btn" data-act="coach">Coach Cue</button>
        <button class="btn" data-act="logs">View Logs</button>
      </div>
    `;
    item.querySelector('[data-act="coach"]').onclick = ()=>{
      const focusCat = (top7[0]?.[0] || need.cat);
      openAskCoach(`Quick cue for ${p.name} to improve ${focusCat}`);
    };
    item.querySelector('[data-act="logs"]').onclick = ()=>{
      const last = all.filter(l => (l.players||[]).includes(p.id)).slice(-15).reverse();
      const lines = last.map(l=>`• ${new Date(l.ts).toLocaleDateString()} — ${l.cat} — ${l.standard} — ${l.drillTitle}`).join("\n");
      openModal(`${p.name} Logs`, "Last 15 misses", `<div class="card" style="background:rgba(255,255,255,.03); box-shadow:none; white-space:pre-line">${escapeHtml(lines || "No logs yet.")}</div>`);
    };
    wrap.appendChild(item);
  });
}

/* =========================================================
   REPORTS: 4 points/month weekly bucket + category charts
========================================================= */
function initReportsUI(){
  const monthInput = document.getElementById("repMonth");
  if (!monthInput.value){
    const d = new Date();
    monthInput.value = `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,"0")}`;
  }
  const who = document.getElementById("repWho");
  const roster = getRoster();
  who.innerHTML = "";
  who.appendChild(new Option("Team (all players)", "TEAM"));
  roster.forEach(p => who.appendChild(new Option(p.name, p.id)));
}

function monthRange(year, monthIdx0){
  const start = new Date(year, monthIdx0, 1, 0,0,0,0).getTime();
  const end = new Date(year, monthIdx0+1, 1, 0,0,0,0).getTime();
  return { start, end };
}
function monthWeeks4Buckets(ts, year, monthIdx0){
  // 4 equal-ish buckets across the month range
  const { start, end } = monthRange(year, monthIdx0);
  const span = end - start;
  const q = span / 4;
  if (ts < start || ts >= end) return null;
  const idx = Math.min(3, Math.floor((ts - start) / q));
  return idx; // 0..3
}

function colorForPlayer(pid, idx){
  // stable-ish palette
  const palette = ["#60a5fa","#3b82f6","#93c5fd","#2563eb","#1d4ed8","#7dd3fc","#38bdf8","#0ea5e9","#1e40af","#4f46e5"];
  if (pid==="TEAM") return "#60a5fa";
  const h = hashString(pid);
  return palette[h % palette.length];
}
function hashString(s){
  let h=0;
  for (let i=0;i<s.length;i++){ h = (h*31 + s.charCodeAt(i)) >>> 0; }
  return h;
}

function computeMonthlyScores(year, monthIdx0){
  // Score per player per category per bucket(0..3)
  // score = 100 - (misses / max(1, opportunities)) * 100
  const planLogs = getLogs().filter(l=>{
    const d = new Date(l.ts);
    return d.getFullYear()===year && d.getMonth()===monthIdx0;
  });

  const plansById = {}; // planId -> plan meta/blocks (only have current plan stored, so we approximate opportunities via logs by cat)
  // V1 approach (simple + works): opportunities = # of logs saved in that category that week OR at least 1 if any drill run.
  // This still gives meaningful trend lines for excellence (misses drive score down).

  const roster = getRoster();
  const players = roster.map(p=>p.id);

  const scores = {}; // pid -> cat -> [4]
  const misses = {}; // pid -> cat -> [4]
  const opps = {};   // pid -> cat -> [4]

  function ensure(pid, cat){
    scores[pid] = scores[pid] || {};
    misses[pid] = misses[pid] || {};
    opps[pid] = opps[pid] || {};
    if (!scores[pid][cat]) scores[pid][cat] = [100,100,100,100];
    if (!misses[pid][cat]) misses[pid][cat] = [0,0,0,0];
    if (!opps[pid][cat]) opps[pid][cat] = [0,0,0,0];
  }

  // count opps + misses from logs (fast)
  for (const l of planLogs){
    const b = monthWeeks4Buckets(l.ts, year, monthIdx0);
    if (b===null) continue;
    const cat = l.cat;
    for (const pid of (l.players||[])){
      ensure(pid, cat);
      misses[pid][cat][b] += 1;
      opps[pid][cat][b] += 1; // each logged miss implies an opportunity happened
    }
  }

  // also account for players with no misses: give them baseline opps=1 per bucket per category if they practiced that month
  // We'll infer "practiced" if ANY log exists for that player in that bucket, else leave blank baseline.
  for (const pid of players){
    for (const cat of EMPHASIS){
      ensure(pid, cat);
      for (let b=0;b<4;b++){
        // If no opps and no misses, keep 100 but don't fabricate opps.
        const m = misses[pid][cat][b];
        const o = opps[pid][cat][b];
        const denom = Math.max(1, o);
        const sc = clamp(Math.round(100 - (m/denom)*100), 0, 100);
        scores[pid][cat][b] = sc;
      }
    }
  }

  // TEAM aggregation (avg across players)
  const teamScores = {}; // cat -> [4]
  for (const cat of EMPHASIS){
    teamScores[cat] = [100,100,100,100];
    for (let b=0;b<4;b++){
      let sum=0, n=0;
      for (const pid of players){
        sum += (scores[pid]?.[cat]?.[b] ?? 100);
        n += 1;
      }
      teamScores[cat][b] = n ? Math.round(sum/n) : 100;
    }
  }

  return { scores, teamScores };
}

function drawLineChart(canvas, series, options){
  // series: [{label, color, points:[4]}]
  const ctx = canvas.getContext("2d");
  const W = canvas.width, H = canvas.height;
  ctx.clearRect(0,0,W,H);

  // background
  ctx.fillStyle = "rgba(255,255,255,0.01)";
  ctx.fillRect(0,0,W,H);

  const padL=42, padR=10, padT=14, padB=26;
  const x0=padL, y0=padT, x1=W-padR, y1=H-padB;
  const w=x1-x0, h=y1-y0;

  // grid
  ctx.strokeStyle = "rgba(234,241,255,0.08)";
  ctx.lineWidth = 1;
  for (let i=0;i<=4;i++){
    const y = y0 + (h*i/4);
    ctx.beginPath(); ctx.moveTo(x0,y); ctx.lineTo(x1,y); ctx.stroke();
  }

  // y labels (100,75,50,25,0)
  ctx.fillStyle="rgba(234,241,255,0.65)";
  ctx.font="11px ui-sans-serif, system-ui";
  const yVals=[100,75,50,25,0];
  yVals.forEach((v,i)=>{
    const y = y0 + (h*i/4);
    ctx.fillText(String(v), 8, y+4);
  });

  // x labels W1..W4
  const xLabels=["W1","W2","W3","W4"];
  xLabels.forEach((lab,i)=>{
    const x = x0 + (w*i/3);
    ctx.fillText(lab, x-10, H-8);
  });

  // series lines
  function xy(i, val){
    const x = x0 + (w*i/3);
    const y = y0 + (h*(1 - (val/100)));
    return {x,y};
  }

  for (const s of series){
    ctx.strokeStyle = s.color;
    ctx.lineWidth = 2;
    ctx.beginPath();
    s.points.forEach((v,i)=>{
      const p = xy(i,v);
      if (i===0) ctx.moveTo(p.x,p.y); else ctx.lineTo(p.x,p.y);
    });
    ctx.stroke();

    // points
    ctx.fillStyle = s.color;
    s.points.forEach((v,i)=>{
      const p = xy(i,v);
      ctx.beginPath(); ctx.arc(p.x,p.y,3,0,Math.PI*2); ctx.fill();
    });
  }

  // title
  if (options?.title){
    ctx.fillStyle="rgba(234,241,255,0.92)";
    ctx.font="12px ui-sans-serif, system-ui";
    ctx.fillText(options.title, x0, 12);
  }

  // legend (top right, limited)
  ctx.font="10px ui-sans-serif, system-ui";
  let lx = W-10, ly=12;
  const maxLegend = Math.min(6, series.length);
  for (let i=0;i<maxLegend;i++){
    const s = series[i];
    const label = s.label.length>14 ? s.label.slice(0,14)+"…" : s.label;
    const textW = ctx.measureText(label).width;
    lx = W-10 - textW;
    ctx.fillStyle = s.color;
    ctx.fillRect(lx-12, ly-8, 8, 8);
    ctx.fillStyle="rgba(234,241,255,0.72)";
    ctx.fillText(label, lx, ly);
    ly += 12;
  }
  if (series.length > maxLegend){
    ctx.fillStyle="rgba(234,241,255,0.45)";
    ctx.fillText(`+${series.length-maxLegend} more`, W-80, ly);
  }
}

function renderMonthlyPreview(){
  const monthVal = document.getElementById("repMonth").value;
  if (!monthVal){ alert("Pick a month."); return; }
  const [yy, mm] = monthVal.split("-").map(x=>parseInt(x,10));
  const year = yy, monthIdx0 = mm-1;

  const who = document.getElementById("repWho").value;
  const roster = getRoster();
  if (!roster.length){
    alert("Add roster first.");
    go("roster");
    return;
  }

  const { scores, teamScores } = computeMonthlyScores(year, monthIdx0);

  const preview = document.getElementById("repPreview");
  preview.innerHTML = "";

  document.getElementById("repMeta").textContent =
    `Month: ${monthVal} • Weekly buckets: W1–W4 • Charts: category-based`;

  // For each category, build chart series
  for (const cat of EMPHASIS){
    const card = document.createElement("div");
    card.className = "card";
    card.style.background = "rgba(255,255,255,.03)";
    card.style.boxShadow = "none";

    const canvas = document.createElement("canvas");
    canvas.width = 900;
    canvas.height = 260;

    let series = [];
    if (who==="TEAM"){
      series = roster.map((p,idx)=>({
        label:p.name,
        color: colorForPlayer(p.id, idx),
        points: scores[p.id]?.[cat] ?? [100,100,100,100]
      }));
      // sort by last value (show top movers first)
      series.sort((a,b)=> (b.points[3]-a.points[3]));
    } else {
      const p = roster.find(x=>x.id===who);
      series = [{
        label:p?.name || "Player",
        color: colorForPlayer(who,0),
        points: scores[who]?.[cat] ?? [100,100,100,100]
      }];
    }

    // Draw
    drawLineChart(canvas, series, { title: `${cat} — ${monthVal}` });

    card.innerHTML = `<div class="row wrap">
        <div>
          <div class="h2">${cat}</div>
          <div class="muted">W1–W4 score (0–100). Higher = fewer missed standards.</div>
        </div>
        <div class="chipRow">
          <span class="tag blue">${who==="TEAM" ? "All Players" : "Single Player"}</span>
        </div>
      </div>
      <div class="divider"></div>
    `;
    card.appendChild(canvas);
    preview.appendChild(card);
  }
}

function printMonthlyPDF(){
  // Use print window with rendered canvases
  const monthVal = document.getElementById("repMonth").value;
  if (!monthVal){ alert("Pick a month."); return; }
  renderMonthlyPreview();

  const title = `Practice Builder Pro — Monthly Report — ${monthVal}`;
  const html = document.getElementById("repPreview").innerHTML;

  // Convert canvases to images for print reliability
  const canvases = document.querySelectorAll("#repPreview canvas");
  const images = [];
  canvases.forEach(c=>{
    images.push(c.toDataURL("image/png"));
  });

  // Rebuild printable HTML with images
  let body = `
    <div style="font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial; color:#0b1220">
      <h1 style="margin:0 0 6px 0; font-size:18px">${title}</h1>
      <div style="font-size:12px; margin-bottom:14px; color:#334155">
        Weekly buckets: W1–W4 • Categories: Defense/Rebounding/Offense/Press/Conditioning/Shooting
      </div>
  `;

  let idx=0;
  for (const cat of EMPHASIS){
    const img = images[idx++];
    body += `
      <div style="page-break-inside:avoid; margin:0 0 18px 0; padding:12px; border:1px solid #e2e8f0; border-radius:12px">
        <div style="display:flex; justify-content:space-between; align-items:flex-end; gap:10px">
          <div>
            <div style="font-weight:800; font-size:14px">${cat}</div>
            <div style="font-size:11px; color:#475569">Score 0–100. Higher = fewer missed standards.</div>
          </div>
        </div>
        <div style="margin-top:10px">
          <img src="${img}" style="width:100%; max-width:100%; border:1px solid #e2e8f0; border-radius:10px"/>
        </div>
      </div>
    `;
  }

  body += `
      <div style="font-size:10px; color:#64748b; margin-top:6px">
        Export method: Print → Save as PDF (offline, no cost).
      </div>
    </div>
  `;

  const w = window.open("", "_blank");
  w.document.open();
  w.document.write(`
    <html>
      <head>
        <meta charset="utf-8"/>
        <meta name="viewport" content="width=device-width,initial-scale=1.0"/>
        <title>${title}</title>
        <style>
          @page { size: landscape; margin: 12mm; }
          body { margin:0; padding:0; }
        </style>
      </head>
      <body>${body}</body>
    </html>
  `);
  w.document.close();

  // Let it render, then print
  setTimeout(()=>{ w.print(); }, 400);
}

/* =========================================================
   EXPORT JSON
========================================================= */
function exportJSON(){
  const data = {
    roster: getRoster(),
    present: getPresent(),
    plan: getPlan(),
    logs: getLogs(),
    history: getHistory(),
    settings: getSettings()
  };
  const blob = new Blob([JSON.stringify(data,null,2)], {type:"application/json"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = `practice-builder-pro-export-${Date.now()}.json`;
  a.click();
  URL.revokeObjectURL(url);
}

/* =========================================================
   RESET DATA
========================================================= */
function resetData(){
  if (!confirm("Reset ALL app data? (Roster, plan, logs)")) return;
  localStorage.removeItem(K.roster);
  localStorage.removeItem(K.present);
  localStorage.removeItem(K.plan);
  localStorage.removeItem(K.logs);
  localStorage.removeItem(K.history);
  localStorage.removeItem(K.settings);
  ui = { tab:"home", logSelectedVid:null, logSelectedPlayers:new Set(), runIndex:0, runTimer:{running:false,endTs:0,remainSec:0,interval:null} };
  stopTimer();
  renderAll();
  go("home");
}

/* =========================================================
   MODAL
========================================================= */
function openModal(title, sub, bodyHtml){
  document.getElementById("mTitle").textContent = title;
  document.getElementById("mSub").textContent = sub;
  document.getElementById("mBody").innerHTML = bodyHtml;
  document.getElementById("modalWrap").classList.add("show");
}
function closeModal(){
  document.getElementById("modalWrap").classList.remove("show");
}

/* =========================================================
   RENDER ALL
========================================================= */
function renderAll(){
  renderHomeHeaderLine();
  renderRoster();
  renderBuildUI();
  renderPlan();
  renderLogUI();
  renderProgress();
  // keep run screen accurate if open
  if (ui.tab==="run") renderRun();
}

/* =========================================================
   BOOT
========================================================= */
(function init(){
  // defaults
  if (!localStorage.getItem(K.settings)){
    setSettings({ emphasis:[], hardMode:true });
  }
  renderAll();
  go("home");

  // Reports tab is not on bottom nav; access via Home/Progress area:
  // Add quick access: clicking team need tag goes to reports
  document.getElementById("teamNeedTag").onclick = ()=>go("reports");
})();
</script>

<!-- Quick hidden access to reports in UI: click Progress tab then type 'reports' in URL bar? (No.)
     You can navigate to Reports by tapping Progress then clicking the teamNeed tag, or from Home quick actions. -->
<script>
  // Add Home button access to Reports without adding bottom nav button (keeps nav clean)
  // We'll hijack a simple gesture: double-click Need tag on Home to open Reports
  document.addEventListener("DOMContentLoaded", ()=>{
    const needTag = document.getElementById("tagNeed");
    if (needTag){
      needTag.ondblclick = ()=>go("reports");
      needTag.title = "Double-click to open Reports";
    }
  });
</script>
</body>
</html>
