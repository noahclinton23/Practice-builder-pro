<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
  <title>Practice Command Center (iPad App)</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    /* ===== iPad-app style (no page scrolling) ===== */
    html, body { height: 100%; overflow: hidden; }
    body{
      background:
        radial-gradient(1200px 700px at 15% 0%, rgba(34,211,238,.12), transparent 60%),
        radial-gradient(900px 600px at 85% 10%, rgba(168,85,247,.12), transparent 55%),
        radial-gradient(900px 700px at 70% 95%, rgba(34,197,94,.10), transparent 60%),
        linear-gradient(180deg,#070814 0%, #050611 100%);
      color: #EAF0FF;
      font-family: system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,"Apple Color Emoji","Segoe UI Emoji";
    }
    .glass{
      background: rgba(12, 14, 30, .70);
      border: 1px solid rgba(148,163,184,.16);
      box-shadow: 0 16px 45px rgba(0,0,0,.45);
      backdrop-filter: blur(14px);
    }
    .chip{
      background: rgba(2,6,23,.35);
      border: 1px solid rgba(148,163,184,.18);
    }
    .btn{
      background: rgba(2,6,23,.35);
      border: 1px solid rgba(148,163,184,.18);
      transition: transform .04s ease, background .15s ease, border-color .15s ease;
      user-select: none;
      -webkit-tap-highlight-color: transparent;
    }
    .btn:active{ transform: scale(.98); }
    .btn:hover{ background: rgba(2,6,23,.55); }
    .btnPrimary{
      background: rgba(34,211,238,.16);
      border: 1px solid rgba(34,211,238,.35);
    }
    .btnPrimary:hover{ background: rgba(34,211,238,.24); }
    .btnDanger{
      background: rgba(239,68,68,.14);
      border: 1px solid rgba(239,68,68,.32);
    }
    .btnDanger:hover{ background: rgba(239,68,68,.20); }
    .muted{ color: rgba(234,240,255,.70); }
    .muted2{ color: rgba(234,240,255,.56); }
    .divider{ border-color: rgba(148,163,184,.16); }
    .badgeCyan{
      border: 1px solid rgba(34,211,238,.35);
      background: rgba(34,211,238,.12);
      color: rgba(165,243,252,.95);
    }
    .badgePurple{
      border: 1px solid rgba(168,85,247,.35);
      background: rgba(168,85,247,.12);
      color: rgba(233,213,255,.95);
    }
    .badgeGreen{
      border: 1px solid rgba(34,197,94,.30);
      background: rgba(34,197,94,.12);
      color: rgba(187,247,208,.95);
    }
    .badgeAmber{
      border: 1px solid rgba(245,158,11,.28);
      background: rgba(245,158,11,.12);
      color: rgba(254,215,170,.95);
    }
    .badgeRed{
      border: 1px solid rgba(239,68,68,.30);
      background: rgba(239,68,68,.12);
      color: rgba(254,202,202,.95);
    }
    .inp{
      background: rgba(0,0,0,.25);
      border:1px solid rgba(148,163,184,.18);
      outline:none;
    }
    .inp:focus{
      box-shadow: 0 0 0 2px rgba(34,211,238,.25);
      border-color: rgba(34,211,238,.40);
    }
    .mono{ font-family: ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace; }

    /* Big tap targets */
    .tap{ padding: 14px 16px; border-radius: 18px; font-weight: 800; }
    .tapSm{ padding: 10px 12px; border-radius: 14px; font-weight: 800; }

    /* Modal */
    .modalBg{ background: rgba(0,0,0,.72); }
    .shadowTop{ box-shadow: 0 -10px 30px rgba(0,0,0,.40); }

    /* Prevent accidental page scroll on iOS */
    .noScroll{ overscroll-behavior: none; }
  </style>
</head>

<body class="noScroll">
  <!-- App shell -->
  <div class="h-full flex flex-col">
    <!-- Top bar -->
    <header class="px-4 pt-4 pb-3">
      <div class="glass rounded-3xl px-4 py-4 flex items-center justify-between gap-3">
        <div class="flex items-center gap-3 min-w-0">
          <div class="text-2xl">üèÄ</div>
          <div class="min-w-0">
            <div class="text-xl sm:text-2xl font-extrabold tracking-tight truncate">
              Practice Command Center
            </div>
            <div class="text-sm muted2 truncate" id="topSub">Smart plans ‚Ä¢ No repeats ‚Ä¢ Player-based</div>
          </div>
        </div>

        <div class="flex items-center gap-2">
          <div class="hidden sm:flex items-center gap-2 px-3 py-2 rounded-full badgeCyan text-xs font-extrabold">
            <span class="w-2.5 h-2.5 rounded-full bg-cyan-300"></span>
            Offline (iPad App)
          </div>
          <button class="btn tapSm btnPrimary" onclick="openQuickBuild()">Build</button>
        </div>
      </div>
    </header>

    <!-- Main area (no page scroll; views scroll internally if needed) -->
    <main class="flex-1 px-4 pb-2 overflow-hidden">
      <div class="h-full glass rounded-3xl p-4 flex flex-col overflow-hidden">
        <!-- View header -->
        <div class="flex items-center justify-between gap-3 pb-3">
          <div>
            <div class="text-xs uppercase tracking-wider muted2">View</div>
            <div class="text-xl font-extrabold" id="viewTitle">Dashboard</div>
          </div>
          <div class="flex gap-2">
            <button class="btn tapSm" onclick="exportData()">Export</button>
            <button class="btn tapSm btnDanger" onclick="hardReset()">Reset</button>
          </div>
        </div>

        <div class="border-t divider mb-3"></div>

        <!-- Views container -->
        <div class="flex-1 overflow-hidden">
          <!-- DASHBOARD -->
          <section id="view-dashboard" class="h-full flex flex-col gap-3 overflow-hidden">
            <div class="grid grid-cols-2 lg:grid-cols-4 gap-3">
              <div class="chip rounded-3xl p-4">
                <div class="text-xs uppercase tracking-wider muted2">Present Today</div>
                <div class="text-3xl font-extrabold mt-1" id="dashPresent">0</div>
                <div class="text-xs muted2 mt-1" id="dashBand">Band: ‚Äî</div>
              </div>
              <div class="chip rounded-3xl p-4">
                <div class="text-xs uppercase tracking-wider muted2">Today Situation</div>
                <div class="text-lg font-extrabold mt-1" id="dashSituation">‚Äî</div>
                <div class="text-xs muted2 mt-1">Auto-rotates daily</div>
              </div>
              <div class="chip rounded-3xl p-4">
                <div class="text-xs uppercase tracking-wider muted2">Biggest Need</div>
                <div class="text-lg font-extrabold mt-1" id="dashNeed">‚Äî</div>
                <div class="text-xs muted2 mt-1">Based on present players</div>
              </div>
              <div class="chip rounded-3xl p-4">
                <div class="text-xs uppercase tracking-wider muted2">No-Repeat Meter</div>
                <div class="text-lg font-extrabold mt-1" id="dashVariety">‚Äî</div>
                <div class="text-xs muted2 mt-1">This week</div>
              </div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-3 gap-3 flex-1 overflow-hidden">
              <!-- Today plan preview -->
              <div class="chip rounded-3xl p-4 lg:col-span-2 flex flex-col overflow-hidden">
                <div class="flex items-start justify-between gap-2">
                  <div class="min-w-0">
                    <div class="text-xs uppercase tracking-wider muted2">Today Plan</div>
                    <div class="text-lg font-extrabold mt-1 truncate" id="dashPlanTitle">No plan yet</div>
                    <div class="text-sm muted2 mt-1" id="dashPlanMeta">Tap Build to create one.</div>
                  </div>
                  <button class="btn tapSm btnPrimary" onclick="go('practice')">Open</button>
                </div>
                <div class="border-t divider my-3"></div>
                <div class="flex-1 overflow-hidden">
                  <div id="dashPlanList" class="h-full overflow-auto pr-1 space-y-2"></div>
                </div>
              </div>

              <!-- Quick actions -->
              <div class="chip rounded-3xl p-4 flex flex-col gap-3 overflow-hidden">
                <div>
                  <div class="text-xs uppercase tracking-wider muted2">Quick Actions</div>
                  <div class="text-sm muted2 mt-1">Big buttons, fast coaching.</div>
                </div>

                <div class="grid grid-cols-1 gap-3">
                  <button class="btn tap btnPrimary text-left" onclick="go('roster')">
                    <div class="text-sm muted2">üë• Roster</div>
                    <div class="text-xl font-extrabold">Add / Present</div>
                    <div class="text-sm muted2">Height ‚Ä¢ Weight ‚Ä¢ Position</div>
                  </button>
                  <button class="btn tap text-left" onclick="openQuickBuild()">
                    <div class="text-sm muted2">üß† Smart Build</div>
                    <div class="text-xl font-extrabold">Build / Regenerate</div>
                    <div class="text-sm muted2">No repeats ‚Ä¢ weakness-based</div>
                  </button>
                  <button class="btn tap text-left" onclick="go('grades')">
                    <div class="text-sm muted2">üìä Grades</div>
                    <div class="text-xl font-extrabold">Grade Per Drill</div>
                    <div class="text-sm muted2">Tap 1‚Äì5 for each player</div>
                  </button>
                </div>

                <div class="border-t divider"></div>

                <div class="text-sm muted2">
                  Rule: <span class="font-extrabold text-slate-50">5v5 drills require 10+ players.</span><br/>
                  Your app will <span class="font-extrabold text-slate-50">never</span> pick 5v5 for 8 players.
                </div>
              </div>
            </div>
          </section>

          <!-- ROSTER -->
          <section id="view-roster" class="hidden h-full overflow-hidden">
            <div class="h-full flex flex-col gap-3 overflow-hidden">
              <!-- Roster controls -->
              <div class="grid grid-cols-1 lg:grid-cols-3 gap-3">
                <div class="chip rounded-3xl p-4">
                  <div class="text-xs uppercase tracking-wider muted2">Roster Tools</div>
                  <div class="mt-3 flex flex-wrap gap-2">
                    <button class="btn tapSm btnPrimary" onclick="openPlayerModal()">+ Add Player</button>
                    <button class="btn tapSm" onclick="clearPresent()">Clear Present</button>
                    <button class="btn tapSm btnDanger" onclick="clearRoster()">Clear Roster</button>
                  </div>
                  <div class="text-sm muted2 mt-3">Tap a player to edit. Use Present toggles for today.</div>
                </div>

                <div class="chip rounded-3xl p-4">
                  <div class="text-xs uppercase tracking-wider muted2">Present Today</div>
                  <div class="text-2xl font-extrabold mt-1" id="rosterPresentCount">0</div>
                  <div class="mt-2">
                    <span class="inline-flex items-center gap-2 px-3 py-1 rounded-full badgePurple text-xs font-extrabold">
                      Band <span id="rosterBand">‚Äî</span>
                    </span>
                  </div>
                  <div class="text-sm muted2 mt-3">Your practice builder uses ONLY the players marked present.</div>
                </div>

                <div class="chip rounded-3xl p-4">
                  <div class="text-xs uppercase tracking-wider muted2">Composition</div>
                  <div class="mt-2 text-sm muted2" id="rosterComposition">‚Äî</div>
                  <div class="mt-3 text-sm muted2">
                    If you only have guards ‚Üí no post-only drills.<br/>
                    If you only have bigs ‚Üí hybrid big-guard development drills are prioritized.
                  </div>
                </div>
              </div>

              <!-- Roster list (internal scroll) -->
              <div class="chip rounded-3xl p-4 flex-1 overflow-hidden">
                <div class="flex items-center justify-between gap-2">
                  <div>
                    <div class="text-xs uppercase tracking-wider muted2">Players</div>
                    <div class="text-sm muted2">Big tap rows ‚Ä¢ Present toggle ‚Ä¢ Edit</div>
                  </div>
                </div>
                <div class="border-t divider my-3"></div>
                <div id="rosterList" class="h-full overflow-auto pr-1 space-y-2"></div>
              </div>
            </div>
          </section>

          <!-- PRACTICE -->
          <section id="view-practice" class="hidden h-full overflow-hidden">
            <div class="h-full flex flex-col gap-3 overflow-hidden">
              <!-- Builder -->
              <div class="grid grid-cols-1 lg:grid-cols-3 gap-3">
                <div class="chip rounded-3xl p-4 lg:col-span-2">
                  <div class="flex items-start justify-between gap-2">
                    <div class="min-w-0">
                      <div class="text-xs uppercase tracking-wider muted2">Smart Builder</div>
                      <div class="text-xl font-extrabold mt-1">Build Today‚Äôs Plan</div>
                      <div class="text-sm muted2 mt-1" id="practiceMetaTop">‚Äî</div>
                    </div>
                    <div class="flex flex-col gap-2">
                      <button class="btn tapSm btnPrimary" onclick="buildPractice(false)">Build</button>
                      <button class="btn tapSm" onclick="buildPractice(true)">Regenerate</button>
                    </div>
                  </div>

                  <div class="border-t divider my-3"></div>

                  <div class="grid grid-cols-1 sm:grid-cols-3 gap-3">
                    <div>
                      <div class="text-xs uppercase tracking-wider muted2">Duration</div>
                      <div class="mt-2 flex gap-2">
                        <button class="btn tapSm" onclick="setDuration(60)">60</button>
                        <button class="btn tapSm btnPrimary" onclick="setDuration(90)">90</button>
                        <button class="btn tapSm" onclick="setDuration(110)">110</button>
                      </div>
                      <input id="practiceDuration" class="mt-2 w-full rounded-2xl p-3 text-lg inp font-extrabold" type="number" min="45" max="150" value="90"/>
                    </div>

                    <div>
                      <div class="text-xs uppercase tracking-wider muted2">Focus</div>
                      <input id="practiceFocus" class="mt-2 w-full rounded-2xl p-3 text-lg inp font-extrabold" placeholder="ex: Help Defense + Rebounding"/>
                      <div class="text-xs muted2 mt-2">Leave blank ‚Üí auto situation + needs</div>
                    </div>

                    <div>
                      <div class="text-xs uppercase tracking-wider muted2">Emphasis</div>
                      <div class="mt-2 grid grid-cols-2 gap-2 text-sm">
                        <label class="btn tapSm chip flex items-center gap-2"><input id="em_def" type="checkbox" checked />Defense</label>
                        <label class="btn tapSm chip flex items-center gap-2"><input id="em_reb" type="checkbox" checked />Rebound</label>
                        <label class="btn tapSm chip flex items-center gap-2"><input id="em_off" type="checkbox" />Offense</label>
                        <label class="btn tapSm chip flex items-center gap-2"><input id="em_press" type="checkbox" />Press</label>
                        <label class="btn tapSm chip flex items-center gap-2"><input id="em_cond" type="checkbox" checked />Condition</label>
                        <label class="btn tapSm chip flex items-center gap-2"><input id="em_shoot" type="checkbox" />Shoot</label>
                      </div>
                    </div>
                  </div>

                  <div class="mt-3">
                    <div class="text-xs uppercase tracking-wider muted2">Coach Note</div>
                    <input id="practiceNotes" class="mt-2 w-full rounded-2xl p-3 text-lg inp font-extrabold" placeholder="ex: Feet in paint help side. No fly-bys."/>
                  </div>
                </div>

                <!-- Present pills -->
                <div class="chip rounded-3xl p-4 overflow-hidden">
                  <div class="text-xs uppercase tracking-wider muted2">Present Players</div>
                  <div class="text-sm muted2 mt-1">Tap to toggle (quick).</div>
                  <div class="border-t divider my-3"></div>
                  <div id="presentPills" class="h-[265px] overflow-auto pr-1 flex flex-wrap gap-2"></div>
                  <div class="mt-3 text-sm muted2">
                    Band: <span class="font-extrabold text-slate-50" id="bandLabel">‚Äî</span><br/>
                    5v5 requires <span class="font-extrabold text-slate-50">10+</span>.
                  </div>
                </div>
              </div>

              <!-- Plan -->
              <div class="chip rounded-3xl p-4 flex-1 overflow-hidden">
                <div class="flex items-start justify-between gap-2">
                  <div class="min-w-0">
                    <div class="text-xs uppercase tracking-wider muted2">Today‚Äôs Plan</div>
                    <div class="text-sm muted2 mt-1" id="planMeta">Build to see plan.</div>
                  </div>
                  <div class="flex gap-2">
                    <button class="btn tapSm" onclick="go('grades')">Grade Plan</button>
                    <button class="btn tapSm btnPrimary" onclick="logPracticeComplete()">Log Complete</button>
                  </div>
                </div>
                <div class="border-t divider my-3"></div>
                <div id="practicePlan" class="h-full overflow-auto pr-1 space-y-2"></div>
              </div>
            </div>
          </section>

          <!-- GRADES / PROGRESS -->
          <section id="view-grades" class="hidden h-full overflow-hidden">
            <div class="h-full flex flex-col gap-3 overflow-hidden">
              <div class="grid grid-cols-1 lg:grid-cols-3 gap-3">
                <div class="chip rounded-3xl p-4 lg:col-span-2">
                  <div class="flex items-start justify-between gap-2">
                    <div class="min-w-0">
                      <div class="text-xs uppercase tracking-wider muted2">Grades</div>
                      <div class="text-xl font-extrabold mt-1">Grade Each Player Per Drill</div>
                      <div class="text-sm muted2 mt-1">Tap 1‚Äì5. These grades drive future practice selection.</div>
                    </div>
                    <div class="flex gap-2">
                      <button class="btn tapSm" onclick="clearGrades()">Clear Grades</button>
                      <button class="btn tapSm btnPrimary" onclick="recomputeInsights()">Refresh</button>
                    </div>
                  </div>
                </div>

                <div class="chip rounded-3xl p-4">
                  <div class="text-xs uppercase tracking-wider muted2">Insights</div>
                  <div class="text-sm muted2 mt-2" id="insightsBox">Build a plan and start grading.</div>
                </div>
              </div>

              <div class="chip rounded-3xl p-4 flex-1 overflow-hidden">
                <div class="flex items-center justify-between gap-2">
                  <div>
                    <div class="text-xs uppercase tracking-wider muted2">Grade Board</div>
                    <div class="text-sm muted2">Shows only Today‚Äôs drills and Today‚Äôs present players.</div>
                  </div>
                </div>
                <div class="border-t divider my-3"></div>
                <div id="gradeBoard" class="h-full overflow-auto pr-1 space-y-3"></div>
              </div>
            </div>
          </section>

        </div>
      </div>
    </main>

    <!-- Bottom nav -->
    <footer class="px-4 pb-4">
      <div class="glass rounded-3xl p-2 shadowTop">
        <div class="grid grid-cols-4 gap-2">
          <button id="nav-dashboard" class="btn tap text-center btnPrimary" onclick="go('dashboard')">
            <div class="text-lg">üè†</div><div class="text-sm font-extrabold">Home</div>
          </button>
          <button id="nav-roster" class="btn tap text-center" onclick="go('roster')">
            <div class="text-lg">üë•</div><div class="text-sm font-extrabold">Roster</div>
          </button>
          <button id="nav-practice" class="btn tap text-center" onclick="go('practice')">
            <div class="text-lg">üß†</div><div class="text-sm font-extrabold">Practice</div>
          </button>
          <button id="nav-grades" class="btn tap text-center" onclick="go('grades')">
            <div class="text-lg">üìä</div><div class="text-sm font-extrabold">Grades</div>
          </button>
        </div>
      </div>
    </footer>
  </div>

  <!-- Player Modal -->
  <div id="playerModal" class="hidden fixed inset-0 modalBg flex items-center justify-center px-4">
    <div class="glass w-full max-w-2xl rounded-3xl p-5">
      <div class="flex items-start justify-between gap-3">
        <div class="min-w-0">
          <div class="text-xs uppercase tracking-wider muted2" id="pmMode">Add Player</div>
          <div class="text-2xl font-extrabold mt-1" id="pmTitle">Player</div>
          <div class="text-sm muted2 mt-1">Height/weight drives drill selection.</div>
        </div>
        <button class="btn tapSm" onclick="closePlayerModal()">Close</button>
      </div>
      <div class="border-t divider my-4"></div>

      <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
        <div>
          <div class="text-xs uppercase tracking-wider muted2">Name</div>
          <input id="pmName" class="mt-2 w-full rounded-2xl p-3 text-lg inp font-extrabold" placeholder="Quin Coykendal" />
        </div>
        <div>
          <div class="text-xs uppercase tracking-wider muted2">Number</div>
          <input id="pmNumber" class="mt-2 w-full rounded-2xl p-3 text-lg inp font-extrabold" placeholder="23" />
        </div>

        <div>
          <div class="text-xs uppercase tracking-wider muted2">Position</div>
          <select id="pmPos" class="mt-2 w-full rounded-2xl p-3 text-lg inp font-extrabold">
            <option value="G">G (Guard)</option>
            <option value="W">W (Wing)</option>
            <option value="F">F (Forward)</option>
            <option value="C">C (Center)</option>
          </select>
        </div>
        <div>
          <div class="text-xs uppercase tracking-wider muted2">Height</div>
          <input id="pmHeight" class="mt-2 w-full rounded-2xl p-3 text-lg inp font-extrabold" placeholder="6'2 or 74" />
          <div class="text-xs muted2 mt-1">Type feet/inches or total inches</div>
        </div>

        <div>
          <div class="text-xs uppercase tracking-wider muted2">Weight (lb)</div>
          <input id="pmWeight" class="mt-2 w-full rounded-2xl p-3 text-lg inp font-extrabold" placeholder="185" />
        </div>
        <div>
          <div class="text-xs uppercase tracking-wider muted2">Notes</div>
          <input id="pmNotes" class="mt-2 w-full rounded-2xl p-3 text-lg inp font-extrabold" placeholder="Great rebounder / needs ball pressure" />
        </div>
      </div>

      <div class="mt-4 flex gap-2">
        <button class="btn tapSm btnPrimary flex-1" onclick="savePlayer()">Save</button>
        <button id="pmDeleteBtn" class="btn tapSm btnDanger hidden" onclick="deletePlayer()">Delete</button>
      </div>
    </div>
  </div>

  <!-- Drill Detail Modal -->
  <div id="drillModal" class="hidden fixed inset-0 modalBg flex items-center justify-center px-4">
    <div class="glass w-full max-w-3xl rounded-3xl p-5 overflow-hidden">
      <div class="flex items-start justify-between gap-3">
        <div class="min-w-0">
          <div class="text-xs uppercase tracking-wider muted2">Drill</div>
          <div class="text-2xl font-extrabold mt-1" id="dmTitle">‚Äî</div>
          <div class="text-sm muted2 mt-1" id="dmMeta">‚Äî</div>
        </div>
        <button class="btn tapSm" onclick="closeDrillModal()">Close</button>
      </div>
      <div class="border-t divider my-4"></div>

      <div class="grid grid-cols-1 lg:grid-cols-2 gap-4 max-h-[62vh] overflow-auto pr-1">
        <div class="chip rounded-3xl p-4">
          <div class="text-sm font-extrabold">Explanation</div>
          <div class="mt-2 text-sm muted leading-relaxed" id="dmExplain"></div>
        </div>
        <div class="chip rounded-3xl p-4">
          <div class="text-sm font-extrabold">Standards (non-negotiables)</div>
          <ul class="mt-2 text-sm muted list-disc pl-5 space-y-1" id="dmStandards"></ul>
        </div>
        <div class="chip rounded-3xl p-4">
          <div class="text-sm font-extrabold">Coach Short</div>
          <div class="mt-2 text-sm muted whitespace-pre-line" id="dmShort"></div>
        </div>
        <div class="chip rounded-3xl p-4">
          <div class="text-sm font-extrabold">Teaching Cues</div>
          <div class="mt-2 text-sm muted whitespace-pre-line" id="dmLong"></div>
        </div>
      </div>
    </div>
  </div>

<script>
/* =========================================================
   STORAGE KEYS
========================================================= */
const KEY_ROSTER = "pcc_roster_v3";
const KEY_PRESENT = "pcc_present_v3";
const KEY_TODAY = "pcc_today_v3";
const KEY_GRADES = "pcc_grades_v3";
const KEY_WEEKLY_USED = "pcc_weekly_used_v3";
const KEY_REGEN_SEED = "pcc_regen_seed_v3";

/* =========================================================
   UTIL: Storage
========================================================= */
function loadJSON(key, fallback){
  try { return JSON.parse(localStorage.getItem(key)) ?? fallback; }
  catch { return fallback; }
}
function saveJSON(key, val){ localStorage.setItem(key, JSON.stringify(val)); }
function uid(){
  return (crypto?.randomUUID?.() || ("id-" + Math.random().toString(16).slice(2) + Date.now()));
}
function escapeHtml(s){
  return String(s ?? "")
    .replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;")
    .replaceAll('"',"&quot;").replaceAll("'","&#039;");
}
function clampInt(n,min,max){ return Math.max(min, Math.min(max, n)); }

/* =========================================================
   WEEK ID
========================================================= */
function getWeekId(d=new Date()){
  const date = new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate()));
  const dayNum = date.getUTCDay() || 7;
  date.setUTCDate(date.getUTCDate() + 4 - dayNum);
  const yearStart = new Date(Date.UTC(date.getUTCFullYear(),0,1));
  const weekNo = Math.ceil((((date - yearStart) / 86400000) + 1)/7);
  return `${date.getUTCFullYear()}-W${String(weekNo).padStart(2,"0")}`;
}

/* =========================================================
   SEEDED RNG (regen always changes)
========================================================= */
function hashStringToInt(str){
  let h = 2166136261;
  for (let i=0;i<str.length;i++){
    h ^= str.charCodeAt(i);
    h = Math.imul(h, 16777619);
  }
  return (h >>> 0);
}
function mulberry32(seed){
  let a = seed >>> 0;
  return function(){
    a |= 0;
    a = (a + 0x6D2B79F5) | 0;
    let t = Math.imul(a ^ (a >>> 15), 1 | a);
    t = (t + Math.imul(t ^ (t >>> 7), 61 | t)) ^ t;
    return ((t ^ (t >>> 14)) >>> 0) / 4294967296;
  };
}
function getRegenSeed(){ return loadJSON(KEY_REGEN_SEED, 1); }
function bumpRegenSeed(){ saveJSON(KEY_REGEN_SEED, getRegenSeed()+1); }

/* =========================================================
   ATTENDANCE BANDS
========================================================= */
function getBand(n){
  if (n <= 2) return "1‚Äì2";
  if (n <= 4) return "3‚Äì4";
  if (n <= 6) return "5‚Äì6";
  if (n <= 9) return "7‚Äì9";
  return "10+";
}
function bandMinMax(band){
  if (band==="1‚Äì2") return [1,2];
  if (band==="3‚Äì4") return [3,4];
  if (band==="5‚Äì6") return [5,6];
  if (band==="7‚Äì9") return [7,9];
  return [10,99];
}

/* =========================================================
   SITUATION ROTATION (daily variety)
========================================================= */
const WEEKLY_SITUATIONS = [
  { key:"closeouts", label:"Closeouts + Contain", skills:["closeout","onball","defense"] },
  { key:"help", label:"Help Side + Recover", skills:["help","defense","communication"] },
  { key:"rebound", label:"Box Out + Outlet", skills:["rebounding","passing","conditioning"] },
  { key:"screen", label:"Screen Defense", skills:["screening","defense","communication"] },
  { key:"late", label:"Late-Game Execution", skills:["situational","spacing","freeThrows"] },
  { key:"transition", label:"Transition Defense", skills:["transition","defense","conditioning"] },
  { key:"turnovers", label:"Ball Security + Pressure", skills:["ballhandling","passing","defense"] },
  { key:"press", label:"Press Rotations", skills:["press","communication","conditioning"] },
  { key:"zone", label:"Zone Concepts", skills:["spacing","passing","situational","defense"] },
];
function getTodaySituation(){
  const d = new Date();
  const key = `${d.getFullYear()}-${d.getMonth()+1}-${d.getDate()}-${getWeekId()}`;
  const idx = hashStringToInt(key) % WEEKLY_SITUATIONS.length;
  return WEEKLY_SITUATIONS[idx];
}

/* =========================================================
   ROSTER + PRESENT
========================================================= */
function getRoster(){ return loadJSON(KEY_ROSTER, []); }
function saveRoster(list){ saveJSON(KEY_ROSTER, list); }
function getPresentIds(){ return loadJSON(KEY_PRESENT, []); }
function savePresentIds(list){ saveJSON(KEY_PRESENT, list); }

function parseHeightToInches(input){
  const s = String(input||"").trim().toLowerCase();
  if (!s) return null;
  // If pure number => inches
  if (/^\d+$/.test(s)) return clampInt(parseInt(s,10), 48, 96);
  // Feet'inches formats: 6'2, 6‚Äô2, 6ft 2, 6 2
  const m = s.match(/(\d+)\s*(?:ft|')\s*(\d+)?/);
  if (m){
    const ft = parseInt(m[1],10);
    const inch = m[2] ? parseInt(m[2],10) : 0;
    return clampInt(ft*12 + inch, 48, 96);
  }
  const m2 = s.match(/(\d+)\s+(\d+)/);
  if (m2){
    const ft = parseInt(m2[1],10);
    const inch = parseInt(m2[2],10);
    return clampInt(ft*12 + inch, 48, 96);
  }
  return null;
}

function getPresentPlayers(){
  const roster = getRoster();
  const present = new Set(getPresentIds());
  return roster.filter(p => present.has(p.id));
}

function togglePresent(pid){
  const set = new Set(getPresentIds());
  if (set.has(pid)) set.delete(pid); else set.add(pid);
  savePresentIds(Array.from(set));
  renderAll();
}

/* =========================================================
   PLAYER CLASSIFICATION (guards vs bigs)
========================================================= */
function classifyPlayer(p){
  const pos = (p.pos||"").toUpperCase();
  const h = Number(p.height || 0);
  const w = Number(p.weight || 0);

  if (pos === "C") return "BIG";
  if (pos === "G") return "GUARD";
  if (pos === "F" || pos === "W"){
    if (h >= 76 || w >= 215) return "BIG";
    return "WING";
  }
  if (h >= 78 || w >= 225) return "BIG";
  if (h && h <= 73) return "GUARD";
  return "WING";
}
function analyzeTeam(presentPlayers){
  const counts = { GUARD:0, WING:0, BIG:0 };
  let avgH=0, avgW=0;
  presentPlayers.forEach(p=>{
    const t = classifyPlayer(p);
    counts[t] = (counts[t]||0) + 1;
    avgH += Number(p.height||0);
    avgW += Number(p.weight||0);
  });
  const n = presentPlayers.length || 1;
  avgH /= n; avgW /= n;

  return {
    n: presentPlayers.length,
    counts,
    onlyGuards: counts.BIG===0 && (counts.GUARD + counts.WING)>0,
    onlyBigs: (counts.GUARD + counts.WING)===0 && counts.BIG>0,
    mixed: counts.BIG>0 && (counts.GUARD + counts.WING)>0,
    avgH, avgW
  };
}

/* =========================================================
   GRADES (per player per drill) 1‚Äì5
========================================================= */
function getGrades(){ return loadJSON(KEY_GRADES, []); }
function saveGrades(list){ saveJSON(KEY_GRADES, list); }

function setGrade(practiceId, drillId, playerId, grade){
  const list = getGrades();
  const idx = list.findIndex(x => x.practiceId===practiceId && x.drillId===drillId && x.playerId===playerId);
  const rec = {
    id: idx>=0 ? list[idx].id : uid(),
    ts: Date.now(),
    weekId: getWeekId(),
    practiceId, drillId, playerId,
    grade: clampInt(Number(grade), 1, 5)
  };
  if (idx>=0) list[idx] = { ...list[idx], ...rec };
  else list.push(rec);
  saveGrades(list);
}

function getAvgGradeForPlayerSkills(playerId){
  // Returns weighted skill weaknesses based on low grades
  const grades = getGrades().filter(g => g.playerId===playerId);
  const skillScore = {}; // higher = worse
  const by = {};
  for (const g of grades){
    const d = DRILLS.find(x => x.id===g.drillId);
    if (!d) continue;
    const deficit = Math.max(0, 3.6 - Number(g.grade||0)); // below 3.6 signals weakness
    const w = deficit * 2.2;
    (d.meta?.skills || []).forEach(s=>{
      skillScore[s] = (skillScore[s]||0) + w;
      by[s] = (by[s]||0) + 1;
    });
  }
  return { skillScore, by };
}

/* =========================================================
   WEEKLY NO-REPEAT TRACKING (IDs + tags + skills + categories)
========================================================= */
function getWeeklyUsed(){
  const weekId = getWeekId();
  const all = loadJSON(KEY_WEEKLY_USED, {});
  if (!all[weekId]){
    all[weekId] = { ids:[], categories:[], tags:[], skills:[] };
    saveJSON(KEY_WEEKLY_USED, all);
  }
  const w = all[weekId];
  return {
    weekId,
    all,
    usedIds: new Set(w.ids || []),
    usedCats: new Set(w.categories || []),
    usedTags: new Set(w.tags || []),
    usedSkills: new Set(w.skills || [])
  };
}
function markWeeklyUsed(drills){
  const { weekId, all } = getWeeklyUsed();
  const w = all[weekId];

  const asObjs = drills.map(x => typeof x === "string" ? DRILLS.find(d=>d.id===x) : x).filter(Boolean);

  const ids = new Set(w.ids || []);
  const cats = new Set(w.categories || []);
  const tags = new Set(w.tags || []);
  const skills = new Set(w.skills || []);

  for (const d of asObjs){
    ids.add(d.id);
    cats.add(normalizeCat(d.category));
    (d.tags || []).forEach(t => tags.add(String(t)));
    (d.meta?.skills || []).forEach(s => skills.add(String(s)));
  }

  w.ids = Array.from(ids);
  w.categories = Array.from(cats);
  w.tags = Array.from(tags);
  w.skills = Array.from(skills);
  all[weekId] = w;
  saveJSON(KEY_WEEKLY_USED, all);
}

/* =========================================================
   DRILL LIBRARY (BIG variety + situations)
   - IMPORTANT: true 5v5 drills have minPlayers=10 AND tag "5v5"
========================================================= */
function mkDrill(id,title,category,tags,minPlayers,maxPlayers,meta,explain,standards,coachShort,coachLong){
  return { id,title,category,tags,minPlayers,maxPlayers,meta,explain,standards,coachShort,coachLong };
}
const META = (skills, roles, intensity="med", type="small") => ({ skills, roles, intensity, type });

const DRILLS = [
  // ===== 1‚Äì2 Individual/Small =====
  mkDrill("i01","Two-Ball Handle Circuit","Skill",["Ball Handling","Guards"],1,2,
    META(["ballhandling","conditioning"],["MIXED","GUARD_ONLY","HYBRID_BIG_GUARD"],"high","individual"),
    "Two balls: pound, alternate, cross, between, behind. Finish each set with a 10-yard burst + hard stop.",
    ["No eyes down for 10s","Low hips","No dribble above waist","3 full-speed bursts"],
    "WHY: Control under pressure.\nDO: Low, strong, fast.\nCONSEQUENCE: Sloppy handle = turnovers.",
    "Progress: weak-hand only, timer, add shadow defender."
  ),
  mkDrill("i02","Form Shooting Ladder","Shooting",["Mechanics","Consistency"],1,2,
    META(["shooting"],["MIXED","GUARD_ONLY","BIG_ONLY","HYBRID_BIG_GUARD"],"low","individual"),
    "5 spots close range. Make 5 in a row to advance. Miss resets one step.",
    ["Hold follow-through 2s","No drifting","Elbow under ball"],
    "WHY: Mechanics hold under pressure.\nDO: Perfect reps.\nCONSEQUENCE: Lazy form = bricks.",
    "Add: one-dribble pull-ups, catch-to-shot speed."
  ),
  mkDrill("i03","Big Guard Handle: Pound‚ÜíCross‚ÜíBurst","Hybrid",["Big Guard","Handle"],1,2,
    META(["ballhandling","conditioning"],["HYBRID_BIG_GUARD","BIG_ONLY","MIXED"],"high","individual"),
    "Even bigs: pound-cross-behind into a burst. Stop on balance, protect the ball.",
    ["No high dribbles","Explode after move","Stop under control"],
    "WHY: Multifunctional bigs.\nDO: Low handle.\nCONSEQUENCE: High handle = steals.",
    "Add retreat dribble + re-attack."
  ),
  mkDrill("i04","FT Under Fatigue","Shooting",["Free Throws","Conditioning"],1,2,
    META(["freeThrows","shooting","conditioning"],["MIXED","GUARD_ONLY","BIG_ONLY","HYBRID_BIG_GUARD"],"med","individual"),
    "Sprint 10 seconds ‚Üí 2 FTs. Repeat 10 rounds. Track makes.",
    ["Same routine","Breathe","Hold follow-through","No excuse misses"],
    "WHY: Close games.\nDO: Routine.\nCONSEQUENCE: Lazy routine = misses.",
    "Make it competitive: miss both = 1 down-and-back."
  ),

  // ===== 2‚Äì4 Small-sided =====
  mkDrill("d01","Partner Closeout ‚Üí Contain (1v1)","Defense",["Closeouts","On-ball"],2,2,
    META(["defense","closeout","onball"],["MIXED","GUARD_ONLY","HYBRID_BIG_GUARD"],"high","small"),
    "Defender sprints closeout to shooter, chops, contains without reaching. Shooter attacks.",
    ["Sprint 2/3, chop 1/3","High hands","Contain 3 slides","No reaching"],
    "WHY: Closeout wins possessions.\nDO: Sprint, chop, contain.\nCONSEQUENCE: Fly-by = layup.",
    "Fix: If you open hips early, restart rep."
  ),
  mkDrill("d02","2v2 No-Middle Contain + Recover","Defense",["No Middle","Help"],2,4,
    META(["defense","help","onball","communication"],["MIXED","GUARD_ONLY","HYBRID_BIG_GUARD"],"high","small"),
    "2v2 wing+corner. Force sideline. Help steps in paint then recovers on pass.",
    ["No middle drives","Help feet in paint","Talk every rep","Box out finish"],
    "WHY: Stops layups.\nDO: Force + help.\nCONSEQUENCE: Middle = breakdown.",
    "Recover on air-time. No ball-watching."
  ),
  mkDrill("o01","Finishing: Contact + Two-Foot Stops","Offense",["Finishing","Toughness"],1,3,
    META(["finishing","footwork"],["MIXED","GUARD_ONLY","BIG_ONLY","HYBRID_BIG_GUARD"],"med","small"),
    "Attack from wing/top. Finish through contact (pad/body). Land balanced two-foot stop.",
    ["Two-foot landing","Use both hands","No fading","10 makes each side"],
    "WHY: Tough buckets win.\nDO: Two feet.\nCONSEQUENCE: Soft = no bucket.",
    "Add: euro, reverse, inside-hand."
  ),
  mkDrill("o02","Short-Roll Read (Big Playmaking)","Hybrid",["PnR","Reads"],2,4,
    META(["passing","spacing","finishing"],["HYBRID_BIG_GUARD","BIG_ONLY","MIXED"],"med","small"),
    "Ball screen. Roller catches at foul line: 1 dribble max ‚Üí floater/kick/dump-off.",
    ["Eyes up on catch","1 dribble max","Hit corner on help","Finish strong if open"],
    "WHY: Bigs become hubs.\nDO: Catch & decide.\nCONSEQUENCE: Hold ball = turnover.",
    "Rotate roles so bigs also handle."
  ),
  mkDrill("r01","Rebound & Outlet War","Rebounding",["Box Out","Outlet"],3,4,
    META(["rebounding","passing","conditioning"],["MIXED","BIG_ONLY","HYBRID_BIG_GUARD"],"high","small"),
    "Shot goes up. Hit first, pursue. Secure with 2 hands. Outlet within 2 seconds.",
    ["Contact first","Two hands","Chin it","Outlet fast"],
    "WHY: End possessions.\nDO: Hit first.\nCONSEQUENCE: No box = 2nd chance.",
    "Score clean box-outs."
  ),

  // ===== 3‚Äì6 Competitive / Teaching =====
  mkDrill("t01","3v3 Continuous (Stop = Point)","Team",["Compete","Conditioning"],5,6,
    META(["defense","rebounding","conditioning","finishing"],["MIXED","HYBRID_BIG_GUARD"],"high","team"),
    "3v3: defense gets point with stop+rebound. Offense scores for a point. Winner stays.",
    ["Box out every shot","Talk","No jogging","Make layups"],
    "WHY: Compete like game.\nDO: Earn stops.\nCONSEQUENCE: Soft = lose.",
    "Constraint options: no middle, paint touch before 3."
  ),
  mkDrill("t02","4v4 Shell (Ghost if needed)","Defense",["Shell","Help"],5,6,
    META(["defense","help","communication","rebounding"],["MIXED"],"med","team"),
    "Shell: deny one away, help feet in paint, bump cutters, recover on pass, finish with rebound.",
    ["Feet in paint help side","Closeout under control","Bump cutters","No ball-side doubles"],
    "WHY: Your defense habits.\nDO: Help+recover+talk.\nCONSEQUENCE: Quiet teams get scored on.",
    "Demand talk: BALL / HELP / DENY."
  ),
  mkDrill("d03","Closeout Chaos (3 shooters)","Defense",["Closeouts","Rotation"],3,6,
    META(["closeout","defense","communication","conditioning"],["MIXED","GUARD_ONLY","HYBRID_BIG_GUARD"],"high","small"),
    "Coach passes to random perimeter. Defense must closeout and rotate on each pass (10 passes).",
    ["Sprint-chop","Hands high","No fly-bys","Talk every pass"],
    "WHY: You get tired and stop closing out.\nDO: Close out anyway.\nCONSEQUENCE: Open shots.",
    "Score: open catch = -1 for defense."
  ),
  mkDrill("d04","Tag & Recover (Help the Helper)","Defense",["Help","Recover"],3,6,
    META(["help","defense","communication"],["MIXED","HYBRID_BIG_GUARD"],"med","small"),
    "Drive from wing. Help tags to stop ball. On kick-out, recover with high hands. Rotate.",
    ["Feet in paint early","Chest up","Recover on air-time","No ball watching"],
    "WHY: Stops layups + threes.\nDO: Tag + recover.\nCONSEQUENCE: Late = 3 or layup.",
    "Keep reps short and fast."
  ),
  mkDrill("d05","Screen Defense: Under + Re-square","Defense",["Screens","Communication"],3,6,
    META(["screening","defense","communication"],["MIXED","GUARD_ONLY","HYBRID_BIG_GUARD"],"med","small"),
    "Call screen early. Defender goes under fast. Re-square in front. No chasing.",
    ["Early call","Under with urgency","Shortcut path","Re-square"],
    "WHY: Don‚Äôt die on screens.\nDO: Under + recover.\nCONSEQUENCE: Chasing = open looks.",
    "Bigs also rep on-ball to develop mobility."
  ),
  mkDrill("p01","Post Seal ‚Üí Finish","Offense",["Post","Finishing"],2,4,
    META(["post","finishing","rebounding"],["BIG_ONLY","MIXED","HYBRID_GUARD_POST"],"med","small"),
    "Work seals, two-foot power finish, quick second jump. Rotate.",
    ["Seal low and wide","Two-foot finish","Chin + kick if doubled"],
    "WHY: Easy buckets.\nDO: Seal early.\nCONSEQUENCE: Late seal = no touch.",
    "Guards learn entry angles; bigs learn seal timing."
  ),
  mkDrill("hb01","Grab & Go (Rebound ‚Üí Push ‚Üí Read)","Hybrid",["Big Guard","Transition"],3,6,
    META(["rebounding","ballhandling","passing","finishing","transition"],["HYBRID_BIG_GUARD","BIG_ONLY","MIXED"],"high","small"),
    "Big rebounds, pushes in transition, must read: finish/kick/trailer.",
    ["Two hands rebound","Eyes up push","No charge","Simple read"],
    "WHY: Multifunctional bigs.\nDO: Rebound and run.\nCONSEQUENCE: Only outlet = limited.",
    "Constraint: big initiates every other rep."
  ),

  // ===== 7‚Äì9 ‚ÄúNo 10 players‚Äù Team Options =====
  mkDrill("x01","4v4 + 1 Advantage (Rotate Extra)","Team",["Advantage","Reads"],7,9,
    META(["spacing","passing","defense","rebounding"],["MIXED"],"high","team"),
    "4v4 with 1 rotating advantage player (offense). Creates game reads without 5v5.",
    ["No standing","Talk matchups","Box out"],
    "WHY: Game-like reps without 10.\nDO: Move + talk.\nCONSEQUENCE: Stand = dead rep.",
    "Rotate advantage player each possession."
  ),
  mkDrill("x02","3v3 + 2 Outlet Runners (Transition)","Team",["Transition","Conditioning"],7,9,
    META(["transition","conditioning","passing","defense"],["MIXED","HYBRID_BIG_GUARD"],"high","team"),
    "3v3 live. Two extra are outlets/runners. On rebound, outlet and sprint lanes.",
    ["Outlet in 2s","Sprint lanes","Talk matchups","No jogging"],
    "WHY: Transition habits.\nDO: Sprint.\nCONSEQUENCE: Walk = layup.",
    "Rotate outlets every rep."
  ),
  mkDrill("x03","4v4 ‚ÄòNo Dribble‚Äô Motion","Offense",["Spacing","Cuts"],7,9,
    META(["spacing","passing","situational"],["MIXED","GUARD_ONLY","BIG_ONLY","HYBRID_BIG_GUARD"],"med","team"),
    "4v4. No dribbles. Must cut, screen away, and pass on time to score.",
    ["No standing","Hard cuts","Legal screens","Talk"],
    "WHY: Movement offense.\nDO: Cut and pass.\nCONSEQUENCE: Stand = turnover.",
    "Only bigs? Use DHO + backcuts."
  ),

  // ===== Press / Zone / Situational (5‚Äì9) =====
  mkDrill("pr01","2-2-1 Trap Timing (3-step rule)","Press",["Trap","Angles"],5,9,
    META(["press","communication","conditioning","defense"],["MIXED","GUARD_ONLY","HYBRID_BIG_GUARD"],"high","team"),
    "Trap must arrive in 3 steps after the ball is forced to sideline. Late = restart rep.",
    ["Sprint to trap","Hands high","Middle safety disciplined","No gambling"],
    "WHY: Press is timing.\nDO: Arrive.\nCONSEQUENCE: Late = layup.",
    "Keep live reps short (4 passes max)."
  ),
  mkDrill("zn01","Zone Shell Concepts (1-3-1 pinch)","Defense",["Zone","Talk"],5,9,
    META(["defense","communication","situational"],["MIXED"],"med","team"),
    "Zone shell: talk on passes, pinch middle, recover corners, rebound out of zone.",
    ["Talk every pass","Pinch middle","Hands active","Rebound"],
    "WHY: Zone fails without talk.\nDO: Communicate.\nCONSEQUENCE: Silence = open corner.",
    "Even if you play man, this teaches spacing/vision."
  ),
  mkDrill("lg01","Late Game: Down 2, 22 sec (No TO)","Situational",["Late Game","Execution"],5,9,
    META(["situational","spacing","freeThrows","transition"],["MIXED","GUARD_ONLY","HYBRID_BIG_GUARD"],"high","team"),
    "Sim down 2, 22 seconds, no timeouts. Must get a great shot and sprint back.",
    ["No hero shots","Sprint back","Talk matchups","Rebound on miss"],
    "WHY: You must execute.\nDO: Great shot.\nCONSEQUENCE: Panic = loss.",
    "Run from different inbound spots."
  ),

  // ===== TRUE 5v5 (10+) =====
  mkDrill("5v5a","5v5 Shell (Full)","Defense",["Shell","Team","5v5"],10,14,
    META(["defense","help","rebounding","communication"],["MIXED"],"high","team"),
    "Full shell: deny one away, help feet in paint, recover on skip, finish with rebound.",
    ["Talk every pass","Deny one away","Feet in paint help","Box out hard"],
    "WHY: This is your defense.\nDO: Deny, help, recover.\nCONSEQUENCE: No talk = buckets.",
    "Add constraints: no middle, under all screens."
  ),
  mkDrill("5v5b","5v5 Transition Matchups","Defense",["Transition","Communication","5v5"],10,14,
    META(["transition","defense","communication","conditioning"],["MIXED"],"high","team"),
    "Change ends. Must sprint back, find ball, match up, talk. Score counts only if defense is set.",
    ["First 3 steps sprint","Find ball then match","Talk matchups","No jogging"],
    "WHY: Transition kills you.\nDO: Sprint + talk.\nCONSEQUENCE: Jog = layup.",
    "Time the sprint-back. Make it measurable."
  ),
];

/* =========================================================
   CATEGORY NORMALIZATION
========================================================= */
function normalizeCat(c){
  const x = (c||"").toLowerCase();
  if (x.includes("def")) return "Defense";
  if (x.includes("reb")) return "Rebounding";
  if (x.includes("press")) return "Press";
  if (x.includes("cond")) return "Conditioning";
  if (x.includes("shoot")) return "Shooting";
  if (x.includes("off")) return "Offense";
  if (x.includes("skill")) return "Skill";
  if (x.includes("situ")) return "Situational";
  if (x.includes("hyb")) return "Hybrid";
  if (x.includes("team")) return "Team";
  return c || "Other";
}

/* =========================================================
   EMPHASIS
========================================================= */
function getEmphasis(){
  const cats = [];
  if (document.getElementById("em_def").checked) cats.push("Defense");
  if (document.getElementById("em_reb").checked) cats.push("Rebounding");
  if (document.getElementById("em_off").checked) cats.push("Offense");
  if (document.getElementById("em_press").checked) cats.push("Press");
  if (document.getElementById("em_cond").checked) cats.push("Conditioning");
  if (document.getElementById("em_shoot").checked) cats.push("Shooting");
  return cats;
}

/* =========================================================
   TODAY OBJECT
========================================================= */
function getToday(){
  return loadJSON(KEY_TODAY, {
    id: uid(),
    date: new Date().toISOString(),
    duration: 90,
    focus: "",
    notes: "",
    presentIds: getPresentIds(),
    drills: []
  });
}
function saveToday(obj){ saveJSON(KEY_TODAY, obj); }

/* =========================================================
   PRACTICE BUILDER (SMART + NO REPEATS + COMPOSITION + GRADES)
========================================================= */
function buildPractice(isRegen){
  if (isRegen) bumpRegenSeed();

  const duration = clampInt(parseInt(document.getElementById("practiceDuration").value || "90",10), 45, 150);
  const focusInput = (document.getElementById("practiceFocus").value || "").trim();
  const notes = (document.getElementById("practiceNotes").value || "").trim();

  const presentPlayers = getPresentPlayers();
  const team = analyzeTeam(presentPlayers);

  const presentCount = team.n;
  const band = getBand(presentCount);
  const [minP,maxP] = bandMinMax(band);

  const emphasis = getEmphasis();
  const emphasisSet = new Set(emphasis.map(normalizeCat));

  const todaySit = getTodaySituation();

  const autoFocus = `${todaySit.label}${emphasis.length ? " ‚Ä¢ " + emphasis.join(", ") : ""}`;
  const focus = focusInput || autoFocus;

  // Seed so regen always changes AND same inputs still produce variety
  const seedBase =
    getRegenSeed() +
    hashStringToInt(
      focus + "|" +
      emphasis.join(",") + "|" +
      presentPlayers.map(p=>p.id).join(",") + "|" +
      getWeekId()
    ) +
    Math.floor(Date.now()/60000);

  const rand = mulberry32(seedBase);

  const weekly = getWeeklyUsed();

  // Weakness signals from grades for present players
  const presentIds = new Set(presentPlayers.map(p=>p.id));
  const grades = getGrades().filter(g => presentIds.has(g.playerId));
  const gradeWeakSkills = {}; // skill -> weight (higher = more needed)
  for (const g of grades){
    const d = DRILLS.find(x => x.id===g.drillId);
    if (!d) continue;
    const deficit = Math.max(0, 3.6 - Number(g.grade||0));
    if (deficit <= 0) continue;
    const w = deficit * 3.0; // strong weight
    (d.meta?.skills||[]).forEach(s => gradeWeakSkills[s] = (gradeWeakSkills[s]||0) + w);
  }

  // Build pool: player count compatibility is a HARD filter
  let pool = DRILLS.filter(d => d.minPlayers <= maxP && d.maxPlayers >= minP);

  // HARD rule: 5v5 drills require 10+
  pool = pool.filter(d => {
    const is5v5 = (d.tags||[]).some(t => String(t).toLowerCase() === "5v5");
    if (is5v5 && presentCount < 10) return false;
    return true;
  });

  // HARD composition filters:
  pool = pool.filter(d=>{
    const roles = d.meta?.roles || ["MIXED"];
    if (team.onlyGuards && roles.includes("BIG_ONLY")) return false;
    if (team.onlyBigs){
      if (roles.includes("GUARD_ONLY") && !roles.includes("HYBRID_BIG_GUARD")) return false;
    }
    return true;
  });

  function scoreDrill(d){
    const cat = normalizeCat(d.category);
    const skills = d.meta?.skills || [];
    const roles  = d.meta?.roles  || ["MIXED"];

    let score = 0;

    // Situation daily rotation boost
    for (const s of skills){
      if (todaySit.skills.includes(s)) score += 2.6;
    }

    // Emphasis boost (soft)
    if (emphasisSet.size){
      if (emphasisSet.has(cat)) score += 3.2;
      if (emphasisSet.has("Defense") && (skills.includes("help") || skills.includes("closeout") || skills.includes("onball"))) score += 1.6;
      if (emphasisSet.has("Rebounding") && skills.includes("rebounding")) score += 1.6;
      if (emphasisSet.has("Conditioning") && skills.includes("conditioning")) score += 1.4;
      if (emphasisSet.has("Shooting") && (skills.includes("shooting") || skills.includes("freeThrows"))) score += 1.4;
      if (emphasisSet.has("Press") && skills.includes("press")) score += 1.8;
    }

    // Focus text boost
    const f = focus.toLowerCase();
    if (f.includes("def") && (cat==="Defense" || skills.includes("defense"))) score += 4.5;
    if (f.includes("reb") && (cat==="Rebounding" || skills.includes("rebounding"))) score += 4.5;
    if (f.includes("press") && (cat==="Press" || skills.includes("press"))) score += 3.6;
    if (f.includes("shoot") && (cat==="Shooting" || skills.includes("shooting"))) score += 3.2;
    if (f.includes("late") && skills.includes("situational")) score += 3.4;
    if (f.includes("trans") && skills.includes("transition")) score += 3.4;

    // Weakness boost (grades): if present players are low on these skills, prioritize
    for (const s of skills){
      score += (gradeWeakSkills[s] || 0) * 0.35;
    }

    // Composition nuance
    if (team.onlyBigs && roles.includes("HYBRID_BIG_GUARD")) score += 3.0;
    if (team.onlyGuards && (skills.includes("onball") || skills.includes("closeout") || skills.includes("ballhandling") || skills.includes("passing"))) score += 1.3;

    // Weekly no-repeat penalties (harder than old version)
    if (weekly.usedIds.has(d.id)) score -= 8.0;
    if (weekly.usedCats.has(cat)) score -= 1.4;

    let tagHits = 0; (d.tags||[]).forEach(t => { if (weekly.usedTags.has(String(t))) tagHits++; });
    score -= tagHits * 0.35;

    let skillHits = 0; skills.forEach(s => { if (weekly.usedSkills.has(String(s))) skillHits++; });
    score -= skillHits * 0.45;

    // Add randomness so regenerate feels different
    score += (rand() - 0.5) * 2.4;

    return score;
  }

  // Score and pick
  const scored = pool.map(d => ({ d, s: scoreDrill(d) })).sort((a,b)=>b.s - a.s);

  // Desired count by duration
  const desiredCount = duration <= 70 ? 6 : duration <= 95 ? 7 : 8;

  // Category balance caps
  const selected = [];
  const picked = new Set();
  const catCount = {};
  const capPerCat = Math.max(2, Math.ceil(desiredCount/3)); // prevents 7 straight defense drills

  for (const item of scored){
    if (selected.length >= desiredCount) break;
    const d = item.d;
    if (picked.has(d.id)) continue;

    const cat = normalizeCat(d.category);
    if ((catCount[cat]||0) >= capPerCat) continue;

    selected.push(d);
    picked.add(d.id);
    catCount[cat] = (catCount[cat]||0) + 1;
  }
  // Fill
  for (const item of scored){
    if (selected.length >= desiredCount) break;
    if (picked.has(item.d.id)) continue;
    selected.push(item.d);
    picked.add(item.d.id);
  }

  // Time blocks
  const plan = toTimedPlan(selected, duration);

  const todayObj = {
    id: uid(),
    date: new Date().toISOString(),
    duration,
    focus,
    notes,
    presentIds: getPresentIds(),
    drills: plan
  };
  saveToday(todayObj);

  // Mark weekly used with selected drills (IDs + tags + skills)
  markWeeklyUsed(selected);

  renderAll();
}

function toTimedPlan(drills, duration){
  const blocks = [];
  const n = drills.length;

  // Minutes template (keeps things consistent and no-scroll friendly)
  const warm = duration<=70 ? 8 : 10;
  const cond = duration<=70 ? 6 : 10;
  const ft = 6;
  const remaining = Math.max(duration - warm - cond - ft, 24);

  const coreCount = Math.max(n-2, 4);
  const coreEach = Math.floor(remaining / coreCount);
  const extra = remaining - (coreEach*coreCount);

  for (let i=0;i<n;i++){
    const mins = (i===0) ? warm :
                 (i===n-1) ? ft :
                 (i===n-2) ? cond :
                 coreEach + (i<=extra ? 1 : 0);

    const d = drills[i];
    blocks.push({
      id: d.id,
      title: d.title,
      category: normalizeCat(d.category),
      tags: d.tags,
      mins,
      explain: d.explain,
      standards: d.standards,
      coachShort: d.coachShort,
      coachLong: d.coachLong,
      minPlayers: d.minPlayers,
      maxPlayers: d.maxPlayers,
      meta: d.meta
    });
  }
  // Fix drift
  const total = blocks.reduce((s,b)=>s+b.mins,0);
  const diff = duration - total;
  if (diff !== 0 && blocks.length) blocks[blocks.length-1].mins += diff;
  return blocks;
}

/* =========================================================
   LOG PRACTICE COMPLETE (simple marker)
========================================================= */
function logPracticeComplete(){
  const today = getToday();
  if (!today.drills?.length){
    alert("Build a practice first.");
    return;
  }
  alert("Practice logged ‚úÖ\n(Grades + plan saved automatically.)");
  go("dashboard");
}

/* =========================================================
   UI: Navigation
========================================================= */
function go(view){
  const views = ["dashboard","roster","practice","grades"];
  views.forEach(v=>{
    document.getElementById(`view-${v}`).classList.toggle("hidden", v!==view);
    const nav = document.getElementById(`nav-${v}`);
    if (nav){
      nav.classList.toggle("btnPrimary", v===view);
    }
  });
  const titleMap = {
    dashboard:"Dashboard",
    roster:"Roster",
    practice:"Practice Builder",
    grades:"Grades & Progress"
  };
  document.getElementById("viewTitle").textContent = titleMap[view] || "View";
  renderAll();
}

/* =========================================================
   UI: Renders
========================================================= */
function renderAll(){
  renderDashboard();
  renderRoster();
  renderPractice();
  renderGrades();
}

function renderDashboard(){
  const present = getPresentIds().length;
  document.getElementById("dashPresent").textContent = String(present);
  document.getElementById("dashBand").textContent = `Band: ${getBand(present)}`;

  const sit = getTodaySituation();
  document.getElementById("dashSituation").textContent = sit.label;

  const need = computeBiggestNeedForPresent();
  document.getElementById("dashNeed").textContent = need;

  const weekly = getWeeklyUsed();
  document.getElementById("dashVariety").textContent =
    `${weekly.usedIds.size} drills ‚Ä¢ ${weekly.usedCats.size} cats ‚Ä¢ ${weekly.usedSkills.size} skills`;

  const today = getToday();
  const hasPlan = (today.drills||[]).length > 0;

  document.getElementById("dashPlanTitle").textContent = hasPlan ? (today.focus || "Today Plan") : "No plan yet";
  document.getElementById("dashPlanMeta").textContent =
    hasPlan
      ? `Present: ${(today.presentIds||[]).length} ‚Ä¢ Duration: ${today.duration} ‚Ä¢ Note: ${today.notes || "‚Äî"}`
      : "Tap Build to create one.";

  const list = document.getElementById("dashPlanList");
  list.innerHTML = "";
  if (!hasPlan){
    list.innerHTML = `<div class="text-sm muted2">No drills yet.</div>`;
    return;
  }
  today.drills.slice(0,10).forEach((d, i)=>{
    const row = document.createElement("div");
    row.className = "chip rounded-2xl p-3 flex items-center justify-between gap-2";
    row.innerHTML = `
      <div class="min-w-0">
        <div class="font-extrabold truncate">${i+1}. ${escapeHtml(d.title)}</div>
        <div class="text-xs muted2 truncate">${escapeHtml(d.category)} ‚Ä¢ ${d.mins} min</div>
      </div>
      <button class="btn tapSm" title="Open">‚Üí</button>
    `;
    row.querySelector("button").onclick = ()=>{ go("practice"); };
    list.appendChild(row);
  });
}

function renderRoster(){
  const roster = getRoster();
  const presentSet = new Set(getPresentIds());
  const presentPlayers = getPresentPlayers();
  const team = analyzeTeam(presentPlayers);

  document.getElementById("rosterPresentCount").textContent = String(presentSet.size);
  document.getElementById("rosterBand").textContent = getBand(presentSet.size);

  const comp = `Guards: ${team.counts.GUARD} ‚Ä¢ Wings: ${team.counts.WING} ‚Ä¢ Bigs: ${team.counts.BIG}
Avg H/W: ${team.avgH ? team.avgH.toFixed(1) : "‚Äî"} in ‚Ä¢ ${team.avgW ? team.avgW.toFixed(0) : "‚Äî"} lb`;
  document.getElementById("rosterComposition").textContent = comp;

  const wrap = document.getElementById("rosterList");
  wrap.innerHTML = "";
  if (!roster.length){
    wrap.innerHTML = `<div class="text-sm muted2">No players yet. Tap ‚Äú+ Add Player‚Äù.</div>`;
    return;
  }

  roster.forEach(p=>{
    const isHere = presentSet.has(p.id);
    const hTxt = p.height ? formatHeight(p.height) : "‚Äî";
    const wTxt = p.weight ? `${p.weight} lb` : "‚Äî";
    const type = classifyPlayer(p);
    const badge = type==="BIG" ? "badgePurple" : type==="GUARD" ? "badgeCyan" : "badgeGreen";

    const row = document.createElement("div");
    row.className = "chip rounded-3xl p-4 flex items-center justify-between gap-3";
    row.innerHTML = `
      <div class="min-w-0">
        <div class="flex flex-wrap items-center gap-2">
          <div class="text-lg font-extrabold truncate">${escapeHtml(p.name)}</div>
          <span class="px-2 py-1 rounded-full text-xs font-extrabold ${badge}"> ${type} </span>
          <span class="px-2 py-1 rounded-full text-xs font-extrabold badgeAmber mono">#${escapeHtml(p.number||"--")}</span>
        </div>
        <div class="text-sm muted2 mt-1">
          Pos: <span class="font-extrabold text-slate-50">${escapeHtml(p.pos||"‚Äî")}</span> ‚Ä¢
          H/W: <span class="font-extrabold text-slate-50">${hTxt}</span> / <span class="font-extrabold text-slate-50">${wTxt}</span>
        </div>
        <div class="text-sm muted2 mt-1 truncate">${escapeHtml(p.notes||"")}</div>
      </div>

      <div class="flex flex-col gap-2">
        <button class="btn tapSm ${isHere ? "btnPrimary" : ""}">${isHere ? "Present ‚úÖ" : "Mark Present"}</button>
        <button class="btn tapSm">Edit</button>
      </div>
    `;
    const [btnPresent, btnEdit] = row.querySelectorAll("button");
    btnPresent.onclick = ()=>togglePresent(p.id);
    btnEdit.onclick = ()=>openPlayerModal(p.id);
    wrap.appendChild(row);
  });
}

function renderPractice(){
  const today = getToday();

  // top meta
  const presentCount = getPresentIds().length;
  const band = getBand(presentCount);
  document.getElementById("practiceMetaTop").textContent =
    `Present: ${presentCount} (Band ${band}) ‚Ä¢ Situation: ${getTodaySituation().label}`;

  // sync inputs
  document.getElementById("practiceDuration").value = today.duration ?? 90;
  document.getElementById("practiceFocus").value = today.focus ?? "";
  document.getElementById("practiceNotes").value = today.notes ?? "";

  // pills
  const roster = getRoster();
  const present = new Set(getPresentIds());
  const pills = document.getElementById("presentPills");
  pills.innerHTML = "";
  if (!roster.length){
    pills.innerHTML = `<div class="text-sm muted2">Add players in Roster first.</div>`;
  } else {
    roster.forEach(p=>{
      const isHere = present.has(p.id);
      const b = document.createElement("button");
      b.className = `btn tapSm ${isHere ? "btnPrimary" : ""}`;
      b.textContent = isHere ? `${p.name} ‚úÖ` : p.name;
      b.onclick = ()=>togglePresent(p.id);
      pills.appendChild(b);
    });
  }
  document.getElementById("bandLabel").textContent = band;

  // plan meta
  const focus = (today.focus||"").trim() || `${getTodaySituation().label}`;
  document.getElementById("planMeta").textContent =
    `Focus: ${focus} ‚Ä¢ Duration: ${today.duration} ‚Ä¢ Drills: ${(today.drills||[]).length}`;

  // plan list
  const wrap = document.getElementById("practicePlan");
  wrap.innerHTML = "";
  if (!(today.drills||[]).length){
    wrap.innerHTML = `<div class="text-sm muted2">No plan yet. Tap Build.</div>`;
    return;
  }

  today.drills.forEach((d, idx)=>{
    const is5v5 = (d.tags||[]).some(t => String(t).toLowerCase()==="5v5");
    const badge = is5v5 ? "badgeRed" : d.category==="Defense" ? "badgeCyan" :
                 d.category==="Rebounding" ? "badgeGreen" : d.category==="Press" ? "badgePurple" : "badgeAmber";

    const row = document.createElement("div");
    row.className = "chip rounded-3xl p-4";
    row.innerHTML = `
      <div class="flex flex-col lg:flex-row lg:items-start lg:justify-between gap-3">
        <div class="min-w-0">
          <div class="flex flex-wrap items-center gap-2">
            <div class="text-lg font-extrabold">${idx+1}. ${escapeHtml(d.title)}</div>
            <span class="px-2 py-1 rounded-full text-xs font-extrabold ${badge}">${escapeHtml(d.category)}</span>
            <span class="px-2 py-1 rounded-full text-xs font-extrabold badgeAmber">${d.mins} min</span>
            <span class="px-2 py-1 rounded-full text-xs font-extrabold chip">${d.minPlayers}‚Äì${d.maxPlayers} players</span>
          </div>
          <div class="text-sm muted2 mt-2">${escapeHtml(d.explain)}</div>
          <div class="text-xs muted2 mt-2">Tags: ${escapeHtml((d.tags||[]).join(", "))}</div>
        </div>

        <div class="flex flex-wrap gap-2">
          <button class="btn tapSm btnPrimary">Explain</button>
          <button class="btn tapSm" title="Go grade this drill">Grade</button>
        </div>
      </div>
    `;
    const [btnExplain, btnGrade] = row.querySelectorAll("button");
    btnExplain.onclick = ()=>openDrillModal(d.id);
    btnGrade.onclick = ()=>{ go("grades"); scrollToDrillGrades(d.id); };
    wrap.appendChild(row);
  });
}

function renderGrades(){
  const today = getToday();
  const board = document.getElementById("gradeBoard");
  board.innerHTML = "";

  const drills = today.drills || [];
  const presentPlayers = getPresentPlayers();

  if (!drills.length){
    board.innerHTML = `<div class="text-sm muted2">No plan yet. Build a practice first.</div>`;
    document.getElementById("insightsBox").textContent = "Build a plan and start grading.";
    return;
  }
  if (!presentPlayers.length){
    board.innerHTML = `<div class="text-sm muted2">No present players. Set Present in Roster.</div>`;
    document.getElementById("insightsBox").textContent = "Set Present players to grade them.";
    return;
  }

  // insights
  document.getElementById("insightsBox").textContent = buildInsightsText(today.id, drills, presentPlayers);

  // Grade cards
  drills.forEach(d=>{
    const card = document.createElement("div");
    card.className = "chip rounded-3xl p-4";
    card.id = `grade-${d.id}`;
    card.innerHTML = `
      <div class="flex items-start justify-between gap-2">
        <div class="min-w-0">
          <div class="text-lg font-extrabold truncate">${escapeHtml(d.title)}</div>
          <div class="text-sm muted2 mt-1">${escapeHtml(d.category)} ‚Ä¢ ${d.mins} min</div>
        </div>
        <button class="btn tapSm" onclick="openDrillModal('${d.id}')">Explain</button>
      </div>
      <div class="border-t divider my-3"></div>
      <div class="space-y-2" id="gradeRows-${d.id}"></div>
    `;

    board.appendChild(card);

    const rows = card.querySelector(`#gradeRows-${d.id}`);
    rows.innerHTML = "";

    presentPlayers.forEach(p=>{
      const current = getGrade(today.id, d.id, p.id);
      const row = document.createElement("div");
      row.className = "flex items-center justify-between gap-2 chip rounded-2xl p-3";
      row.innerHTML = `
        <div class="min-w-0">
          <div class="font-extrabold truncate">${escapeHtml(p.name)} <span class="muted2 mono text-xs">#${escapeHtml(p.number||"--")}</span></div>
          <div class="text-xs muted2">Pos ${escapeHtml(p.pos||"‚Äî")} ‚Ä¢ ${p.height ? formatHeight(p.height) : "‚Äî"} ‚Ä¢ ${p.weight ? p.weight+" lb" : "‚Äî"}</div>
        </div>
        <div class="flex gap-2">
          ${[1,2,3,4,5].map(n=>{
            const active = (current===n);
            const cls = active ? "btnPrimary" : "";
            return `<button class="btn tapSm ${cls}" data-g="${n}">${n}</button>`;
          }).join("")}
        </div>
      `;
      row.querySelectorAll("button[data-g]").forEach(b=>{
        b.onclick = ()=>{
          const g = Number(b.getAttribute("data-g"));
          setGrade(today.id, d.id, p.id, g);
          renderGrades();
        };
      });
      rows.appendChild(row);
    });
  });
}

function getGrade(practiceId, drillId, playerId){
  const list = getGrades();
  const g = list.find(x => x.practiceId===practiceId && x.drillId===drillId && x.playerId===playerId);
  return g ? Number(g.grade||0) : 0;
}

/* =========================================================
   INSIGHTS (biggest need for present players)
========================================================= */
function computeBiggestNeedForPresent(){
  const presentPlayers = getPresentPlayers();
  if (!presentPlayers.length) return "‚Äî";

  const presentIds = presentPlayers.map(p=>p.id);
  const grades = getGrades().filter(g => presentIds.includes(g.playerId));

  if (!grades.length) return "Grade-based needs will appear after you grade.";

  const skillTotals = {};
  for (const g of grades){
    const d = DRILLS.find(x=>x.id===g.drillId);
    if (!d) continue;
    const deficit = Math.max(0, 3.6 - Number(g.grade||0));
    if (deficit<=0) continue;
    const w = deficit * 2.2;
    (d.meta?.skills||[]).forEach(s => skillTotals[s] = (skillTotals[s]||0) + w);
  }
  const top = Object.entries(skillTotals).sort((a,b)=>b[1]-a[1])[0];
  if (!top) return "‚Äî";
  const map = {
    defense:"Defense",
    closeout:"Closeouts",
    help:"Help Defense",
    rebounding:"Rebounding",
    ballhandling:"Ball Security",
    passing:"Passing",
    shooting:"Shooting",
    freeThrows:"Free Throws",
    transition:"Transition",
    screening:"Screen Defense",
    situational:"Late Game"
  };
  return map[top[0]] || top[0];
}

function buildInsightsText(practiceId, drills, presentPlayers){
  // simple: show 1‚Äì2 lowest average players this week and their top weakness
  const weekId = getWeekId();
  const grades = getGrades().filter(g => g.weekId===weekId);

  const byPlayer = {};
  for (const p of presentPlayers){
    const pg = grades.filter(x=>x.playerId===p.id);
    const avg = pg.length ? (pg.reduce((s,x)=>s+Number(x.grade||0),0)/pg.length) : null;
    const { skillScore } = getAvgGradeForPlayerSkills(p.id);
    const topWeak = Object.entries(skillScore).sort((a,b)=>b[1]-a[1])[0]?.[0] || "‚Äî";
    byPlayer[p.id] = { name: p.name, avg, topWeak };
  }

  const arr = Object.values(byPlayer).filter(x=>x.avg!==null).sort((a,b)=>a.avg-b.avg);
  const worst = arr.slice(0,2);

  const need = computeBiggestNeedForPresent();
  const sit = getTodaySituation().label;

  let text = `Today: ${sit}\nBiggest Need: ${need}\n`;
  if (!worst.length){
    text += `\nNo grades yet this week.\nStart grading 1‚Äì5 to drive smart plans.`;
    return text;
  }
  text += `\nLowest grades this week:\n`;
  worst.forEach(w=>{
    text += `‚Ä¢ ${w.name}: avg ${w.avg.toFixed(2)} ‚Ä¢ weakness: ${w.topWeak}\n`;
  });
  return text.trim();
}

function recomputeInsights(){
  renderGrades();
  alert("Insights refreshed ‚úÖ");
}

/* =========================================================
   DRILL MODAL
========================================================= */
function openDrillModal(drillId){
  const today = getToday();
  const d = (today.drills||[]).find(x=>x.id===drillId) || DRILLS.find(x=>x.id===drillId);
  if (!d) return;

  document.getElementById("dmTitle").textContent = d.title;
  document.getElementById("dmMeta").textContent =
    `${normalizeCat(d.category)} ‚Ä¢ ${d.minPlayers}‚Äì${d.maxPlayers} players ‚Ä¢ ${(d.tags||[]).join(", ")}`;

  document.getElementById("dmExplain").textContent = d.explain || "";
  document.getElementById("dmShort").textContent = d.coachShort || "";
  document.getElementById("dmLong").textContent = d.coachLong || "";

  const ul = document.getElementById("dmStandards");
  ul.innerHTML = "";
  (d.standards||[]).forEach(s=>{
    const li = document.createElement("li");
    li.textContent = s;
    ul.appendChild(li);
  });

  document.getElementById("drillModal").classList.remove("hidden");
}
function closeDrillModal(){ document.getElementById("drillModal").classList.add("hidden"); }

/* =========================================================
   PLAYER MODAL
========================================================= */
let editingPlayerId = null;

function openPlayerModal(pid=null){
  const roster = getRoster();
  editingPlayerId = pid;

  const pmMode = document.getElementById("pmMode");
  const pmTitle = document.getElementById("pmTitle");
  const delBtn = document.getElementById("pmDeleteBtn");

  if (!pid){
    pmMode.textContent = "Add Player";
    pmTitle.textContent = "Player";
    delBtn.classList.add("hidden");
    setPMFields({ name:"", number:"", pos:"G", height:"", weight:"", notes:"" });
  } else {
    const p = roster.find(x=>x.id===pid);
    if (!p) return;
    pmMode.textContent = "Edit Player";
    pmTitle.textContent = p.name || "Player";
    delBtn.classList.remove("hidden");
    setPMFields(p);
  }

  document.getElementById("playerModal").classList.remove("hidden");
}
function closePlayerModal(){ document.getElementById("playerModal").classList.add("hidden"); }

function setPMFields(p){
  document.getElementById("pmName").value = p.name || "";
  document.getElementById("pmNumber").value = p.number || "";
  document.getElementById("pmPos").value = p.pos || "G";
  document.getElementById("pmHeight").value = p.height ? formatHeight(p.height) : "";
  document.getElementById("pmWeight").value = p.weight || "";
  document.getElementById("pmNotes").value = p.notes || "";
}

function savePlayer(){
  const name = (document.getElementById("pmName").value||"").trim();
  if (!name){ alert("Name required."); return; }

  const number = (document.getElementById("pmNumber").value||"").trim();
  const pos = document.getElementById("pmPos").value;
  const heightIn = parseHeightToInches(document.getElementById("pmHeight").value);
  const weight = (document.getElementById("pmWeight").value||"").trim();
  const weightLb = weight ? clampInt(parseInt(weight,10), 80, 350) : null;
  const notes = (document.getElementById("pmNotes").value||"").trim();

  const roster = getRoster();

  if (editingPlayerId){
    const idx = roster.findIndex(p=>p.id===editingPlayerId);
    if (idx>=0){
      roster[idx] = {
        ...roster[idx],
        name, number, pos,
        height: heightIn ?? roster[idx].height ?? null,
        weight: weightLb ?? roster[idx].weight ?? null,
        notes
      };
    }
  } else {
    roster.push({
      id: uid(),
      name, number, pos,
      height: heightIn ?? null,
      weight: weightLb ?? null,
      notes
    });
  }

  saveRoster(roster);
  closePlayerModal();
  renderAll();
}

function deletePlayer(){
  if (!editingPlayerId) return;
  if (!confirm("Delete this player?")) return;

  const roster = getRoster().filter(p=>p.id!==editingPlayerId);
  saveRoster(roster);

  const present = new Set(getPresentIds());
  present.delete(editingPlayerId);
  savePresentIds(Array.from(present));

  // remove grades for player (optional cleanup)
  const grades = getGrades().filter(g=>g.playerId!==editingPlayerId);
  saveGrades(grades);

  editingPlayerId = null;
  closePlayerModal();
  renderAll();
}

/* =========================================================
   MISC ACTIONS
========================================================= */
function setDuration(n){
  document.getElementById("practiceDuration").value = String(n);
}
function openQuickBuild(){
  go("practice");
  buildPractice(false);
}
function clearRoster(){
  if (!confirm("Clear roster and present list?")) return;
  localStorage.removeItem(KEY_ROSTER);
  localStorage.removeItem(KEY_PRESENT);
  renderAll();
}
function clearPresent(){
  if (!confirm("Clear present players?")) return;
  localStorage.removeItem(KEY_PRESENT);
  const t = getToday();
  t.presentIds = [];
  saveToday(t);
  renderAll();
}
function clearGrades(){
  if (!confirm("Clear ALL grades? (This affects weaknesses)")) return;
  localStorage.removeItem(KEY_GRADES);
  renderAll();
}
function hardReset(){
  if (!confirm("Hard reset EVERYTHING (roster, present, today, grades, weekly no-repeat)?")) return;
  [KEY_ROSTER,KEY_PRESENT,KEY_TODAY,KEY_GRADES,KEY_WEEKLY_USED,KEY_REGEN_SEED].forEach(k=>localStorage.removeItem(k));
  boot();
  alert("Reset complete.");
}
function exportData(){
  const data = {
    roster: getRoster(),
    present: getPresentIds(),
    today: getToday(),
    grades: getGrades(),
    weeklyUsed: loadJSON(KEY_WEEKLY_USED, {}),
    regenSeed: getRegenSeed()
  };
  const blob = new Blob([JSON.stringify(data,null,2)], {type:"application/json"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = `pcc-export-${Date.now()}.json`;
  a.click();
  URL.revokeObjectURL(url);
}

/* =========================================================
   HELPERS: formatting + grade jump
========================================================= */
function formatHeight(inches){
  const ft = Math.floor(inches/12);
  const inch = inches % 12;
  return `${ft}'${inch}`;
}
function scrollToDrillGrades(drillId){
  // small delay so view renders
  setTimeout(()=>{
    const el = document.getElementById(`grade-${drillId}`);
    if (el) el.scrollIntoView({ behavior: "smooth", block: "start" });
  }, 50);
}

/* =========================================================
   BOOT
========================================================= */
function boot(){
  // Ensure TODAY exists
  const today = getToday();
  today.presentIds = getPresentIds();
  saveToday(today);

  // Default nav
  go("dashboard");
  renderAll();
}
boot();
</script>
</body>
</html>
